<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة المتجر الإلكتروني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- المكتبات الأخرى -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* متغيرات الألوان للنظام التجاري */
        :root { 
            --primary-color: #d131bc; 
            --secondary-color: #631a5f; 
            --success-color: #4cc9f0; 
            --warning-color: #87ad2f; 
            --danger-color: #f72585; 
            --info-color: #7209b7; 
            --product-color: #38b000; 
            --customer-color: #ff9e00; 
            --order-color: #560bad; 
            --shipping-color: #0077b6; 
            
            --header-bg: #3a0ca3;
            --sidebar-bg: #4361ee;
            --panel-bg: #ffffff;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.1);
            --shadow-heavy: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background-color: #f5f7fa; 
            direction: rtl; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* شاشة الدخول */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3a0ca3 0%, #4361ee 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-heavy);
            width: 90%;
            max-width: 400px;
            text-align: center;
            margin: 20px;
        }
        
        .login-logo {
            font-size: 2.5rem;
            color: var(--header-bg);
            margin-bottom: 15px;
        }
        
        .login-title {
            color: var(--header-bg);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }
        
        .login-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background-color: white;
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2d00a3 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .login-error {
            color: var(--danger-color);
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* روابط إضافية */
        .login-links {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .login-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-link:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }
        
        /* المحتوى الرئيسي */
        #main-content {
            display: none;
        }
        
        /* الشريط العلوي */
        .top-bar {
            background: linear-gradient(135deg, var(--header-bg) 0%, #2d00a3 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #c2185b;
            transform: translateY(-2px);
        }
        
        /* الشريط الجانبي */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, var(--sidebar-bg) 0%, var(--header-bg) 100%);
            color: white;
            height: calc(100vh - 70px);
            position: fixed;
            top: 70px;
            right: 0;
            transition: right 0.3s;
            overflow-y: auto;
            box-shadow: var(--shadow-medium);
            z-index: 999;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            border-right-color: var(--primary-color);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            color: #b8c1ec;
            font-size: 16px;
        }
        
        /* المحتوى الرئيسي */
        .main-content-area {
            margin-right: 250px;
            padding: 20px;
            transition: margin-right 0.3s;
            min-height: calc(100vh - 70px);
            width: calc(100% - 250px);
        }
        
        /* بطاقات الإحصائيات */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border-top: 4px solid var(--primary-color);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: var(--shadow-light);
        }
        
        .stat-icon.orders { background: var(--order-color); }
        .stat-icon.products { background: var(--product-color); }
        .stat-icon.customers { background: var(--customer-color); }
        .stat-icon.revenue { background: var(--success-color); }
        .stat-icon.pending { background: var(--warning-color); }
        .stat-icon.categories { background: var(--info-color); }
        
        .stat-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--header-bg);
        }
        
        .stat-info p {
            color: #4361ee;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* لوحة التحكم */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .panel-header h2 {
            color: var(--header-bg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 13px;
            box-shadow: var(--shadow-light);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, var(--success-color) 0%, #0096c7 100%);
            color: white; 
        }
        .btn-danger { 
            background: linear-gradient(135deg, var(--danger-color) 0%, #c2185b 100%);
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, var(--warning-color) 0%, #e85d04 100%);
            color: white; 
        }
        .btn-info { 
            background: linear-gradient(135deg, var(--info-color) 0%, #560bad 100%);
            color: white; 
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        /* الجداول */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: var(--light-bg);
            padding: 15px 10px;
            text-align: right;
            color: var(--header-bg);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 14px;
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--light-bg);
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: #f8fafc;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9fbfd;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-badge.pending {
            background: #FFF3E0;
            color: var(--warning-color);
            border: 1px solid #FFE0B2;
        }
        
        .status-badge.processing {
            background: #E0F7FA;
            color: var(--info-color);
            border: 1px solid #B2EBF2;
        }
        
        .status-badge.completed {
            background: #E8F5E9;
            color: var(--product-color);
            border: 1px solid #C8E6C9;
        }
        
        .status-badge.cancelled {
            background: #FFEBEE;
            color: var(--danger-color);
            border: 1px solid #FFCDD2;
        }
        
        .status-badge.shipped {
            background: #E8EAF6;
            color: var(--primary-color);
            border: 1px solid #C5CAE9;
        }
        
        .stock-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .stock-badge.in-stock {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .stock-badge.low-stock {
            background: #FFF3E0;
            color: #EF6C00;
        }
        
        .stock-badge.out-of-stock {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .price-tag {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .table-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: var(--shadow-light);
            font-size: 14px;
        }
        
        .action-btn.edit { 
            background: linear-gradient(135deg, var(--warning-color) 0%, #ffb74d 100%);
            color: white; 
        }
        .action-btn.delete { 
            background: linear-gradient(135deg, var(--danger-color) 0%, #ef5350 100%);
            color: white; 
        }
        .action-btn.view { 
            background: linear-gradient(135deg, var(--info-color) 0%, #4dd0e1 100%);
            color: white; 
        }
        .action-btn.stock { 
            background: linear-gradient(135deg, var(--product-color) 0%, #66BB6A 100%);
            color: white; 
        }
        
        .action-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: var(--shadow-medium);
        }
        
        /* النماذج */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 12000;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        
        .form-modal.active {
            display: flex;
        }
        
        .form-container {
            background: white;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            animation: formSlideIn 0.3s ease;
        }
        
        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-header {
            background: linear-gradient(135deg, var(--header-bg) 0%, #2d00a3 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .close-form {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-form:hover {
            background: rgba(255,255,255,0.1);
            transform: rotate(90deg);
        }
        
        .form-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--header-bg);
            font-size: 14px;
        }
        
        .form-label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f8fafc;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background-color: white;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--light-bg);
            flex-wrap: wrap;
        }
        
        /* رسائل التنبيه */
        .alert {
            padding: 15px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            display: none;
            animation: slideDown 0.5s ease;
            border-right: 5px solid transparent;
            font-size: 14px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert.success {
            background: #E8F5E9;
            color: #1b5e20;
            border-color: #C8E6C9;
            border-right-color: #4caf50;
        }
        
        .alert.error {
            background: #FFEBEE;
            color: #c62828;
            border-color: #FFCDD2;
            border-right-color: #f44336;
        }
        
        .alert.warning {
            background: #FFF3E0;
            color: #ef6c00;
            border-color: #FFE0B2;
            border-right-color: #ff9800;
        }
        
        .alert.info {
            background: #E0F7FA;
            color: #006064;
            border-color: #B2EBF2;
            border-right-color: #00bcd4;
        }
        
        /* نظام البحث المتقدم */
        .advanced-search {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .search-results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* بطاقات المنتجات */
        .product-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s;
            border-left: 5px solid var(--product-color);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        
        .product-card.low-stock {
            border-left-color: var(--warning-color);
        }
        
        .product-card.out-of-stock {
            border-left-color: var(--danger-color);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .product-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--header-bg);
            margin-bottom: 5px;
        }
        
        .product-code {
            font-size: 12px;
            color: #666;
            background: #f5f5f5;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .product-image {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .product-details {
            margin-top: 15px;
            flex-grow: 1;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .detail-label {
            color: #666;
        }
        
        .detail-value {
            color: #333;
            font-weight: 500;
        }
        
        /* لوحة الإحصائيات والرسوم البيانية */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .chart-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        /* تتبع المخزون */
        .stock-tracker {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stock-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }
        
        .stock-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .stock-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .stock-info {
            flex: 1;
        }
        
        .stock-progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            transition: width 0.3s;
        }
        
        .progress-bar.high { background: var(--product-color); }
        .progress-bar.medium { background: var(--warning-color); }
        .progress-bar.low { background: var(--danger-color); }
        
        /* تنبيهات المخزون */
        .alerts-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            margin-top: 20px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        
        .alert-item:hover {
            background: #f8fafc;
        }
        
        .alert-item:last-child {
            border-bottom: none;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        
        .alert-icon.warning { background: var(--warning-color); }
        .alert-icon.danger { background: var(--danger-color); }
        .alert-icon.info { background: var(--info-color); }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .alert-message {
            color: #666;
            font-size: 14px;
        }
        
        /* زر العودة السريع */
        .quick-back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--border-color);
            color: var(--header-bg);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s;
            box-shadow: var(--shadow-light);
        }
        
        .quick-back-btn:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: var(--shadow-medium);
        }
        
        /* زر القائمة للجوال */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary-color);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            box-shadow: var(--shadow-medium);
            border: none;
            font-size: 20px;
        }
        
        /* تصدير التقارير */
        .export-options {
            position: relative;
            display: inline-block;
        }
        
        .export-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-heavy);
            min-width: 180px;
            z-index: 12000;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .export-menu.show {
            opacity: 1;
            visibility: visible;
            top: 100%;
        }
        
        .export-option {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid var(--light-bg);
            color: #2d00a3;
            text-decoration: none;
            font-size: 13px;
            min-height: 40px;
        }
        
        .export-option:hover {
            background: var(--light-bg);
            color: var(--primary-color);
        }
        
        .export-option:last-child {
            border-bottom: none;
        }
        
        .export-option i {
            width: 18px;
            text-align: center;
            color: var(--secondary-color);
            font-size: 15px;
        }
        
        /* شاشة تحميل */
        .export-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            font-size: 1rem;
            text-align: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .export-loading.active {
            display: flex;
        }
        
        .export-loading i {
            font-size: 2.5rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* شاشة تحميل عامة */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            font-size: 1rem;
            text-align: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-overlay i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            color: var(--primary-color);
        }
        
        /* وسائط متعددة للشاشات الصغيرة */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(100%);
                width: 280px;
                right: -280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
                right: 0;
            }
            
            .main-content-area {
                margin-right: 0;
                width: 100%;
                padding: 15px;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .product-cards {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 6px;
            }
            
            .login-links {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
        }
        
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .top-bar {
                padding: 12px 15px;
            }
            
            .logo h1 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <i class="fas fa-spinner"></i>
        <div id="loadingText">جاري التحميل...</div>
    </div>

    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-shopping-cart"></i>
            </div>
            
            <h2 class="login-title">نظام إدارة المتجر الإلكتروني</h2>
            <p>الرجاء تسجيل الدخول باستخدام البريد الإلكتروني</p>
            
            <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="username" class="login-input" placeholder="البريد الإلكتروني" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="login-input" placeholder="كلمة المرور" required>
                </div>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage">البريد الإلكتروني أو كلمة المرور غير صحيحة</span>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> <span>دخول</span>
                </button>
            </form>
            
            <div class="login-links">
                <a href="javascript:void(0);" class="login-link" onclick="showSignupForm()">
                    <i class="fas fa-user-plus"></i> إنشاء حساب جديد
                </a>
                <a href="javascript:void(0);" class="login-link" onclick="handlePasswordReset()">
                    <i class="fas fa-key"></i> نسيت كلمة المرور؟
                </a>
            </div>
            
            <div style="margin-top: 20px; color: #4361ee; font-size: 14px;">
                <p><i class="fas fa-cloud"></i>نظام إدارة متجر إلكتروني </p>
                <p>تصميم وبرمجة : محمد عمر محمد</p>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <div class="logo">
                <i class="fas fa-store" style="font-size: 24px;"></i>
                <h1>نظام إدارة المتجر الإلكتروني</h1>
            </div>
            
            <div class="user-info">
                <span>مرحباً،</span> <span id="loggedInUser">مستخدم</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> <span>تسجيل الخروج</span>
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" onclick="showDashboard()">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </li>
                <li class="menu-item" onclick="showProducts()">
                    <i class="fas fa-box"></i>
                    <span>إدارة المنتجات</span>
                </li>
                <li class="menu-item" onclick="showCategories()">
                    <i class="fas fa-tags"></i>
                    <span>التصنيفات</span>
                </li>
                <li class="menu-item" onclick="showOrders()">
                    <i class="fas fa-shopping-cart"></i>
                    <span>الطلبات</span>
                </li>
                <li class="menu-item" onclick="showCustomers()">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </li>
                <li class="menu-item" onclick="showInventory()">
                    <i class="fas fa-warehouse"></i>
                    <span>المخزون</span>
                </li>
                <li class="menu-item" onclick="showAdvancedSearch()">
                    <i class="fas fa-search"></i>
                    <span>البحث المتقدم</span>
                </li>
                <li class="menu-item" onclick="showLowStockAlerts()">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>تنبيهات المخزون</span>
                </li>
                <li class="menu-item" onclick="showReports()">
                    <i class="fas fa-chart-bar"></i>
                    <span>التقارير والإحصائيات</span>
                </li>
                <li class="menu-item" onclick="showSalesAnalytics()">
                    <i class="fas fa-chart-line"></i>
                    <span>تحليل المبيعات</span>
                </li>
                <li class="menu-item" onclick="showCoupons()">
                    <i class="fas fa-ticket-alt"></i>
                    <span>الكوبونات والعروض</span>
                </li>
                <li class="menu-item" onclick="showShipping()">
                    <i class="fas fa-shipping-fast"></i>
                    <span>الشحن والتوصيل</span>
                </li>
            </ul>
        </div>

        <div class="main-content-area" id="contentArea">
            <!-- محتوى الصفحات يتم تحميله هنا عبر JavaScript -->
        </div>
    </div>

    <!-- نموذج إضافة/تعديل منتج -->
    <div class="form-modal" id="productFormModal">
        <button class="quick-back-btn" onclick="closeProductForm()" title="إغلاق">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-box"></i> <span id="productFormTitle">إضافة منتج جديد</span></h3>
                <button class="close-form" onclick="closeProductForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <form id="productForm" onsubmit="event.preventDefault(); saveProduct();">
                    <input type="hidden" id="productId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">اسم المنتج</label>
                            <input type="text" class="form-input" id="productName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">رمز المنتج</label>
                            <input type="text" class="form-input" id="productCode" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">التصنيف</label>
                            <select class="form-select" id="productCategory" required>
                                <option value="">اختر التصنيف</option>
                                <!-- سيتم تعبئة التصنيفات هنا -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">العلامة التجارية</label>
                            <input type="text" class="form-input" id="productBrand">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">سعر الشراء</label>
                            <input type="number" class="form-input" id="purchasePrice" required min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">سعر البيع</label>
                            <input type="number" class="form-input" id="salePrice" required min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">الكمية في المخزون</label>
                            <input type="number" class="form-input" id="stockQuantity" required min="0" step="1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">الحد الأدنى للمخزون</label>
                            <input type="number" class="form-input" id="minStock" required min="0" step="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">وصف المنتج</label>
                        <textarea class="form-textarea" id="productDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">صور المنتج</label>
                        <input type="text" class="form-input" id="productImages" placeholder="رابط الصورة (يمكن إضافة أكثر من رابط مفصولة بفواصل)">
                        <small style="color: #666;">يمكنك استخدام روابط خارجية للصور</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" onclick="closeProductForm()">
                            <i class="fas fa-times"></i> <span>إلغاء</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> <span>حفظ المنتج</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل طلب -->
    <div class="form-modal" id="orderFormModal">
        <button class="quick-back-btn" onclick="closeOrderForm()" title="إغلاق">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-shopping-cart"></i> <span id="orderFormTitle">إضافة طلب جديد</span></h3>
                <button class="close-form" onclick="closeOrderForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <form id="orderForm" onsubmit="event.preventDefault(); saveOrder();">
                    <input type="hidden" id="orderId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">رقم الطلب</label>
                            <input type="text" class="form-input" id="orderNumber" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">العميل</label>
                            <select class="form-select" id="orderCustomerId" required>
                                <option value="">اختر العميل</option>
                                <!-- سيتم تعبئة العملاء هنا -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">تاريخ الطلب</label>
                            <input type="date" class="form-input" id="orderDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">حالة الطلب</label>
                            <select class="form-select" id="orderStatus" required>
                                <option value="pending">قيد الانتظار</option>
                                <option value="processing">قيد المعالجة</option>
                                <option value="shipped">تم الشحن</option>
                                <option value="completed">مكتمل</option>
                                <option value="cancelled">ملغي</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">طريقة الدفع</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="cash">نقدي</option>
                                <option value="credit">بطاقة ائتمان</option>
                                <option value="bank">تحويل بنكي</option>
                                <option value="cod">الدفع عند الاستلام</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">طريقة الشحن</label>
                            <select class="form-select" id="shippingMethod">
                                <option value="standard">شحن عادي</option>
                                <option value="express">شحن سريع</option>
                                <option value="pickup">استلام من المتجر</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">عنوان الشحن</label>
                        <textarea class="form-textarea" id="shippingAddress" rows="2" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ملاحظات الطلب</label>
                        <textarea class="form-textarea" id="orderNotes" rows="2"></textarea>
                    </div>
                    
                    <div id="orderItemsSection">
                        <h4 style="margin: 15px 0; color: var(--header-bg);">منتجات الطلب</h4>
                        <div id="orderItemsContainer">
                            <!-- سيتم إضافة منتجات الطلب هنا -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addOrderItem()">
                            <i class="fas fa-plus"></i> <span>إضافة منتج</span>
                        </button>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" onclick="closeOrderForm()">
                            <i class="fas fa-times"></i> <span>إلغاء</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> <span>حفظ الطلب</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل عميل -->
    <div class="form-modal" id="customerFormModal">
        <button class="quick-back-btn" onclick="closeCustomerForm()" title="إغلاق">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container">
            <div class="form-header">
                <h3><i class="fas fa-user"></i> <span id="customerFormTitle">إضافة عميل جديد</span></h3>
                <button class="close-form" onclick="closeCustomerForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <form id="customerForm" onsubmit="event.preventDefault(); saveCustomer();">
                    <input type="hidden" id="customerId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">الاسم الكامل</label>
                            <input type="text" class="form-input" id="customerName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">البريد الإلكتروني</label>
                            <input type="email" class="form-input" id="customerEmail" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">رقم الهاتف</label>
                            <input type="tel" class="form-input" id="customerPhone" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">العنوان</label>
                            <input type="text" class="form-input" id="customerAddress">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">المدينة</label>
                            <input type="text" class="form-input" id="customerCity">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاريخ الميلاد</label>
                            <input type="date" class="form-input" id="customerBirthdate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-textarea" id="customerNotes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" onclick="closeCustomerForm()">
                            <i class="fas fa-times"></i> <span>إلغاء</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> <span>حفظ العميل</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نموذج التسجيل -->
    <div class="form-modal" id="signupFormModal">
        <div class="form-container" style="max-width: 500px;">
            <div class="form-header">
                <h3><i class="fas fa-user-plus"></i> <span>إنشاء حساب جديد</span></h3>
                <button class="close-form" onclick="closeSignupForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <form id="signupForm" onsubmit="event.preventDefault(); handleSignup();">
                    <div class="form-group">
                        <label class="form-label required">الاسم الكامل</label>
                        <input type="text" class="form-input" id="signupName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">البريد الإلكتروني</label>
                        <input type="email" class="form-input" id="signupEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">كلمة المرور</label>
                        <input type="password" class="form-input" id="signupPassword" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">تأكيد كلمة المرور</label>
                        <input type="password" class="form-input" id="signupConfirmPassword" required minlength="6">
                    </div>
                    
                    <div class="login-error" id="signupError" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="signupErrorMessage">حدث خطأ أثناء إنشاء الحساب</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" onclick="closeSignupForm()">
                            <i class="fas fa-times"></i> <span>إلغاء</span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> <span>إنشاء الحساب</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة البحث المتقدم -->
    <div class="form-modal" id="searchModal">
        <button class="quick-back-btn" onclick="closeSearchModal()" title="إغلاق">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 900px;">
            <div class="form-header">
                <h3><i class="fas fa-search"></i> <span>البحث المتقدم عن المنتجات</span></h3>
                <button class="close-form" onclick="closeSearchModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="advanced-search">
                    <div class="search-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-filter"></i>
                            <h3 style="margin: 0;">فلتر البحث</h3>
                        </div>
                        <button class="btn btn-primary" onclick="performAdvancedSearch()">
                            <i class="fas fa-search"></i> <span>بحث</span>
                        </button>
                    </div>
                    
                    <div class="search-filters">
                        <div class="form-group">
                            <label class="form-label">اسم المنتج</label>
                            <input type="text" class="form-input" id="searchProductName" placeholder="ابحث باسم المنتج...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">رمز المنتج</label>
                            <input type="text" class="form-input" id="searchProductCode" placeholder="ابحث برمز المنتج...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">التصنيف</label>
                            <select class="form-select" id="searchCategory">
                                <option value="">جميع التصنيفات</option>
                                <!-- سيتم تعبئة التصنيفات هنا -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">حالة المخزون</label>
                            <select class="form-select" id="searchStockStatus">
                                <option value="">جميع الحالات</option>
                                <option value="in-stock">متوفر</option>
                                <option value="low-stock">منخفض</option>
                                <option value="out-of-stock">نفذ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">نطاق السعر</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" class="form-input" id="minPrice" placeholder="الحد الأدنى" min="0" style="flex: 1;">
                                <input type="number" class="form-input" id="maxPrice" placeholder="الحد الأقصى" min="0" style="flex: 1;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">العلامة التجارية</label>
                            <input type="text" class="form-input" id="searchBrand" placeholder="ابحث بالعلامة التجارية...">
                        </div>
                    </div>
                </div>
                
                <div class="search-results" id="searchResults">
                    <!-- سيتم عرض نتائج البحث هنا -->
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تنبيهات المخزون المنخفض -->
    <div class="form-modal" id="alertsModal">
        <button class="quick-back-btn" onclick="closeAlertsModal()" title="إغلاق">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 800px;">
            <div class="form-header">
                <h3><i class="fas fa-exclamation-triangle"></i> <span>تنبيهات المخزون المنخفض</span></h3>
                <button class="close-form" onclick="closeAlertsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="alerts-panel" id="alertsList">
                    <!-- سيتم عرض التنبيهات هنا -->
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-info" onclick="generatePurchaseOrder()">
                        <i class="fas fa-clipboard-list"></i> <span>إنشاء أمر شراء</span>
                    </button>
                    <button class="btn btn-danger" onclick="closeAlertsModal()" style="margin-right: auto;">
                        <i class="fas fa-times"></i> <span>إغلاق</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة التقارير -->
    <div class="form-modal" id="reportsModal">
        <button class="quick-back-btn" onclick="closeReportsModal()" title="إغلاق">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-container" style="max-width: 1000px;">
            <div class="form-header">
                <h3><i class="fas fa-chart-bar"></i> <span>التقارير والإحصائيات</span></h3>
                <button class="close-form" onclick="closeReportsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">نوع التقرير</label>
                        <select class="form-select" id="reportType" onchange="generateReport()">
                            <option value="sales">تقرير المبيعات</option>
                            <option value="inventory">تقرير المخزون</option>
                            <option value="customers">تقرير العملاء</option>
                            <option value="products">تقرير المنتجات</option>
                            <option value="orders">تقرير الطلبات</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الفترة الزمنية</label>
                        <select class="form-select" id="reportPeriod" onchange="generateReport()">
                            <option value="today">اليوم</option>
                            <option value="week">الأسبوع</option>
                            <option value="month">الشهر</option>
                            <option value="quarter">الربع السنوي</option>
                            <option value="year">السنة</option>
                            <option value="all">الكل</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">التصنيف</label>
                        <select class="form-select" id="reportCategory" onchange="generateReport()">
                            <option value="all">جميع التصنيفات</option>
                            <!-- سيتم تعبئة التصنيفات هنا -->
                        </select>
                    </div>
                </div>
                
                <div id="reportContent" style="margin-top: 30px;">
                    <!-- سيتم عرض التقرير هنا -->
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-success" onclick="exportCurrentReport()">
                        <i class="fas fa-download"></i> <span>تصدير التقرير</span>
                    </button>
                    <button class="btn btn-primary" onclick="printReport()">
                        <i class="fas fa-print"></i> <span>طباعة</span>
                    </button>
                    <button class="btn btn-danger" onclick="closeReportsModal()" style="margin-right: auto;">
                        <i class="fas fa-times"></i> <span>إغلاق</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="export-loading" id="exportLoading">
        <i class="fas fa-spinner"></i>
        <div id="exportLoadingText">جاري تحضير التقرير...</div>
        <div style="font-size: 0.9rem; color: #ccc;">قد تستغرق العملية بضع ثوانٍ</div>
    </div>

    <script>
        // ============================================
        // تهيئة Firebase
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDmdHcXWducb8fg721sxa2gn3Ev6f3W0cc",
            authDomain: "ramdan-5aedb.firebaseapp.com",
            projectId: "ramdan-5aedb",
            storageBucket: "ramdan-5aedb.firebasestorage.app",
            messagingSenderId: "430366107983",
            appId: "1:430366107983:web:3b3105c8404f06de16bd3a",
            measurementId: "G-LLHG4FQCDZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // تعريف المتغيرات العامة
        // ============================================
        let productsData = [];
        let categoriesData = [];
        let ordersData = [];
        let customersData = [];
        let inventoryData = [];
        let alertsData = [];
        let couponsData = [];
        let shippingData = [];

        let currentUser = null;
        let isInitialized = false;

        // ============================================
        // دوال المصادقة عبر Firebase
        // ============================================

        function handleLogin() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // تنظيف رسالة الخطأ
            errorDiv.style.display = 'none';
            
            if (!email || !password) {
                errorDiv.querySelector('span').textContent = 'الرجاء إدخال البريد الإلكتروني وكلمة المرور';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoading(true);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    currentUser = user;
                    
                    // الحصول على بيانات المستخدم الإضافية
                    return db.collection('users').doc(user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('loggedInUser').textContent = userData.name;
                    } else {
                        document.getElementById('loggedInUser').textContent = 'مستخدم';
                    }
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    initSystem();
                    showDashboard();
                    showSuccess('تم تسجيل الدخول بنجاح');
                    showLoading(false);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                    
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'البريد الإلكتروني غير مسجل';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'كلمة المرور غير صحيحة';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'بريد إلكتروني غير صالح';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'الحساب معطل';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'محاولات تسجيل دخول كثيرة، حاول لاحقاً';
                            break;
                    }
                    
                    errorDiv.querySelector('span').textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    showLoading(false);
                })
                .finally(() => {
                    showLoading(false);
                });
        }

        function handleSignup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorDiv = document.getElementById('signupError');
            
            // تنظيف رسالة الخطأ
            errorDiv.style.display = 'none';
            
            // التحقق من البيانات
            if (!name || !email || !password || !confirmPassword) {
                errorDiv.querySelector('span').textContent = 'الرجاء ملء جميع الحقول';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.querySelector('span').textContent = 'كلمات المرور غير متطابقة';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.querySelector('span').textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoading(true);
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // حفظ بيانات المستخدم الإضافية في Firestore (لا تجعل فشلها يمنع نجاح التسجيل)
                    try {
                        if (typeof db !== 'undefined' && db && typeof db.collection === 'function') {
                            return db.collection('users').doc(user.uid).set({
                                name: name,
                                email: email,
                                role: 'user',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                storeId: 'default'
                            }).catch((dbError) => {
                                console.warn('Firestore profile save failed:', dbError);
                                // تجاهل خطأ Firestore حتى لا يمنع إكمال التسجيل
                                return null;
                            });
                        } else {
                            console.warn('Firestore (db) is not available. Skipping profile save.');
                            return null;
                        }
                    } catch (e) {
                        console.warn('Firestore profile save threw an error:', e);
                        return null;
                    }
                })
                .then(() => {
                    closeSignupForm();

                    // إظهار رسالة نجاح حتى لو كانت شاشة الدخول تغطي تنبيهات الصفحة
                    try {
                        showSuccess('تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول');
                    } catch (e) {
                        window.alert('✅ تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول');
                    }
                })
                .catch((error) => {
                    console.error('Signup error:', error);
                    let errorMessage = 'حدث خطأ أثناء إنشاء الحساب';
                    
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'البريد الإلكتروني مسجل مسبقاً';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'بريد إلكتروني غير صالح';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = 'عملية غير مسموحة';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'كلمة المرور ضعيفة جداً';
                            break;
                    }
                    
                    errorDiv.querySelector('span').textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    showLoading(false);
                });
        }

        function handlePasswordReset() {
            const email = prompt('أدخل بريدك الإلكتروني لإعادة تعيين كلمة المرور:');
            
            if (!email) return;
            
            showLoading(true);
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showSuccess('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني');
                    showLoading(false);
                })
                .catch((error) => {
                    console.error('Password reset error:', error);
                    let errorMessage = 'حدث خطأ أثناء إرسال رابط إعادة التعيين';
                    
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'البريد الإلكتروني غير مسجل';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'بريد إلكتروني غير صالح';
                            break;
                    }
                    
                    showError(errorMessage);
                    showLoading(false);
                });
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                auth.signOut().then(() => {
                    currentUser = null;
                    document.getElementById('main-content').style.display = 'none';
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    showSuccess('تم تسجيل الخروج بنجاح');
                }).catch((error) => {
                    console.error('Logout error:', error);
                    showError('حدث خطأ أثناء تسجيل الخروج');
                });
            }
        }
// ============================================
// دوال إدارة النماذج
// ============================================

function showSignupForm() {
  document.getElementById('signupFormModal').classList.add('active');
}

function closeSignupForm() {
  const modal = document.getElementById('signupFormModal');
  modal.classList.remove('active');

  // (اختياري) تصفير الحقول ورسالة الخطأ
  document.getElementById('signupForm').reset();
  document.getElementById('signupError').style.display = 'none';
}


/* تم حذف تكرار الدالة logout لتجنب التعارض */

// === أضف الدوال التالية هنا ===

/* تم حذف تكرار الدالة showSignupForm لتجنب التعارض */


/* تم حذف تكرار الدالة closeSignupForm لتجنب التعارض */
// === نهاية الإضافة ===


        // ============================================
        // دوال إدارة البيانات عبر Firestore
        // ============================================

        async function loadDataFromFirestore() {
            try {
                showLoading(true);
                
                // تحميل التصنيفات
                const categoriesSnapshot = await db.collection('categories')
                    .where('storeId', '==', 'default')
                    .get();
                
                categoriesData = [];
                categoriesSnapshot.forEach(doc => {
                    categoriesData.push({ id: doc.id, ...doc.data() });
                });
                
                // تحميل المنتجات
                const productsSnapshot = await db.collection('products')
                    .where('storeId', '==', 'default')
                    .get();
                
                productsData = [];
                productsSnapshot.forEach(doc => {
                    productsData.push({ id: doc.id, ...doc.data() });
                });
                
                // تحميل العملاء
                const customersSnapshot = await db.collection('customers')
                    .where('storeId', '==', 'default')
                    .get();
                
                customersData = [];
                customersSnapshot.forEach(doc => {
                    customersData.push({ id: doc.id, ...doc.data() });
                });
                
                // تحميل الطلبات
                const ordersSnapshot = await db.collection('orders')
                    .where('storeId', '==', 'default')
                    .get();
                
                ordersData = [];
                ordersSnapshot.forEach(doc => {
                    ordersData.push({ id: doc.id, ...doc.data() });
                });
                
                // تحميل الكوبونات
                const couponsSnapshot = await db.collection('coupons')
                    .where('storeId', '==', 'default')
                    .get();
                
                couponsData = [];
                couponsSnapshot.forEach(doc => {
                    couponsData.push({ id: doc.id, ...doc.data() });
                });
                
                // تحديث حالة المخزون
                updateProductStockStatus();
                
                console.log('Data loaded from Firestore:', {
                    categories: categoriesData.length,
                    products: productsData.length,
                    customers: customersData.length,
                    orders: ordersData.length,
                    coupons: couponsData.length
                });
                
                showLoading(false);
                return true;
            } catch (error) {
                console.error('Error loading data from Firestore:', error);
                showLoading(false);
                return false;
            }
        }

        async function saveProductToFirestore(productData) {
            try {
                const productRef = productData.id ? 
                    db.collection('products').doc(productData.id) :
                    db.collection('products').doc();
                
                const dataToSave = {
                    ...productData,
                    storeId: 'default',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!productData.id) {
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    dataToSave.createdBy = currentUser ? currentUser.uid : 'unknown';
                }
                
                await productRef.set(dataToSave);
                
                return productRef.id;
            } catch (error) {
                console.error('Error saving product to Firestore:', error);
                throw error;
            }
        }

        async function saveCategoryToFirestore(categoryData) {
            try {
                const categoryRef = categoryData.id ? 
                    db.collection('categories').doc(categoryData.id) :
                    db.collection('categories').doc();
                
                const dataToSave = {
                    ...categoryData,
                    storeId: 'default',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!categoryData.id) {
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    dataToSave.createdBy = currentUser ? currentUser.uid : 'unknown';
                }
                
                await categoryRef.set(dataToSave);
                
                return categoryRef.id;
            } catch (error) {
                console.error('Error saving category to Firestore:', error);
                throw error;
            }
        }

        async function saveCustomerToFirestore(customerData) {
            try {
                const customerRef = customerData.id ? 
                    db.collection('customers').doc(customerData.id) :
                    db.collection('customers').doc();
                
                const dataToSave = {
                    ...customerData,
                    storeId: 'default',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!customerData.id) {
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                await customerRef.set(dataToSave);
                
                return customerRef.id;
            } catch (error) {
                console.error('Error saving customer to Firestore:', error);
                throw error;
            }
        }

        async function saveOrderToFirestore(orderData) {
            try {
                const orderRef = orderData.id ? 
                    db.collection('orders').doc(orderData.id) :
                    db.collection('orders').doc();
                
                const dataToSave = {
                    ...orderData,
                    storeId: 'default',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!orderData.id) {
                    dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    dataToSave.createdBy = currentUser ? currentUser.uid : 'unknown';
                }
                
                await orderRef.set(dataToSave);
                
                return orderRef.id;
            } catch (error) {
                console.error('Error saving order to Firestore:', error);
                throw error;
            }
        }

        async function deleteProductFromFirestore(productId) {
            try {
                await db.collection('products').doc(productId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting product from Firestore:', error);
                throw error;
            }
        }

        async function deleteCategoryFromFirestore(categoryId) {
            try {
                await db.collection('categories').doc(categoryId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting category from Firestore:', error);
                throw error;
            }
        }

        async function deleteCustomerFromFirestore(customerId) {
            try {
                await db.collection('customers').doc(customerId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting customer from Firestore:', error);
                throw error;
            }
        }

        async function deleteOrderFromFirestore(orderId) {
            try {
                await db.collection('orders').doc(orderId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting order from Firestore:', error);
                throw error;
            }
        }

        // ============================================
        // دوال النظام الأساسية
        // ============================================

        async function initSystem() {
            if (isInitialized) return;
            
            console.log('جاري تهيئة نظام إدارة المتجر مع Firebase...');
            
            try {
                await loadDataFromFirestore();
                updateStats();
                updateRecentData();
                
                isInitialized = true;
                
                console.log('تم التهيئة بنجاح:', {
                    categories: categoriesData.length,
                    products: productsData.length,
                    customers: customersData.length,
                    orders: ordersData.length,
                    coupons: couponsData.length
                });
            } catch (error) {
                console.error('Error initializing system:', error);
                showError('حدث خطأ أثناء تحميل البيانات');
            }
        }

        // ============================================
        // دوال عرض الصفحات الرئيسية
        // ============================================

        function showDashboard() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(1)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="stats-cards" id="statsCards">
                    <div class="stat-card">
                        <div class="stat-icon orders">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalOrders">${ordersData.length}</h3>
                            <p>الطلبات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon products">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalProducts">${productsData.length}</h3>
                            <p>المنتجات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon customers">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCustomers">${customersData.length}</h3>
                            <p>العملاء</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalRevenue">${calculateTotalRevenue().toFixed(2)} ر.س</h3>
                            <p>الإيرادات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pendingOrders">${countOrdersByStatus('pending')}</h3>
                            <p>طلبات قيد الانتظار</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon categories">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCategories">${categoriesData.length}</h3>
                            <p>التصنيفات</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> <span>إحصائيات المبيعات</span></h3>
                        <select class="chart-select" id="chartPeriod" onchange="updateDashboardCharts()">
                            <option value="week">الأسبوع</option>
                            <option value="month">الشهر</option>
                            <option value="year">السنة</option>
                        </select>
                    </div>
                    <canvas id="salesChart" style="width: 100%; height: 300px;"></canvas>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="control-panel">
                        <div class="panel-header">
                            <h2><i class="fas fa-box"></i> <span>المنتجات الأكثر مبيعاً</span></h2>
                        </div>
                        <div id="topProducts">
                            ${getTopProductsHTML()}
                        </div>
                    </div>
                    
                    <div class="control-panel">
                        <div class="panel-header">
                            <h2><i class="fas fa-users"></i> <span>آخر العملاء</span></h2>
                            <button class="btn btn-primary btn-sm" onclick="showAddCustomerForm()">
                                <i class="fas fa-plus"></i> <span>إضافة عميل</span>
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>البريد</th>
                                        <th>الهاتف</th>
                                        <th>عدد الطلبات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="recentCustomers">
                                    ${getRecentCustomersHTML()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="control-panel" style="margin-top: 20px;">
                    <div class="panel-header">
                        <h2><i class="fas fa-shopping-cart"></i> <span>آخر الطلبات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddOrderForm()">
                                <i class="fas fa-plus"></i> <span>إضافة طلب</span>
                            </button>
                            <div class="export-options">
                                <button class="btn btn-warning" onclick="toggleExportMenu()">
                                    <i class="fas fa-download"></i> <span>تصدير التقارير</span>
                                </button>
                                <div class="export-menu" id="exportMenu">
                                    <div class="export-option" onclick="exportReport('orders')">
                                        <i class="fas fa-file-excel"></i>
                                        <span>تصدير الطلبات</span>
                                    </div>
                                    <div class="export-option" onclick="exportReport('products')">
                                        <i class="fas fa-file-excel"></i>
                                        <span>تصدير المنتجات</span>
                                    </div>
                                    <div class="export-option" onclick="exportReport('customers')">
                                        <i class="fas fa-file-excel"></i>
                                        <span>تصدير العملاء</span>
                                    </div>
                                    <div class="export-option" onclick="exportReport('pdf')">
                                        <i class="fas fa-file-pdf"></i>
                                        <span>تقرير PDF شامل</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث البيانات</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert success" id="successAlert" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span id="successMessage">تمت العملية بنجاح</span>
                    </div>
                    
                    <div class="alert error" id="errorAlert" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="errorMessage">حدث خطأ أثناء العملية</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>التاريخ</th>
                                    <th>المجموع</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrders">
                                ${getRecentOrdersHTML()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            updateDashboardCharts();
        }

        function showProducts() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(2)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-box"></i> <span>إدارة المنتجات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddProductForm()">
                                <i class="fas fa-plus"></i> <span>إضافة منتج</span>
                            </button>
                            <button class="btn btn-success" onclick="exportProductsToExcel()">
                                <i class="fas fa-file-excel"></i> <span>تصدير Excel</span>
                            </button>
                            <button class="btn btn-warning" onclick="showAdvancedSearch()">
                                <i class="fas fa-search"></i> <span>بحث متقدم</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>الصورة</th>
                                    <th>اسم المنتج</th>
                                    <th>الرمز</th>
                                    <th>التصنيف</th>
                                    <th>العلامة</th>
                                    <th>السعر</th>
                                    <th>المخزون</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                ${getProductsTableHTML()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showCategories() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(3)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-tags"></i> <span>إدارة التصنيفات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddCategoryForm()">
                                <i class="fas fa-plus"></i> <span>إضافة تصنيف</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="product-cards" id="categoriesGrid">
                        ${getCategoriesGridHTML()}
                    </div>
                </div>
            `;
        }

        function showOrders() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(4)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-shopping-cart"></i> <span>إدارة الطلبات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddOrderForm()">
                                <i class="fas fa-plus"></i> <span>إضافة طلب</span>
                            </button>
                            <button class="btn btn-success" onclick="exportOrdersToExcel()">
                                <i class="fas fa-file-excel"></i> <span>تصدير Excel</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>التاريخ</th>
                                    <th>المنتجات</th>
                                    <th>المجموع</th>
                                    <th>حالة الدفع</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable">
                                ${getOrdersTableHTML()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showCustomers() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(5)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-users"></i> <span>إدارة العملاء</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddCustomerForm()">
                                <i class="fas fa-plus"></i> <span>إضافة عميل</span>
                            </button>
                            <button class="btn btn-success" onclick="exportCustomersToExcel()">
                                <i class="fas fa-file-excel"></i> <span>تصدير Excel</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>الاسم</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الهاتف</th>
                                    <th>المدينة</th>
                                    <th>عدد الطلبات</th>
                                    <th>إجمالي المشتريات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                ${getCustomersTableHTML()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showInventory() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(6)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-warehouse"></i> <span>إدارة المخزون</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddProductForm()">
                                <i class="fas fa-plus"></i> <span>إضافة منتج</span>
                            </button>
                            <button class="btn btn-warning" onclick="showLowStockAlerts()">
                                <i class="fas fa-exclamation-triangle"></i> <span>تنبيهات المخزون</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="stock-tracker">
                        ${getInventoryStatsHTML()}
                    </div>
                    
                    <div class="table-responsive" style="margin-top: 20px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>اسم المنتج</th>
                                    <th>الرمز</th>
                                    <th>المخزون الحالي</th>
                                    <th>الحد الأدنى</th>
                                    <th>حالة المخزون</th>
                                    <th>سعر الشراء</th>
                                    <th>سعر البيع</th>
                                    <th>قيمة المخزون</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable">
                                ${getInventoryTableHTML()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showAdvancedSearch() {
            document.getElementById('searchModal').classList.add('active');
            populateSearchFilters();
        }

        function showLowStockAlerts() {
            document.getElementById('alertsModal').classList.add('active');
            displayAlerts();
        }

        function showReports() {
            document.getElementById('reportsModal').classList.add('active');
            populateReportFilters();
            generateReport();
        }

        function showSalesAnalytics() {
            showDashboard();
            showInfo('صفحة تحليل المبيعات قيد التطوير');
        }

        function showCoupons() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(10)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-ticket-alt"></i> <span>إدارة الكوبونات والعروض</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddCouponForm()">
                                <i class="fas fa-plus"></i> <span>إضافة كوبون</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="product-cards" id="couponsGrid">
                        ${getCouponsGridHTML()}
                    </div>
                </div>
            `;
        }

        function showShipping() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(11)').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-shipping-fast"></i> <span>إدارة الشحن والتوصيل</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAddShippingMethod()">
                                <i class="fas fa-plus"></i> <span>إضافة طريقة شحن</span>
                            </button>
                            <button class="btn btn-info" onclick="refreshData()">
                                <i class="fas fa-sync"></i> <span>تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-shipping-fast" style="font-size: 48px; color: #ccc;"></i>
                        <h3 style="color: #666; margin-top: 20px;">صفحة إدارة الشحن والتوصيل قيد التطوير</h3>
                        <p>سيتم إضافة ميزات إدارة شركات الشحن وأسعار التوصيل قريباً</p>
                    </div>
                </div>
            `;
        }

        // ============================================
        // دوال إدارة المنتجات
        // ============================================

        function showAddProductForm() {
            document.getElementById('productFormTitle').textContent = 'إضافة منتج جديد';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            populateCategorySelect('productCategory');
            document.getElementById('productFormModal').classList.add('active');
        }

        function showEditProductForm(id) {
            const product = productsData.find(p => p.id == id);
            if (!product) return;
            
            document.getElementById('productFormTitle').textContent = 'تعديل بيانات المنتج';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCode').value = product.code;
            document.getElementById('purchasePrice').value = product.purchasePrice;
            document.getElementById('salePrice').value = product.salePrice;
            document.getElementById('stockQuantity').value = product.stockQuantity;
            document.getElementById('minStock').value = product.minStock;
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImages').value = product.images || '';
            
            populateCategorySelect('productCategory');
            document.getElementById('productCategory').value = product.categoryId;
            
            document.getElementById('productFormModal').classList.add('active');
        }

        async function saveProduct() {
            const id = document.getElementById('productId').value;
            const isEdit = !!id;
            
            const productData = {
                name: document.getElementById('productName').value,
                code: document.getElementById('productCode').value,
                categoryId: document.getElementById('productCategory').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                stockQuantity: parseInt(document.getElementById('stockQuantity').value),
                minStock: parseInt(document.getElementById('minStock').value),
                images: document.getElementById('productImages').value,
                status: calculateStockStatus(
                    parseInt(document.getElementById('stockQuantity').value),
                    parseInt(document.getElementById('minStock').value)
                )
            };
            
            if (!productData.name || !productData.code || !productData.categoryId) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    productData.id = id;
                    await saveProductToFirestore(productData);
                } else {
                    const newId = await saveProductToFirestore(productData);
                    productData.id = newId;
                }
                
                // تحديث البيانات المحلية
                await loadDataFromFirestore();
                
                closeProductForm();
                checkStockAlerts();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث بيانات المنتج بنجاح' : 'تم إضافة المنتج الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ المنتج: ' + error.message);
                showLoading(false);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟ سيتم حذفه من جميع الطلبات.')) return;
            
            try {
                showLoading(true);
                await deleteProductFromFirestore(id);
                await loadDataFromFirestore();
                showDashboard();
                showSuccess('تم حذف المنتج بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف المنتج: ' + error.message);
                showLoading(false);
            }
        }

        function closeProductForm() {
            document.getElementById('productFormModal').classList.remove('active');
        }

        // ============================================
        // دوال إدارة التصنيفات
        // ============================================

        async function showAddCategoryForm() {
            const name = prompt('أدخل اسم التصنيف الجديد:');
            if (!name) return;
            
            const description = prompt('أدخل وصف التصنيف (اختياري):');
            
            const categoryData = {
                name: name,
                description: description || '',
                productCount: 0
            };
            
            try {
                showLoading(true);
                await saveCategoryToFirestore(categoryData);
                await loadDataFromFirestore();
                showCategories();
                showSuccess('تم إضافة التصنيف الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء إضافة التصنيف: ' + error.message);
                showLoading(false);
            }
        }

        async function deleteCategory(id) {
            if (!confirm('هل أنت متأكد من حذف هذا التصنيف؟ سيتم نقل المنتجات المرتبطة به إلى تصنيف غير مصنف.')) return;
            
            try {
                showLoading(true);
                
                // نقل المنتجات إلى تصنيف افتراضي
                const batch = db.batch();
                productsData.forEach(product => {
                    if (product.categoryId == id) {
                        const productRef = db.collection('products').doc(product.id);
                        batch.update(productRef, { categoryId: 'uncategorized' });
                    }
                });
                await batch.commit();
                
                // حذف التصنيف
                await deleteCategoryFromFirestore(id);
                
                await loadDataFromFirestore();
                showCategories();
                showSuccess('تم حذف التصنيف بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف التصنيف: ' + error.message);
                showLoading(false);
            }
        }

        // ============================================
        // دوال إدارة العملاء
        // ============================================

        function showAddCustomerForm() {
            document.getElementById('customerFormTitle').textContent = 'إضافة عميل جديد';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('customerFormModal').classList.add('active');
        }

        function showEditCustomerForm(id) {
            const customer = customersData.find(c => c.id == id);
            if (!customer) return;
            
            document.getElementById('customerFormTitle').textContent = 'تعديل بيانات العميل';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerCity').value = customer.city || '';
            document.getElementById('customerBirthdate').value = customer.birthdate || '';
            document.getElementById('customerNotes').value = customer.notes || '';
            
            document.getElementById('customerFormModal').classList.add('active');
        }

        async function saveCustomer() {
            const id = document.getElementById('customerId').value;
            const isEdit = !!id;
            
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                city: document.getElementById('customerCity').value,
                birthdate: document.getElementById('customerBirthdate').value,
                notes: document.getElementById('customerNotes').value
            };
            
            if (!customerData.name || !customerData.email || !customerData.phone) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    customerData.id = id;
                    // الحفاظ على البيانات القديمة
                    const oldCustomer = customersData.find(c => c.id == id);
                    if (oldCustomer) {
                        customerData.totalOrders = oldCustomer.totalOrders || 0;
                        customerData.totalSpent = oldCustomer.totalSpent || 0;
                    }
                    await saveCustomerToFirestore(customerData);
                } else {
                    customerData.totalOrders = 0;
                    customerData.totalSpent = 0;
                    const newId = await saveCustomerToFirestore(customerData);
                    customerData.id = newId;
                }
                
                // تحديث البيانات المحلية
                await loadDataFromFirestore();
                
                closeCustomerForm();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث بيانات العميل بنجاح' : 'تم إضافة العميل الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ العميل: ' + error.message);
                showLoading(false);
            }
        }

        async function deleteCustomer(id) {
            if (!confirm('هل أنت متأكد من حذف هذا العميل؟ سيتم حذف جميع الطلبات المرتبطة به.')) return;
            
            try {
                showLoading(true);
                
                // حذف العميل
                await deleteCustomerFromFirestore(id);
                
                // تحديث البيانات المحلية
                await loadDataFromFirestore();
                
                showDashboard();
                showSuccess('تم حذف العميل بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف العميل: ' + error.message);
                showLoading(false);
            }
        }

        function closeCustomerForm() {
            document.getElementById('customerFormModal').classList.remove('active');
        }

        // ============================================
        // دوال إدارة الطلبات
        // ============================================

        function showAddOrderForm() {
            document.getElementById('orderFormTitle').textContent = 'إضافة طلب جديد';
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = '';
            document.getElementById('orderNumber').value = 'ORD-' + (ordersData.length + 1000);
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            
            populateCustomerSelect('orderCustomerId');
            document.getElementById('orderItemsContainer').innerHTML = '';
            addOrderItem();
            
            document.getElementById('orderFormModal').classList.add('active');
        }

        function showEditOrderForm(id) {
            const order = ordersData.find(o => o.id == id);
            if (!order) return;
            
            document.getElementById('orderFormTitle').textContent = 'تعديل الطلب #' + order.orderNumber;
            document.getElementById('orderId').value = order.id;
            document.getElementById('orderNumber').value = order.orderNumber;
            document.getElementById('orderDate').value = order.orderDate;
            document.getElementById('orderStatus').value = order.status;
            document.getElementById('paymentMethod').value = order.paymentMethod || 'cash';
            document.getElementById('shippingMethod').value = order.shippingMethod || 'standard';
            document.getElementById('shippingAddress').value = order.shippingAddress || '';
            document.getElementById('orderNotes').value = order.notes || '';
            
            populateCustomerSelect('orderCustomerId');
            document.getElementById('orderCustomerId').value = order.customerId;
            
            // تحميل منتجات الطلب
            document.getElementById('orderItemsContainer').innerHTML = '';
            order.items.forEach((item, index) => {
                addOrderItem(item.productId, item.quantity, item.price);
            });
            
            document.getElementById('orderFormModal').classList.add('active');
        }

        function populateCustomerSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">اختر العميل</option>';
            
            customersData.forEach(customer => {
                select.innerHTML += `<option value="${customer.id}">${customer.name} (${customer.email})</option>`;
            });
        }

        function addOrderItem(productId = '', quantity = 1, price = 0) {
            const container = document.getElementById('orderItemsContainer');
            const itemId = Date.now() + Math.random();
            
            let productSelectHTML = '<option value="">اختر المنتج</option>';
            productsData.forEach(product => {
                productSelectHTML += `<option value="${product.id}" data-price="${product.salePrice}">${product.name} (${product.code}) - ${product.salePrice} ر.س</option>`;
            });
            
            container.innerHTML += `
                <div class="order-item" id="orderItem-${itemId}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; align-items: center;">
                    <select class="form-select order-product-select" onchange="updateOrderItemPrice(this, ${itemId})" style="flex: 1;">
                        ${productSelectHTML}
                    </select>
                    <input type="number" class="form-input order-quantity" value="${quantity}" min="1" onchange="calculateOrderItemTotal(${itemId})" style="flex: 1;">
                    <input type="number" class="form-input order-price" value="${price}" min="0" step="0.01" onchange="calculateOrderItemTotal(${itemId})" style="flex: 1;">
                    <input type="text" class="form-input order-total" value="${(quantity * price).toFixed(2)}" readonly style="flex: 1;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(${itemId})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            if (productId) {
                setTimeout(() => {
                    const select = document.querySelector(`#orderItem-${itemId} .order-product-select`);
                    if (select) select.value = productId;
                }, 100);
            }
        }

        function updateOrderItemPrice(select, itemId) {
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.getAttribute('data-price') || 0;
            
            const priceInput = document.querySelector(`#orderItem-${itemId} .order-price`);
            if (priceInput) {
                priceInput.value = price;
                calculateOrderItemTotal(itemId);
            }
        }

        function calculateOrderItemTotal(itemId) {
            const quantityInput = document.querySelector(`#orderItem-${itemId} .order-quantity`);
            const priceInput = document.querySelector(`#orderItem-${itemId} .order-price`);
            const totalInput = document.querySelector(`#orderItem-${itemId} .order-total`);
            
            if (quantityInput && priceInput && totalInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = (quantity * price).toFixed(2);
            }
        }

        function removeOrderItem(itemId) {
            const item = document.getElementById(`orderItem-${itemId}`);
            if (item) item.remove();
        }

        async function saveOrder() {
            const id = document.getElementById('orderId').value;
            const isEdit = !!id;
            
            // جمع بيانات منتجات الطلب
            const orderItems = [];
            let subtotal = 0;
            
            document.querySelectorAll('.order-item').forEach(item => {
                const productSelect = item.querySelector('.order-product-select');
                const quantityInput = item.querySelector('.order-quantity');
                const priceInput = item.querySelector('.order-price');
                
                if (productSelect.value && quantityInput.value && priceInput.value) {
                    const productId = productSelect.value;
                    const quantity = parseInt(quantityInput.value);
                    const price = parseFloat(priceInput.value);
                    
                    orderItems.push({
                        productId: productId,
                        quantity: quantity,
                        price: price
                    });
                    
                    subtotal += quantity * price;
                }
            });
            
            if (orderItems.length === 0) {
                showError('يجب إضافة منتجات على الأقل إلى الطلب');
                return;
            }
            
            const orderData = {
                orderNumber: document.getElementById('orderNumber').value,
                customerId: document.getElementById('orderCustomerId').value,
                orderDate: document.getElementById('orderDate').value,
                status: document.getElementById('orderStatus').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                shippingMethod: document.getElementById('shippingMethod').value,
                shippingAddress: document.getElementById('shippingAddress').value,
                notes: document.getElementById('orderNotes').value,
                items: orderItems,
                subtotal: subtotal,
                shippingCost: 0, // يمكن إضافة حساب الشحن
                discount: 0, // يمكن إضافة حسابات الخصم
                tax: subtotal * 0.15, // ضريبة 15%
                total: subtotal + (subtotal * 0.15)
            };
            
            if (!orderData.orderNumber || !orderData.customerId || !orderData.orderDate) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    orderData.id = id;
                    await saveOrderToFirestore(orderData);
                } else {
                    const newId = await saveOrderToFirestore(orderData);
                    orderData.id = newId;
                    
                    // تحديث مخزون المنتجات
                    const batch = db.batch();
                    orderData.items.forEach(item => {
                        const product = productsData.find(p => p.id == item.productId);
                        if (product) {
                            const newStockQuantity = product.stockQuantity - item.quantity;
                            const productRef = db.collection('products').doc(product.id);
                            batch.update(productRef, { 
                                stockQuantity: newStockQuantity,
                                status: calculateStockStatus(newStockQuantity, product.minStock)
                            });
                        }
                    });
                    await batch.commit();
                }
                
                // تحديث البيانات المحلية
                await loadDataFromFirestore();
                
                closeOrderForm();
                checkStockAlerts();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث الطلب بنجاح' : 'تم إضافة الطلب الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ الطلب: ' + error.message);
                showLoading(false);
            }
        }

        async function deleteOrder(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟')) return;
            
            try {
                showLoading(true);
                await deleteOrderFromFirestore(id);
                await loadDataFromFirestore();
                showDashboard();
                showSuccess('تم حذف الطلب بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف الطلب: ' + error.message);
                showLoading(false);
            }
        }

        async function updateOrderStatus(id, status) {
            const order = ordersData.find(o => o.id == id);
            if (!order) return;
            
            try {
                const orderRef = db.collection('orders').doc(id);
                await orderRef.update({
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await loadDataFromFirestore();
                showOrders();
                showSuccess('تم تحديث حالة الطلب بنجاح');
            } catch (error) {
                showError('حدث خطأ أثناء تحديث حالة الطلب: ' + error.message);
            }
        }

        function closeOrderForm() {
            document.getElementById('orderFormModal').classList.remove('active');
        }

        // ============================================
        // دوال إدارة الكوبونات
        // ============================================

        async function showAddCouponForm() {
            const code = prompt('أدخل كود الكوبون:');
            if (!code) return;
            
            const discountType = prompt('نوع الخصم (percentage/fixed):', 'percentage');
            const discountValue = parseFloat(prompt('قيمة الخصم:'));
            if (isNaN(discountValue)) return;
            
            const couponData = {
                code: code,
                discountType: discountType,
                discountValue: discountValue,
                minPurchase: 0,
                maxDiscount: discountType === 'percentage' ? discountValue : 0,
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 يوم من الآن
                usageLimit: 100,
                usedCount: 0,
                status: 'active',
                storeId: 'default'
            };
            
            try {
                showLoading(true);
                await db.collection('coupons').add(couponData);
                await loadDataFromFirestore();
                showCoupons();
                showSuccess('تم إضافة الكوبون الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء إضافة الكوبون: ' + error.message);
                showLoading(false);
            }
        }

        async function deleteCoupon(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الكوبون؟')) return;
            
            try {
                showLoading(true);
                await db.collection('coupons').doc(id).delete();
                await loadDataFromFirestore();
                showCoupons();
                showSuccess('تم حذف الكوبون بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف الكوبون: ' + error.message);
                showLoading(false);
            }
        }

        // ============================================
        // دوال البحث المتقدم
        // ============================================

        function populateSearchFilters() {
            const categorySelect = document.getElementById('searchCategory');
            categorySelect.innerHTML = '<option value="">جميع التصنيفات</option>';
            
            categoriesData.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        function performAdvancedSearch() {
            const searchProductName = document.getElementById('searchProductName').value.toLowerCase();
            const searchProductCode = document.getElementById('searchProductCode').value.toLowerCase();
            const searchCategory = document.getElementById('searchCategory').value;
            const searchStockStatus = document.getElementById('searchStockStatus').value;
            const searchBrand = document.getElementById('searchBrand').value.toLowerCase();
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
            
            let results = productsData.filter(product => {
                // تطبيق الفلاتر
                if (searchProductName && !product.name.toLowerCase().includes(searchProductName)) return false;
                
                if (searchProductCode && !product.code.toLowerCase().includes(searchProductCode)) return false;
                
                if (searchCategory && product.categoryId != searchCategory) return false;
                
                if (searchStockStatus && product.status != searchStockStatus) return false;
                
                if (searchBrand && product.brand && !product.brand.toLowerCase().includes(searchBrand)) return false;
                
                if (product.salePrice < minPrice || product.salePrice > maxPrice) return false;
                
                return true;
            });
            
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-message" style="text-align: center; padding: 40px;">
                        <i class="fas fa-search" style="font-size: 48px; color: #ccc;"></i>
                        <h3 style="color: #666; margin-top: 20px;">لم يتم العثور على نتائج</h3>
                    </div>
                `;
                return;
            }
            
            let html = '<h3 style="margin-bottom: 15px; color: var(--header-bg);">نتائج البحث</h3>';
            html += '<div class="product-cards">';
            
            results.forEach(product => {
                const category = categoriesData.find(c => c.id == product.categoryId);
                const statusClass = product.status === 'in-stock' ? 'success' : 
                                   product.status === 'low-stock' ? 'warning' : 'danger';
                const statusText = product.status === 'in-stock' ? 'متوفر' : 
                                  product.status === 'low-stock' ? 'منخفض' : 'نفذ';
                
                html += `
                    <div class="product-card ${product.status}">
                        <div class="product-header">
                            <div>
                                <h3 class="product-name">${product.name}</h3>
                                <span class="product-code">${product.code}</span>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        ${product.images ? `
                        <div class="product-image">
                            <img src="${product.images.split(',')[0]}" alt="${product.name}">
                        </div>
                        ` : ''}
                        
                        <div class="product-details">
                            <div class="detail-row">
                                <span class="detail-label">التصنيف:</span>
                                <span class="detail-value">${category ? category.name : 'غير مصنف'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">العلامة التجارية:</span>
                                <span class="detail-value">${product.brand || '-'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">المخزون:</span>
                                <span class="detail-value">${product.stockQuantity} / ${product.minStock}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">سعر البيع:</span>
                                <span class="detail-value">${product.salePrice} ر.س</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="showEditProductForm('${product.id}')">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewProductDetails('${product.id}')">
                                <i class="fas fa-eye"></i> تفاصيل
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function viewProductDetails(id) {
            const product = productsData.find(p => p.id == id);
            if (!product) return;
            
            const category = categoriesData.find(c => c.id == product.categoryId);
            const statusText = product.status === 'in-stock' ? 'متوفر' : 
                              product.status === 'low-stock' ? 'منخفض' : 'نفذ';
            
            let message = `تفاصيل المنتج:\n\n`;
            message += `الاسم: ${product.name}\n`;
            message += `الرمز: ${product.code}\n`;
            message += `التصنيف: ${category ? category.name : 'غير مصنف'}\n`;
            message += `العلامة التجارية: ${product.brand || 'غير محدد'}\n`;
            message += `سعر الشراء: ${product.purchasePrice} ر.س\n`;
            message += `سعر البيع: ${product.salePrice} ر.س\n`;
            message += `المخزون: ${product.stockQuantity}\n`;
            message += `الحد الأدنى: ${product.minStock}\n`;
            message += `الحالة: ${statusText}\n`;
            message += `الوصف: ${product.description || 'لا يوجد'}\n`;
            
            alert(message);
        }

        function closeSearchModal() {
            document.getElementById('searchModal').classList.remove('active');
        }

        // ============================================
        // دوال تنبيهات المخزون
        // ============================================

        function generateAlerts() {
            const alerts = [];
            
            productsData.forEach(product => {
                // تنبيهات المخزون المنخفض
                if (product.stockQuantity <= product.minStock && product.stockQuantity > 0) {
                    alerts.push({
                        id: `alert-${product.id}-low`,
                        type: 'warning',
                        title: 'مخزون منخفض',
                        message: `المخزون من ${product.name} منخفض (${product.stockQuantity}/${product.minStock})`,
                        productId: product.id,
                        createdAt: new Date().toISOString(),
                        read: false
                    });
                }
                
                // تنبيهات نفاذ المخزون
                if (product.stockQuantity === 0) {
                    alerts.push({
                        id: `alert-${product.id}-out`,
                        type: 'danger',
                        title: 'نفاذ المخزون',
                        message: `المخزون من ${product.name} نفذ`,
                        productId: product.id,
                        createdAt: new Date().toISOString(),
                        read: false
                    });
                }
            });
            
            return alerts;
        }

        function checkStockAlerts() {
            alertsData = generateAlerts();
            // عرض عدد التنبيهات غير المقروءة
            const unreadCount = alertsData.filter(a => !a.read).length;
            if (unreadCount > 0) {
                showInfo(`لديك ${unreadCount} تنبيه جديد للمخزون`);
            }
        }

        function displayAlerts() {
            const container = document.getElementById('alertsList');
            
            if (alertsData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-bell-slash" style="font-size: 48px; color: #ccc;"></i>
                        <h3 style="color: #666; margin-top: 20px;">لا توجد تنبيهات</h3>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // تصنيف التنبيهات حسب النوع
            const lowStockAlerts = alertsData.filter(a => a.type === 'warning' && !a.read);
            const outOfStockAlerts = alertsData.filter(a => a.type === 'danger' && !a.read);
            const readAlerts = alertsData.filter(a => a.read);
            
            if (lowStockAlerts.length > 0) {
                html += '<h3 style="margin-bottom: 15px; color: var(--warning-color);">منخفض المخزون</h3>';
                lowStockAlerts.forEach(alert => {
                    html += createAlertItemHTML(alert);
                });
            }
            
            if (outOfStockAlerts.length > 0) {
                html += '<h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--danger-color);">نفاذ المخزون</h3>';
                outOfStockAlerts.forEach(alert => {
                    html += createAlertItemHTML(alert);
                });
            }
            
            if (readAlerts.length > 0) {
                html += '<h3 style="margin-top: 30px; margin-bottom: 15px; color: #666;">التنبيهات المقروءة</h3>';
                readAlerts.forEach(alert => {
                    html += createAlertItemHTML(alert);
                });
            }
            
            container.innerHTML = html;
        }

        function createAlertItemHTML(alert) {
            const iconClass = alert.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
            const product = productsData.find(p => p.id == alert.productId);
            
            if (!product) return '';
            
            return `
                <div class="alert-item" onclick="markAlertAsRead('${alert.id}')">
                    <div class="alert-icon ${alert.type}">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                        <small style="color: #999; font-size: 12px;">${formatDate(alert.createdAt)}</small>
                    </div>
                    ${!alert.read ? '<span class="stock-badge low" style="font-size: 10px;">جديد</span>' : ''}
                    <button class="btn btn-sm btn-primary" onclick="restockProduct('${product.id}'); event.stopPropagation();">
                        <i class="fas fa-plus"></i> إعادة تخزين
                    </button>
                </div>
            `;
        }

        function markAlertAsRead(alertId) {
            const alertIndex = alertsData.findIndex(a => a.id === alertId);
            if (alertIndex !== -1) {
                alertsData[alertIndex].read = true;
                displayAlerts();
            }
        }

        async function restockProduct(productId) {
            const product = productsData.find(p => p.id == productId);
            if (!product) return;
            
            const quantity = prompt(`أدخل الكمية المراد إضافتها إلى ${product.name}:`, product.minStock * 2);
            if (!quantity || isNaN(quantity)) return;
            
            try {
                showLoading(true);
                
                const newStockQuantity = product.stockQuantity + parseInt(quantity);
                const productRef = db.collection('products').doc(productId);
                await productRef.update({
                    stockQuantity: newStockQuantity,
                    status: calculateStockStatus(newStockQuantity, product.minStock)
                });
                
                await loadDataFromFirestore();
                
                // تحديث التنبيهات
                markAlertAsRead(`alert-${productId}-low`);
                markAlertAsRead(`alert-${productId}-out`);
                
                displayAlerts();
                showSuccess(`تمت إضافة ${quantity} وحدة إلى مخزون ${product.name}`);
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء إعادة التخزين: ' + error.message);
                showLoading(false);
            }
        }

        function generatePurchaseOrder() {
            const lowStockProducts = productsData.filter(p => p.stockQuantity <= p.minStock);
            
            if (lowStockProducts.length === 0) {
                showInfo('لا توجد منتجات تحتاج إلى إعادة تخزين');
                return;
            }
            
            let message = 'أمر شراء للمنتجات التالية:\n\n';
            let totalCost = 0;
            
            lowStockProducts.forEach(product => {
                const needed = product.minStock * 2 - product.stockQuantity;
                const cost = needed * product.purchasePrice;
                totalCost += cost;
                
                message += `• ${product.name}: ${needed} وحدة × ${product.purchasePrice} ر.س = ${cost.toFixed(2)} ر.س\n`;
            });
            
            message += `\nإجمالي التكلفة: ${totalCost.toFixed(2)} ر.س`;
            
            alert(message);
            showSuccess('تم إنشاء أمر شراء بنجاح');
        }

        function closeAlertsModal() {
            document.getElementById('alertsModal').classList.remove('active');
        }

        // ============================================
        // دوال التقارير والإحصائيات
        // ============================================

        function populateReportFilters() {
            const categorySelect = document.getElementById('reportCategory');
            categorySelect.innerHTML = '<option value="all">جميع التصنيفات</option>';
            
            categoriesData.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            const reportCategory = document.getElementById('reportCategory').value;
            
            let reportContent = '';
            
            switch(reportType) {
                case 'sales':
                    reportContent = generateSalesReport(reportPeriod);
                    break;
                case 'inventory':
                    reportContent = generateInventoryReport(reportCategory);
                    break;
                case 'customers':
                    reportContent = generateCustomersReport();
                    break;
                case 'products':
                    reportContent = generateProductsReport(reportCategory);
                    break;
                case 'orders':
                    reportContent = generateOrdersReport(reportPeriod);
                    break;
                default:
                    reportContent = generateSalesReport(reportPeriod);
            }
            
            document.getElementById('reportContent').innerHTML = reportContent;
        }

        function generateSalesReport(period) {
            const filteredOrders = filterOrdersByPeriod(ordersData, period);
            const salesByCategory = {};
            let totalRevenue = 0;
            
            filteredOrders.forEach(order => {
                totalRevenue += order.total;
                
                order.items.forEach(item => {
                    const product = productsData.find(p => p.id == item.productId);
                    if (product) {
                        const category = categoriesData.find(c => c.id == product.categoryId);
                        const categoryName = category ? category.name : 'غير مصنف';
                        
                        if (!salesByCategory[categoryName]) {
                            salesByCategory[categoryName] = {
                                revenue: 0,
                                quantity: 0
                            };
                        }
                        
                        salesByCategory[categoryName].revenue += item.quantity * item.price;
                        salesByCategory[categoryName].quantity += item.quantity;
                    }
                });
            });
            
            let html = `
                <h3 style="color: var(--header-bg); margin-bottom: 20px;">تقرير المبيعات</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">إجمالي الإيرادات</h4>
                        <h2 style="color: var(--product-color); margin: 10px 0;">${totalRevenue.toFixed(2)} ر.س</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">عدد الطلبات</h4>
                        <h2 style="color: var(--order-color); margin: 10px 0;">${filteredOrders.length}</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">متوسط قيمة الطلب</h4>
                        <h2 style="color: var(--success-color); margin: 10px 0;">${filteredOrders.length > 0 ? (totalRevenue / filteredOrders.length).toFixed(2) : 0} ر.س</h2>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--header-bg);">المبيعات حسب التصنيف</h4>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>التصنيف</th>
                                <th>الإيرادات</th>
                                <th>الكمية المباعة</th>
                                <th>نسبة الإيرادات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.keys(salesByCategory).forEach(categoryName => {
                const data = salesByCategory[categoryName];
                const percentage = totalRevenue > 0 ? (data.revenue / totalRevenue * 100).toFixed(1) : 0;
                
                html += `
                    <tr>
                        <td>${categoryName}</td>
                        <td>${data.revenue.toFixed(2)} ر.س</td>
                        <td>${data.quantity}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--header-bg);">أعلى 5 منتجات مبيعاً</h4>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية المباعة</th>
                                <th>الإيرادات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const topProducts = getTopProducts(5, period);
            topProducts.forEach(product => {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.quantitySold}</td>
                        <td>${product.revenue.toFixed(2)} ر.س</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function generateInventoryReport(categoryId) {
            const filteredProducts = categoryId === 'all' ? productsData : 
                                   productsData.filter(p => p.categoryId == categoryId);
            
            let totalValue = 0;
            let inStockCount = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            
            filteredProducts.forEach(product => {
                totalValue += product.stockQuantity * product.purchasePrice;
                
                if (product.status === 'in-stock') inStockCount++;
                else if (product.status === 'low-stock') lowStockCount++;
                else outOfStockCount++;
            });
            
            let html = `
                <h3 style="color: var(--header-bg); margin-bottom: 20px;">تقرير المخزون</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">قيمة المخزون</h4>
                        <h2 style="color: var(--product-color); margin: 10px 0;">${totalValue.toFixed(2)} ر.س</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">عدد المنتجات</h4>
                        <h2 style="color: var(--info-color); margin: 10px 0;">${filteredProducts.length}</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">متوفر</h4>
                        <h2 style="color: var(--success-color); margin: 10px 0;">${inStockCount}</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">منخفض</h4>
                        <h2 style="color: var(--warning-color); margin: 10px 0;">${lowStockCount}</h2>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--header-bg);">تفاصيل المخزون</h4>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الرمز</th>
                                <th>المخزون الحالي</th>
                                <th>الحد الأدنى</th>
                                <th>حالة المخزون</th>
                                <th>سعر الشراء</th>
                                <th>قيمة المخزون</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredProducts.forEach(product => {
                const category = categoriesData.find(c => c.id == product.categoryId);
                const statusClass = product.status === 'in-stock' ? 'success' : 
                                   product.status === 'low-stock' ? 'warning' : 'danger';
                const statusText = product.status === 'in-stock' ? 'متوفر' : 
                                  product.status === 'low-stock' ? 'منخفض' : 'نفذ';
                const stockValue = product.stockQuantity * product.purchasePrice;
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.code}</td>
                        <td>${product.stockQuantity}</td>
                        <td>${product.minStock}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${product.purchasePrice} ر.س</td>
                        <td>${stockValue.toFixed(2)} ر.س</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function generateCustomersReport() {
            const sortedCustomers = [...customersData].sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0));
            
            let html = `
                <h3 style="color: var(--header-bg); margin-bottom: 20px;">تقرير العملاء</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">عدد العملاء</h4>
                        <h2 style="color: var(--customer-color); margin: 10px 0;">${customersData.length}</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">إجمالي المشتريات</h4>
                        <h2 style="color: var(--product-color); margin: 10px 0;">${calculateTotalRevenue().toFixed(2)} ر.س</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">متوسط قيمة المشتريات</h4>
                        <h2 style="color: var(--success-color); margin: 10px 0;">${customersData.length > 0 ? (calculateTotalRevenue() / customersData.length).toFixed(2) : 0} ر.س</h2>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--header-bg);">أفضل 10 عملاء</h4>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم العميل</th>
                                <th>البريد الإلكتروني</th>
                                <th>الهاتف</th>
                                <th>عدد الطلبات</th>
                                <th>إجمالي المشتريات</th>
                                <th>متوسط قيمة الطلب</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedCustomers.slice(0, 10).forEach((customer, index) => {
                const avgOrder = (customer.totalOrders || 0) > 0 ? (customer.totalSpent || 0) / (customer.totalOrders || 1) : 0;
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${customer.name}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.totalOrders || 0}</td>
                        <td>${(customer.totalSpent || 0).toFixed(2)} ر.س</td>
                        <td>${avgOrder.toFixed(2)} ر.س</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function generateProductsReport(categoryId) {
            const filteredProducts = categoryId === 'all' ? productsData : 
                                   productsData.filter(p => p.categoryId == categoryId);
            
            let html = `
                <h3 style="color: var(--header-bg); margin-bottom: 20px;">تقرير المنتجات</h3>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الرمز</th>
                                <th>التصنيف</th>
                                <th>الكمية المباعة</th>
                                <th>الإيرادات</th>
                                <th>هامش الربح</th>
                                <th>معدل الدوران</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredProducts.forEach(product => {
                const category = categoriesData.find(c => c.id == product.categoryId);
                const salesData = getProductSalesData(product.id);
                const profitMargin = product.purchasePrice > 0 ? 
                    ((product.salePrice - product.purchasePrice) / product.purchasePrice * 100).toFixed(1) : 0;
                const turnoverRate = product.stockQuantity > 0 ? 
                    (salesData.quantity / product.stockQuantity).toFixed(2) : 0;
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.code}</td>
                        <td>${category ? category.name : 'غير مصنف'}</td>
                        <td>${salesData.quantity}</td>
                        <td>${salesData.revenue.toFixed(2)} ر.س</td>
                        <td>${profitMargin}%</td>
                        <td>${turnoverRate}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function generateOrdersReport(period) {
            const filteredOrders = filterOrdersByPeriod(ordersData, period);
            
            let html = `
                <h3 style="color: var(--header-bg); margin-bottom: 20px;">تقرير الطلبات</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">عدد الطلبات</h4>
                        <h2 style="color: var(--order-color); margin: 10px 0;">${filteredOrders.length}</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">إجمالي الإيرادات</h4>
                        <h2 style="color: var(--product-color); margin: 10px 0;">${filteredOrders.reduce((sum, order) => sum + order.total, 0).toFixed(2)} ر.س</h2>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--header-bg);">متوسط قيمة الطلب</h4>
                        <h2 style="color: var(--success-color); margin: 10px 0;">${filteredOrders.length > 0 ? (filteredOrders.reduce((sum, order) => sum + order.total, 0) / filteredOrders.length).toFixed(2) : 0} ر.س</h2>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--header-bg);">تفاصيل الطلبات</h4>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>التاريخ</th>
                                <th>عدد المنتجات</th>
                                <th>المجموع</th>
                                <th>حالة الدفع</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredOrders.forEach(order => {
                const customer = customersData.find(c => c.id == order.customerId);
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const statusClass = order.status === 'completed' ? 'completed' : 
                                   order.status === 'processing' ? 'processing' : 
                                   order.status === 'pending' ? 'pending' : 
                                   order.status === 'cancelled' ? 'cancelled' : 'shipped';
                const statusText = order.status === 'completed' ? 'مكتمل' : 
                                  order.status === 'processing' ? 'قيد المعالجة' : 
                                  order.status === 'pending' ? 'قيد الانتظار' : 
                                  order.status === 'cancelled' ? 'ملغي' : 'تم الشحن';
                
                html += `
                    <tr>
                        <td>${order.orderNumber}</td>
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${formatDate(order.orderDate)}</td>
                        <td>${totalItems}</td>
                        <td>${order.total.toFixed(2)} ر.س</td>
                        <td>${order.paymentMethod === 'cash' ? 'نقدي' : 
                              order.paymentMethod === 'credit' ? 'بطاقة ائتمان' : 
                              order.paymentMethod === 'bank' ? 'تحويل بنكي' : 'الدفع عند الاستلام'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function exportCurrentReport() {
            const reportType = document.getElementById('reportType').value;
            exportReport(reportType);
        }

        function exportReport(type) {
            showExportLoading('جاري تحضير التقرير...');
            
            setTimeout(() => {
                try {
                    switch(type) {
                        case 'orders':
                            exportOrdersToExcel();
                            break;
                        case 'products':
                            exportProductsToExcel();
                            break;
                        case 'customers':
                            exportCustomersToExcel();
                            break;
                        case 'pdf':
                            exportPDFReport();
                            break;
                        case 'sales':
                            exportSalesReport();
                            break;
                    }
                    hideExportLoading();
                } catch (error) {
                    hideExportLoading();
                    showError('فشل تصدير التقرير: ' + error.message);
                }
            }, 1000);
        }

        function exportOrdersToExcel() {
            const wsData = [
                ['رقم الطلب', 'العميل', 'التاريخ', 'الحالة', 'طريقة الدفع', 'عدد المنتجات', 'المجموع الفرعي', 'الضريبة', 'التوصيل', 'الإجمالي']
            ];
            
            ordersData.forEach(order => {
                const customer = customersData.find(c => c.id == order.customerId);
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const statusText = order.status === 'completed' ? 'مكتمل' : 
                                  order.status === 'processing' ? 'قيد المعالجة' : 
                                  order.status === 'pending' ? 'قيد الانتظار' : 
                                  order.status === 'cancelled' ? 'ملغي' : 'تم الشحن';
                
                wsData.push([
                    order.orderNumber,
                    customer ? customer.name : 'غير معروف',
                    order.orderDate,
                    statusText,
                    order.paymentMethod,
                    totalItems,
                    order.subtotal,
                    order.tax,
                    order.shippingCost,
                    order.total
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'الطلبات');
            
            const fileName = `الطلبات-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('تم تصدير بيانات الطلبات إلى Excel بنجاح');
        }

        function exportProductsToExcel() {
            const wsData = [
                ['اسم المنتج', 'الرمز', 'التصنيف', 'العلامة التجارية', 'سعر الشراء', 'سعر البيع', 'المخزون', 'الحد الأدنى', 'الحالة', 'قيمة المخزون']
            ];
            
            productsData.forEach(product => {
                const category = categoriesData.find(c => c.id == product.categoryId);
                const statusText = product.status === 'in-stock' ? 'متوفر' : 
                                  product.status === 'low-stock' ? 'منخفض' : 'نفذ';
                const stockValue = product.stockQuantity * product.purchasePrice;
                
                wsData.push([
                    product.name,
                    product.code,
                    category ? category.name : 'غير مصنف',
                    product.brand || '',
                    product.purchasePrice,
                    product.salePrice,
                    product.stockQuantity,
                    product.minStock,
                    statusText,
                    stockValue
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'المنتجات');
            
            const fileName = `المنتجات-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('تم تصدير بيانات المنتجات إلى Excel بنجاح');
        }

        function exportCustomersToExcel() {
            const wsData = [
                ['الاسم', 'البريد الإلكتروني', 'الهاتف', 'العنوان', 'المدينة', 'تاريخ الميلاد', 'عدد الطلبات', 'إجمالي المشتريات']
            ];
            
            customersData.forEach(customer => {
                wsData.push([
                    customer.name,
                    customer.email,
                    customer.phone,
                    customer.address || '',
                    customer.city || '',
                    customer.birthdate || '',
                    customer.totalOrders || 0,
                    customer.totalSpent || 0
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'العملاء');
            
            const fileName = `العملاء-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('تم تصدير بيانات العملاء إلى Excel بنجاح');
        }

        function exportSalesReport() {
            const wsData = [
                ['التاريخ', 'رقم الطلب', 'العميل', 'المنتجات', 'الكمية', 'الإيرادات', 'التكلفة', 'الربح']
            ];
            
            ordersData.forEach(order => {
                const customer = customersData.find(c => c.id == order.customerId);
                
                order.items.forEach(item => {
                    const product = productsData.find(p => p.id == item.productId);
                    if (product) {
                        const cost = item.quantity * product.purchasePrice;
                        const revenue = item.quantity * item.price;
                        const profit = revenue - cost;
                        
                        wsData.push([
                            order.orderDate,
                            order.orderNumber,
                            customer ? customer.name : 'غير معروف',
                            product.name,
                            item.quantity,
                            revenue,
                            cost,
                            profit
                        ]);
                    }
                });
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'المبيعات');
            
            const fileName = `المبيعات-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('تم تصدير تقرير المبيعات إلى Excel بنجاح');
        }

        function exportPDFReport() {
            const element = document.getElementById('reportContent');
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `تقرير-المتجر-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
            showSuccess('تم تصدير التقرير كـ PDF بنجاح');
        }

        function printReport() {
            const printContent = document.getElementById('reportContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div dir="rtl" style="padding: 20px; font-family: 'Cairo', sans-serif;">
                    <h1 style="text-align: center; color: var(--header-bg); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                        🛒 تقرير نظام إدارة المتجر
                    </h1>
                    <div style="margin-top: 20px;">
                        ${printContent}
                    </div>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p>عدد المنتجات: ${productsData.length} | عدد العملاء: ${customersData.length} | عدد الطلبات: ${ordersData.length}</p>
                    </div>
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        function closeReportsModal() {
            document.getElementById('reportsModal').classList.remove('active');
        }

        // ============================================
        // دوال المساعدة والأدوات
        // ============================================

        function updateStats() {
            document.getElementById('totalOrders').textContent = ordersData.length;
            document.getElementById('totalProducts').textContent = productsData.length;
            document.getElementById('totalCustomers').textContent = customersData.length;
            document.getElementById('totalRevenue').textContent = calculateTotalRevenue().toFixed(2) + ' ر.س';
            document.getElementById('pendingOrders').textContent = countOrdersByStatus('pending');
            document.getElementById('totalCategories').textContent = categoriesData.length;
        }

        function updateRecentData() {
            // تحديث الرسوم البيانية
            updateDashboardCharts();
        }

        function updateDashboardCharts() {
            const period = document.getElementById('chartPeriod') ? document.getElementById('chartPeriod').value : 'week';
            const ctx = document.getElementById('salesChart');
            
            if (!ctx) return;
            
            const filteredOrders = filterOrdersByPeriod(ordersData, period);
            const salesData = aggregateSalesByDate(filteredOrders, period);
            
            // إذا كان هناك مخطط قديم، قم بتدميره أولاً
            if (window.salesChart instanceof Chart) {
                window.salesChart.destroy();
            }
            
            window.salesChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: salesData.labels,
                    datasets: [{
                        label: 'الإيرادات',
                        data: salesData.values,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ر.س';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getTopProductsHTML() {
            const topProducts = getTopProducts(3);
            
            if (topProducts.length === 0) {
                return '<p style="text-align: center; color: #666;">لا توجد بيانات مبيعات</p>';
            }
            
            let html = '<div class="product-cards">';
            
            topProducts.forEach(product => {
                html += `
                    <div class="product-card">
                        <div class="product-header">
                            <div>
                                <h3 class="product-name">${product.name}</h3>
                                <span class="product-code">${product.code}</span>
                            </div>
                            <span class="price-tag">${product.revenue.toFixed(2)} ر.س</span>
                        </div>
                        
                        <div class="product-details">
                            <div class="detail-row">
                                <span class="detail-label">الكمية المباعة:</span>
                                <span class="detail-value">${product.quantitySold}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">الإيرادات:</span>
                                <span class="detail-value">${product.revenue.toFixed(2)} ر.س</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">هامش الربح:</span>
                                <span class="detail-value">${product.margin}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function getRecentCustomersHTML() {
            const recentCustomers = customersData.slice(-5).reverse();
            
            if (recentCustomers.length === 0) {
                return '<tr><td colspan="5" style="text-align: center; color: #666;">لا توجد عملاء</td></tr>';
            }
            
            let html = '';
            recentCustomers.forEach(customer => {
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.totalOrders || 0}</td>
                        <td class="table-actions">
                            <button class="action-btn view" onclick="viewCustomerDetails('${customer.id}')" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditCustomerForm('${customer.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function getRecentOrdersHTML() {
            const recentOrders = ordersData.slice(-10).reverse();
            
            if (recentOrders.length === 0) {
                return '<tr><td colspan="6" style="text-align: center; color: #666;">لا توجد طلبات</td></tr>';
            }
            
            let html = '';
            recentOrders.forEach(order => {
                const customer = customersData.find(c => c.id == order.customerId);
                const statusClass = order.status === 'completed' ? 'completed' : 
                                   order.status === 'processing' ? 'processing' : 
                                   order.status === 'pending' ? 'pending' : 
                                   order.status === 'cancelled' ? 'cancelled' : 'shipped';
                const statusText = order.status === 'completed' ? 'مكتمل' : 
                                  order.status === 'processing' ? 'قيد المعالجة' : 
                                  order.status === 'pending' ? 'قيد الانتظار' : 
                                  order.status === 'cancelled' ? 'ملغي' : 'تم الشحن';
                
                html += `
                    <tr>
                        <td>${order.orderNumber}</td>
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${formatDate(order.orderDate)}</td>
                        <td>${order.total.toFixed(2)} ر.س</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="table-actions">
                            <button class="action-btn view" onclick="viewOrderDetails('${order.id}')" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditOrderForm('${order.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteOrder('${order.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function getProductsTableHTML() {
            if (productsData.length === 0) {
                return '<tr><td colspan="10" style="text-align: center; color: #666;">لا توجد منتجات</td></tr>';
            }
            
            let html = '';
            productsData.forEach(product => {
                const category = categoriesData.find(c => c.id == product.categoryId);
                const statusClass = product.status === 'in-stock' ? 'success' : 
                                   product.status === 'low-stock' ? 'warning' : 'danger';
                const statusText = product.status === 'in-stock' ? 'متوفر' : 
                                  product.status === 'low-stock' ? 'منخفض' : 'نفذ';
                
                html += `
                    <tr>
                        <td>${product.id.substring(0, 8)}...</td>
                        <td>
                            ${product.images ? 
                                `<img src="${product.images.split(',')[0]}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 
                                '<div style="width: 50px; height: 50px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-box"></i></div>'
                            }
                        </td>
                        <td>${product.name}</td>
                        <td>${product.code}</td>
                        <td>${category ? category.name : 'غير مصنف'}</td>
                        <td>${product.brand || '-'}</td>
                        <td>${product.salePrice} ر.س</td>
                        <td>${product.stockQuantity}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="table-actions">
                            <button class="action-btn view" onclick="viewProductDetails('${product.id}')" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditProductForm('${product.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn stock" onclick="restockProduct('${product.id}')" title="إعادة تخزين">
                                <i class="fas fa-boxes"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${product.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function getCategoriesGridHTML() {
            if (categoriesData.length === 0) {
                return '<p style="text-align: center; color: #666;">لا توجد تصنيفات</p>';
            }
            
            let html = '';
            categoriesData.forEach(category => {
                const productCount = productsData.filter(p => p.categoryId == category.id).length;
                
                html += `
                    <div class="product-card">
                        <div class="product-header">
                            <div>
                                <h3 class="product-name">${category.name}</h3>
                            </div>
                            <span class="product-code">${productCount} منتج</span>
                        </div>
                        
                        <div class="product-details">
                            <div class="detail-row">
                                <span class="detail-label">الوصف:</span>
                                <span class="detail-value">${category.description || 'لا يوجد وصف'}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="showProductsInCategory('${category.id}')">
                                <i class="fas fa-eye"></i> عرض المنتجات
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function getOrdersTableHTML() {
            if (ordersData.length === 0) {
                return '<tr><td colspan="8" style="text-align: center; color: #666;">لا توجد طلبات</td></tr>';
            }
            
            let html = '';
            ordersData.forEach(order => {
                const customer = customersData.find(c => c.id == order.customerId);
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const statusClass = order.status === 'completed' ? 'completed' : 
                                   order.status === 'processing' ? 'processing' : 
                                   order.status === 'pending' ? 'pending' : 
                                   order.status === 'cancelled' ? 'cancelled' : 'shipped';
                const statusText = order.status === 'completed' ? 'مكتمل' : 
                                  order.status === 'processing' ? 'قيد المعالجة' : 
                                  order.status === 'pending' ? 'قيد الانتظار' : 
                                  order.status === 'cancelled' ? 'ملغي' : 'تم الشحن';
                
                html += `
                    <tr>
                        <td>${order.orderNumber}</td>
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${formatDate(order.orderDate)}</td>
                        <td>${totalItems}</td>
                        <td>${order.total.toFixed(2)} ر.س</td>
                        <td>${order.paymentMethod === 'cash' ? 'نقدي' : 
                              order.paymentMethod === 'credit' ? 'بطاقة ائتمان' : 
                              order.paymentMethod === 'bank' ? 'تحويل بنكي' : 'الدفع عند الاستلام'}</td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <select class="form-select" style="display: none; width: 120px;" id="statusSelect-${order.id}">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>قيد المعالجة</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>تم الشحن</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ملغي</option>
                            </select>
                        </td>
                        <td class="table-actions">
                            <button class="action-btn view" onclick="viewOrderDetails('${order.id}')" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditOrderForm('${order.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn edit" onclick="toggleStatusSelect('${order.id}')" title="تغيير الحالة">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteOrder('${order.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function toggleStatusSelect(orderId) {
            const badge = document.querySelector(`#statusSelect-${orderId}`).previousElementSibling;
            const select = document.getElementById(`statusSelect-${orderId}`);
            
            if (badge.style.display !== 'none') {
                badge.style.display = 'none';
                select.style.display = 'inline-block';
                select.focus();
            } else {
                select.style.display = 'none';
                badge.style.display = 'inline-block';
                
                // تحديث حالة الطلب إذا تغيرت
                const newStatus = select.value;
                const badgeText = newStatus === 'completed' ? 'مكتمل' : 
                                 newStatus === 'processing' ? 'قيد المعالجة' : 
                                 newStatus === 'pending' ? 'قيد الانتظار' : 
                                 newStatus === 'cancelled' ? 'ملغي' : 'تم الشحن';
                const badgeClass = newStatus === 'completed' ? 'completed' : 
                                   newStatus === 'processing' ? 'processing' : 
                                   newStatus === 'pending' ? 'pending' : 
                                   newStatus === 'cancelled' ? 'cancelled' : 'shipped';
                
                badge.textContent = badgeText;
                badge.className = `status-badge ${badgeClass}`;
                
                updateOrderStatus(orderId, newStatus);
            }
        }

        function getCustomersTableHTML() {
            if (customersData.length === 0) {
                return '<tr><td colspan="8" style="text-align: center; color: #666;">لا توجد عملاء</td></tr>';
            }
            
            let html = '';
            customersData.forEach(customer => {
                html += `
                    <tr>
                        <td>${customer.id.substring(0, 8)}...</td>
                        <td>${customer.name}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.city || '-'}</td>
                        <td>${customer.totalOrders || 0}</td>
                        <td>${(customer.totalSpent || 0).toFixed(2)} ر.س</td>
                        <td class="table-actions">
                            <button class="action-btn view" onclick="viewCustomerDetails('${customer.id}')" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="showEditCustomerForm('${customer.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function getInventoryStatsHTML() {
            let totalValue = 0;
            let inStockValue = 0;
            let lowStockValue = 0;
            let outOfStockValue = 0;
            
            productsData.forEach(product => {
                const value = product.stockQuantity * product.purchasePrice;
                totalValue += value;
                
                if (product.status === 'in-stock') inStockValue += value;
                else if (product.status === 'low-stock') lowStockValue += value;
                else outOfStockValue += value;
            });
            
            const inStockPercent = totalValue > 0 ? (inStockValue / totalValue * 100).toFixed(1) : 0;
            const lowStockPercent = totalValue > 0 ? (lowStockValue / totalValue * 100).toFixed(1) : 0;
            const outOfStockPercent = totalValue > 0 ? (outOfStockValue / totalValue * 100).toFixed(1) : 0;
            
            return `
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--product-color);">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stock-info">
                        <h4>قيمة المخزون الإجمالية</h4>
                        <p>${totalValue.toFixed(2)} ر.س</p>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--success-color);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stock-info">
                        <h4>متوفر في المخزون</h4>
                        <p>${inStockValue.toFixed(2)} ر.س (${inStockPercent}%)</p>
                        <div class="stock-progress">
                            <div class="progress-bar high" style="width: ${inStockPercent}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--warning-color);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stock-info">
                        <h4>منخفض المخزون</h4>
                        <p>${lowStockValue.toFixed(2)} ر.س (${lowStockPercent}%)</p>
                        <div class="stock-progress">
                            <div class="progress-bar medium" style="width: ${lowStockPercent}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--danger-color);">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stock-info">
                        <h4>نفاذ المخزون</h4>
                        <p>${outOfStockValue.toFixed(2)} ر.س (${outOfStockPercent}%)</p>
                        <div class="stock-progress">
                            <div class="progress-bar low" style="width: ${outOfStockPercent}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getInventoryTableHTML() {
            if (productsData.length === 0) {
                return '<tr><td colspan="9" style="text-align: center; color: #666;">لا توجد منتجات في المخزون</td></tr>';
            }
            
            let html = '';
            productsData.forEach(product => {
                const category = categoriesData.find(c => c.id == product.categoryId);
                const statusClass = product.status === 'in-stock' ? 'success' : 
                                   product.status === 'low-stock' ? 'warning' : 'danger';
                const statusText = product.status === 'in-stock' ? 'متوفر' : 
                                  product.status === 'low-stock' ? 'منخفض' : 'نفذ';
                const stockValue = product.stockQuantity * product.purchasePrice;
                
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.code}</td>
                        <td>${product.stockQuantity}</td>
                        <td>${product.minStock}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${product.purchasePrice} ر.س</td>
                        <td>${product.salePrice} ر.س</td>
                        <td>${stockValue.toFixed(2)} ر.س</td>
                        <td class="table-actions">
                            <button class="action-btn edit" onclick="showEditProductForm('${product.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn stock" onclick="restockProduct('${product.id}')" title="إعادة تخزين">
                                <i class="fas fa-boxes"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            return html;
        }

        function getCouponsGridHTML() {
            if (couponsData.length === 0) {
                return '<p style="text-align: center; color: #666;">لا توجد كوبونات</p>';
            }
            
            let html = '';
            couponsData.forEach(coupon => {
                const usagePercent = coupon.usageLimit > 0 ? (coupon.usedCount / coupon.usageLimit * 100).toFixed(1) : 0;
                const discountText = coupon.discountType === 'percentage' ? 
                    `${coupon.discountValue}%` : `${coupon.discountValue} ر.س`;
                
                html += `
                    <div class="product-card">
                        <div class="product-header">
                            <div>
                                <h3 class="product-name">${coupon.code}</h3>
                                <span class="product-code">خصم ${discountText}</span>
                            </div>
                            <span class="status-badge ${coupon.status === 'active' ? 'completed' : 'cancelled'}">${coupon.status === 'active' ? 'نشط' : 'منتهي'}</span>
                        </div>
                        
                        <div class="product-details">
                            <div class="detail-row">
                                <span class="detail-label">الاستخدام:</span>
                                <span class="detail-value">${coupon.usedCount} / ${coupon.usageLimit}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">الحد الأدنى للشراء:</span>
                                <span class="detail-value">${coupon.minPurchase} ر.س</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">تاريخ الانتهاء:</span>
                                <span class="detail-value">${formatDate(coupon.endDate)}</span>
                            </div>
                        </div>
                        
                        <div class="stock-progress" style="margin-top: 10px;">
                            <div class="progress-bar ${usagePercent > 80 ? 'low' : usagePercent > 50 ? 'medium' : 'high'}" style="width: ${usagePercent}%"></div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-danger" onclick="deleteCoupon('${coupon.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function showProductsInCategory(categoryId) {
            const productsInCategory = productsData.filter(p => p.categoryId == categoryId);
            const category = categoriesData.find(c => c.id == categoryId);
            
            if (productsInCategory.length === 0) {
                alert(`لا توجد منتجات في تصنيف "${category ? category.name : 'غير مصنف'}"`);
                return;
            }
            
            let message = `المنتجات في تصنيف "${category ? category.name : 'غير مصنف'}":\n\n`;
            
            productsInCategory.forEach(product => {
                const status = product.status === 'in-stock' ? '✅' : 
                              product.status === 'low-stock' ? '⚠️' : '❌';
                message += `${status} ${product.name}: ${product.stockQuantity} / ${product.minStock} (${product.salePrice} ر.س)\n`;
            });
            
            alert(message);
        }

        function viewOrderDetails(id) {
            const order = ordersData.find(o => o.id == id);
            if (!order) return;
            
            const customer = customersData.find(c => c.id == order.customerId);
            const statusText = order.status === 'completed' ? 'مكتمل' : 
                              order.status === 'processing' ? 'قيد المعالجة' : 
                              order.status === 'pending' ? 'قيد الانتظار' : 
                              order.status === 'cancelled' ? 'ملغي' : 'تم الشحن';
            
            let message = `تفاصيل الطلب #${order.orderNumber}:\n\n`;
            message += `العميل: ${customer ? customer.name : 'غير معروف'}\n`;
            message += `التاريخ: ${formatDate(order.orderDate)}\n`;
            message += `الحالة: ${statusText}\n`;
            message += `طريقة الدفع: ${order.paymentMethod === 'cash' ? 'نقدي' : 
                        order.paymentMethod === 'credit' ? 'بطاقة ائتمان' : 
                        order.paymentMethod === 'bank' ? 'تحويل بنكي' : 'الدفع عند الاستلام'}\n`;
            message += `عنوان الشحن: ${order.shippingAddress}\n`;
            message += `ملاحظات: ${order.notes || 'لا توجد'}\n\n`;
            message += `المنتجات:\n`;
            
            order.items.forEach(item => {
                const product = productsData.find(p => p.id == item.productId);
                if (product) {
                    message += `• ${product.name}: ${item.quantity} × ${item.price} ر.س = ${(item.quantity * item.price).toFixed(2)} ر.س\n`;
                }
            });
            
            message += `\nالمجموع الفرعي: ${order.subtotal.toFixed(2)} ر.س\n`;
            message += `التوصيل: ${order.shippingCost.toFixed(2)} ر.س\n`;
            message += `الضريبة: ${order.tax.toFixed(2)} ر.س\n`;
            message += `الخصم: ${order.discount.toFixed(2)} ر.س\n`;
            message += `الإجمالي: ${order.total.toFixed(2)} ر.س`;
            
            alert(message);
        }

        function viewCustomerDetails(id) {
            const customer = customersData.find(c => c.id == id);
            if (!customer) return;
            
            const customerOrders = ordersData.filter(o => o.customerId == id);
            const totalSpent = customerOrders.reduce((sum, order) => sum + order.total, 0);
            
            let message = `تفاصيل العميل:\n\n`;
            message += `الاسم: ${customer.name}\n`;
            message += `البريد الإلكتروني: ${customer.email}\n`;
            message += `الهاتف: ${customer.phone}\n`;
            message += `العنوان: ${customer.address || 'غير محدد'}\n`;
            message += `المدينة: ${customer.city || 'غير محدد'}\n`;
            message += `تاريخ الميلاد: ${customer.birthdate || 'غير محدد'}\n`;
            message += `عدد الطلبات: ${customerOrders.length}\n`;
            message += `إجمالي المشتريات: ${totalSpent.toFixed(2)} ر.س\n`;
            message += `متوسط قيمة الطلب: ${customerOrders.length > 0 ? (totalSpent / customerOrders.length).toFixed(2) : 0} ر.س\n`;
            message += `ملاحظات: ${customer.notes || 'لا توجد'}\n`;
            
            alert(message);
        }

        function showAddShippingMethod() {
            alert('ميزة إضافة طرق الشحن قيد التطوير');
        }

        // ============================================
        // دوال الحسابات والإحصائيات
        // ============================================

        function calculateTotalRevenue() {
            return ordersData.reduce((sum, order) => sum + order.total, 0);
        }

        function countOrdersByStatus(status) {
            return ordersData.filter(order => order.status === status).length;
        }

        function calculateStockStatus(quantity, minStock) {
            if (quantity <= 0) return 'out-of-stock';
            if (quantity <= minStock) return 'low-stock';
            return 'in-stock';
        }

        function updateProductStockStatus() {
            // تمت المعالجة أثناء حفظ البيانات
        }

        function getTopProducts(limit = 5, period = 'all') {
            const filteredOrders = filterOrdersByPeriod(ordersData, period);
            const productSales = {};
            
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = {
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[item.productId].quantity += item.quantity;
                    productSales[item.productId].revenue += item.quantity * item.price;
                });
            });
            
            const productsWithSales = productsData
                .map(product => {
                    const sales = productSales[product.id] || { quantity: 0, revenue: 0 };
                    const margin = product.purchasePrice > 0 ? 
                        ((product.salePrice - product.purchasePrice) / product.purchasePrice * 100).toFixed(1) : 0;
                    
                    return {
                        ...product,
                        quantitySold: sales.quantity,
                        revenue: sales.revenue,
                        margin: margin
                    };
                })
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, limit);
            
            return productsWithSales;
        }

        function getProductSalesData(productId) {
            let quantity = 0;
            let revenue = 0;
            
            ordersData.forEach(order => {
                order.items.forEach(item => {
                    if (item.productId == productId) {
                        quantity += item.quantity;
                        revenue += item.quantity * item.price;
                    }
                });
            });
            
            return { quantity, revenue };
        }

        function filterOrdersByPeriod(orders, period) {
            const now = new Date();
            let startDate = new Date();
            
            switch(period) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'quarter':
                    startDate.setMonth(now.getMonth() - 3);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
                case 'all':
                    return orders; // جميع الطلبات
                default:
                    startDate.setDate(now.getDate() - 7); // أسبوع افتراضي
            }
            
            return orders.filter(order => {
                const orderDate = new Date(order.orderDate);
                return orderDate >= startDate;
            });
        }

        function aggregateSalesByDate(orders, period) {
            const salesByDate = {};
            const labels = [];
            const values = [];
            
            orders.forEach(order => {
                let dateKey;
                const orderDate = new Date(order.orderDate);
                
                switch(period) {
                    case 'today':
                        dateKey = orderDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                        break;
                    case 'week':
                    case 'month':
                        dateKey = orderDate.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
                        break;
                    case 'year':
                        dateKey = orderDate.toLocaleDateString('ar-EG', { month: 'long' });
                        break;
                    default:
                        dateKey = orderDate.toLocaleDateString('ar-EG');
                }
                
                if (!salesByDate[dateKey]) {
                    salesByDate[dateKey] = 0;
                }
                
                salesByDate[dateKey] += order.total;
            });
            
            // فرز التواريخ
            const sortedDates = Object.keys(salesByDate).sort((a, b) => {
                // تحويل التواريخ إلى صيغة قابلة للمقارنة
                return new Date(a) - new Date(b);
            });
            
            // إذا لم يكن هناك تواريخ، نضيف بيانات افتراضية
            if (sortedDates.length === 0) {
                labels.push('لا توجد بيانات');
                values.push(0);
            } else {
                sortedDates.forEach(date => {
                    labels.push(date);
                    values.push(salesByDate[date]);
                });
            }
            
            return { labels, values };
        }

        function populateCategorySelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">اختر التصنيف</option>';
            
            categoriesData.forEach(category => {
                select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG');
            } catch (error) {
                return dateString;
            }
        }

        function showSuccess(message) {
            // إذا كانت شاشة الدخول ظاهرة، تنبيهات الصفحة قد تكون خلفها => استخدم alert المتصفح
            const loginScreen = document.getElementById('login-screen');
            const loginVisible = loginScreen && getComputedStyle(loginScreen).display !== 'none';

            const alertEl = document.getElementById('successAlert');
            const messageElement = document.getElementById('successMessage');

            if (!loginVisible && alertEl && messageElement) {
                messageElement.textContent = message;
                alertEl.style.display = 'flex';

                setTimeout(() => {
                    alertEl.style.display = 'none';
                }, 3000);
            } else {
                window.alert(`✅ ${message}`);
            }
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            const messageElement = document.getElementById('errorMessage');
            
            if (alert && messageElement) {
                messageElement.textContent = message;
                alert.style.display = 'flex';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            } else {
                alert(`❌ ${message}`);
            }
        }

        function showWarning(message) {
            alert(`⚠️ ${message}`);
        }

        function showInfo(message) {
            alert(`ℹ️ ${message}`);
        }

        async function refreshData() {
            await loadDataFromFirestore();
            showSuccess('تم تحديث البيانات بنجاح');
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            if (menu) {
                menu.classList.toggle('show');
                
                setTimeout(() => {
                    const closeMenuHandler = function(e) {
                        if (!menu.contains(e.target) && !e.target.closest('.export-options')) {
                            menu.classList.remove('show');
                            document.removeEventListener('click', closeMenuHandler);
                        }
                    };
                    document.addEventListener('click', closeMenuHandler);
                }, 10);
            }
        }

        function showExportLoading(message) {
            const loading = document.getElementById('exportLoading');
            const messageElement = document.getElementById('exportLoadingText');
            
            if (loading && messageElement) {
                messageElement.textContent = message;
                loading.classList.add('active');
            }
        }

        function hideExportLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }

        
/* تم حذف تكرار الدالة closeSignupForm لتجنب التعارض */

document.addEventListener('DOMContentLoaded', function() {
    // ... الكود الحالي ...
});

        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                document.addEventListener('click', function(event) {
                    if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target) && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            }
            
            // تعيين تاريخ اليوم في حقول التاريخ
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // إخفاء نموذج التسجيل افتراضياً
            document.getElementById('signupFormModal').classList.remove('active');
            
            // التحقق من حالة تسجيل الدخول
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // المستخدم مسجل الدخول
                    currentUser = user;
                    console.log('User is signed in:', user.email);
                    
                    // الحصول على بيانات المستخدم الإضافية
                    db.collection('users').doc(user.uid).get().then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            document.getElementById('loggedInUser').textContent = userData.name;
                        }
                    });
                } else {
                    // المستخدم غير مسجل الدخول
                    currentUser = null;
                    console.log('User is signed out');
                }
            });
        });
    </script>
</body>
</html>