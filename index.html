<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>نظام إدارة المتجر الإلكتروني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK للتخزين السحابي للمصادقة فقط -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- المكتبات الأخرى -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* متغيرات الألوان للنظام التجاري - تصميم عصري */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            
            --bg-dark: #0f172a;
            --bg-card: #ffffff;
            --bg-light: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* قيمة العملة - جنيه مصري */
            --currency-symbol: "ج.م";
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Tajawal', sans-serif;
        }
        
        body {
            background-color: #f1f5f9;
            direction: rtl;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* شاشة الدخول الحديثة */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 420px;
            text-align: center;
            animation: fadeInUp 0.6s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-logo {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-title {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .login-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
            transition: all 0.3s;
            background-color: var(--bg-light);
            font-weight: 500;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background-color: white;
        }
        
        .login-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* التصميم العصري للجوال - يشبه التطبيقات */
        .mobile-app-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f8fafc;
        }
        
        /* الهيدر السفلي للجوال - يشبه تطبيقات الجوال */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            border-radius: 25px 25px 0 0;
            padding: 10px 5px;
            z-index: 1000;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            transition: all 0.2s;
            cursor: pointer;
            flex: 1;
        }
        
        .mobile-nav-item i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        
        .mobile-nav-item span {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .mobile-nav-item.active {
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* زر القائمة العائم - FAB */
        .fab-button {
            position: fixed;
            bottom: 85px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s;
            border: 2px solid white;
        }
        
        .fab-button:hover {
            transform: scale(1.1);
        }
        
        /* بطاقات الإحصائيات الحديثة */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card-modern {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .stat-card-modern:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon-modern {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            background: var(--primary-gradient);
        }
        
        .stat-info-modern h3 {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .stat-info-modern p {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* بطاقات المنتجات العصرية */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card-modern {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .product-card-modern:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .product-image-container {
            position: relative;
            height: 200px;
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.5s;
        }
        
        .product-card-modern:hover .product-image-container img {
            transform: scale(1.05);
        }
        
        .product-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            z-index: 10;
        }
        
        .badge-in-stock { background: var(--success-gradient); }
        .badge-low-stock { background: var(--warning-gradient); }
        .badge-out-of-stock { background: var(--danger-gradient); }
        
        .product-info {
            padding: 20px;
        }
        
        .product-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .product-code {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .product-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .product-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        
        .product-price::after {
            content: " ج.م";
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .product-stock {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* الجداول الحديثة */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
        }
        
        .modern-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .modern-table th {
            text-align: right;
            padding: 16px 12px;
            background: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modern-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .modern-table tr:hover {
            background: var(--bg-light);
        }
        
        /* أزرار العمل الحديثة */
        .action-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-modern {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            background: var(--primary-gradient);
        }
        
        .btn-modern-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-modern-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
        }
        
        /* الفلاتر والبحث */
        .search-bar-modern {
            background: white;
            border-radius: var(--radius-full);
            padding: 4px;
            display: flex;
            align-items: center;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .search-bar-modern i {
            padding: 0 16px;
            color: var(--text-muted);
        }
        
        .search-bar-modern input {
            flex: 1;
            padding: 12px 0;
            border: none;
            background: transparent;
            font-size: 0.95rem;
        }
        
        .search-bar-modern input:focus {
            outline: none;
        }
        
        .search-bar-modern button {
            padding: 10px 24px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* تصميم الشريط الجانبي للجوال */
        .mobile-sidebar {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            z-index: 2000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-xl);
            overflow-y: auto;
        }
        
        .mobile-sidebar.active {
            right: 0;
        }
        
        .mobile-sidebar-header {
            padding: 24px 20px;
            background: var(--primary-gradient);
            color: white;
        }
        
        .mobile-sidebar-menu {
            list-style: none;
            padding: 16px;
        }
        
        .mobile-sidebar-item {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mobile-sidebar-item i {
            width: 24px;
            color: var(--primary-color);
        }
        
        .mobile-sidebar-item:hover {
            background: var(--bg-light);
        }
        
        .mobile-sidebar-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }
        
        /* تنسيق العملة - جنيه مصري */
        .currency-egp {
            font-weight: 700;
        }
        
        .currency-egp::after {
            content: " ج.م";
            font-size: 0.9em;
            margin-right: 2px;
        }
        
        .price-tag-egp {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
        }
        
        .price-tag-egp::after {
            content: " ج.م";
            font-size: 0.8em;
            margin-right: 4px;
        }
        
        /* تحسينات للجوال */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content-area {
                margin-right: 0;
                width: 100%;
                padding: 16px;
                padding-bottom: 90px;
            }
            
            .mobile-bottom-nav {
                display: block;
            }
            
            .fab-button {
                display: flex;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .stat-card-modern {
                padding: 16px;
            }
            
            .stat-icon-modern {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
            
            .stat-info-modern h3 {
                font-size: 1.3rem;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: stretch;
            }
            
            .btn-modern {
                flex: 1;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-container {
                padding: 30px 20px;
            }
            
            .login-title {
                font-size: 1.5rem;
            }
            
            .product-image-container {
                height: 160px;
            }
        }
        
        /* أنيميشنات */
        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease;
        }
        
        /* شاشة التحميل */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل الحديثة -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div id="loadingText" style="font-size: 1.2rem; font-weight: 600;">جاري التحميل...</div>
    </div>

    <!-- زر القائمة العائم (FAB) للجوال -->
    <div class="fab-button" id="fabButton">
        <i class="fas fa-plus"></i>
    </div>

    <!-- القائمة الجانبية للجوال -->
    <div class="mobile-sidebar" id="mobileSidebar">
        <div class="mobile-sidebar-header">
            <i class="fas fa-store" style="font-size: 2rem; margin-bottom: 16px;"></i>
            <h3 style="margin-bottom: 8px;">نظام إدارة المتجر</h3>
            <p style="opacity: 0.9; font-size: 0.9rem;" id="mobileUserEmail">مستخدم</p>
        </div>
        <ul class="mobile-sidebar-menu">
            <li class="mobile-sidebar-item active" onclick="showDashboard(); closeMobileSidebar()">
                <i class="fas fa-home"></i> الرئيسية
            </li>
            <li class="mobile-sidebar-item" onclick="showProducts(); closeMobileSidebar()">
                <i class="fas fa-box"></i> المنتجات
            </li>
            <li class="mobile-sidebar-item" onclick="showCategories(); closeMobileSidebar()">
                <i class="fas fa-tags"></i> التصنيفات
            </li>
            <li class="mobile-sidebar-item" onclick="showOrders(); closeMobileSidebar()">
                <i class="fas fa-shopping-cart"></i> الطلبات
            </li>
            <li class="mobile-sidebar-item" onclick="showCustomers(); closeMobileSidebar()">
                <i class="fas fa-users"></i> العملاء
            </li>
            <li class="mobile-sidebar-item" onclick="showInventory(); closeMobileSidebar()">
                <i class="fas fa-warehouse"></i> المخزون
            </li>
            <li class="mobile-sidebar-item" onclick="showReports(); closeMobileSidebar()">
                <i class="fas fa-chart-bar"></i> التقارير
            </li>
            <li class="mobile-sidebar-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </li>
        </ul>
    </div>

    <!-- شاشة الدخول -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-store"></i>
            </div>
            <h2 class="login-title">متجري</h2>
            <p class="login-subtitle">نظام إدارة المتجر الإلكتروني المتطور</p>
            
            <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="username" class="login-input" placeholder="البريد الإلكتروني" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="login-input" placeholder="كلمة المرور" required>
                </div>
                
                <div class="login-error" id="loginError" style="display: none; color: var(--danger-color); padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage">خطأ في تسجيل الدخول</span>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> <span>دخول</span>
                </button>
            </form>
            
            <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                <a href="javascript:void(0);" onclick="showSignupForm()" style="color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 0.9rem;">
                    <i class="fas fa-user-plus"></i> إنشاء حساب
                </a>
                <a href="javascript:void(0);" onclick="handlePasswordReset()" style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem;">
                    <i class="fas fa-key"></i> نسيت كلمة المرور؟
                </a>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div id="main-content" style="display: none;">
        <!-- الهيدر -->
        <div style="background: white; box-shadow: var(--shadow-sm); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <i class="fas fa-bars" style="font-size: 1.5rem; color: var(--text-primary); display: none; cursor: pointer;" id="menuToggle"></i>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-store" style="color: var(--primary-color); font-size: 1.8rem;"></i>
                    <h1 style="font-size: 1.3rem; font-weight: 800; color: var(--text-primary);">متجري</h1>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: var(--text-secondary); font-weight: 600;" id="loggedInUser">مستخدم</span>
                <button onclick="logout()" style="background: none; border: none; color: var(--danger-color); font-size: 1.2rem; cursor: pointer;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- الشريط الجانبي للويب -->
        <div class="sidebar" id="sidebar" style="background: white; box-shadow: var(--shadow-md); width: 260px; top: 80px;">
            <ul class="sidebar-menu" style="padding: 20px 0;">
                <li class="menu-item" onclick="showDashboard()">
                    <i class="fas fa-home"></i> الرئيسية
                </li>
                <li class="menu-item" onclick="showProducts()">
                    <i class="fas fa-box"></i> المنتجات
                </li>
                <li class="menu-item" onclick="showCategories()">
                    <i class="fas fa-tags"></i> التصنيفات
                </li>
                <li class="menu-item" onclick="showOrders()">
                    <i class="fas fa-shopping-cart"></i> الطلبات
                </li>
                <li class="menu-item" onclick="showCustomers()">
                    <i class="fas fa-users"></i> العملاء
                </li>
                <li class="menu-item" onclick="showInventory()">
                    <i class="fas fa-warehouse"></i> المخزون
                </li>
                <li class="menu-item" onclick="showAdvancedSearch()">
                    <i class="fas fa-search"></i> البحث المتقدم
                </li>
                <li class="menu-item" onclick="showReports()">
                    <i class="fas fa-chart-bar"></i> التقارير
                </li>
                <li class="menu-item" onclick="showBackupRestore()">
                    <i class="fas fa-database"></i> النسخ الاحتياطي
                </li>
            </ul>
        </div>

        <!-- القائمة السفلية للجوال - تصميم تطبيق -->
        <div class="mobile-bottom-nav">
            <div class="mobile-nav-items">
                <div class="mobile-nav-item active" onclick="showDashboard(); setActiveMobileNav(0)">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="mobile-nav-item" onclick="showProducts(); setActiveMobileNav(1)">
                    <i class="fas fa-box"></i>
                    <span>المنتجات</span>
                </div>
                <div class="mobile-nav-item" onclick="showOrders(); setActiveMobileNav(2)">
                    <i class="fas fa-shopping-cart"></i>
                    <span>الطلبات</span>
                </div>
                <div class="mobile-nav-item" onclick="showCustomers(); setActiveMobileNav(3)">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </div>
                <div class="mobile-nav-item" onclick="showInventory(); setActiveMobileNav(4)">
                    <i class="fas fa-warehouse"></i>
                    <span>المخزون</span>
                </div>
            </div>
        </div>

        <!-- منطقة المحتوى الرئيسي -->
        <div class="main-content-area" id="contentArea"></div>
    </div>

    <!-- باقي النماذج بنفس الهيكل ولكن مع تحديث العملة إلى جنيه -->

    <script>
        // ============================================
        // تعريف العملة - جنيه مصري
        // ============================================
        const CURRENCY_SYMBOL = 'ج.م';
        const CURRENCY_CODE = 'EGP';

        // دالة تنسيق العملة بالجنيه المصري
        function formatCurrency(amount) {
            return Number(amount).toFixed(2) + ' ' + CURRENCY_SYMBOL;
        }

        // ============================================
        // تهيئة Firebase للمصادقة فقط (نفس الإعدادات)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDmdHcXWducb8fg721sxa2gn3Ev6f3W0cc",
            authDomain: "ramdan-5aedb.firebaseapp.com",
            projectId: "ramdan-5aedb",
            storageBucket: "ramdan-5aedb.firebasestorage.app",
            messagingSenderId: "430366107983",
            appId: "1:430366107983:web:3b3105c8404f06de16bd3a",
            measurementId: "G-LLHG4FQCDZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // ============================================
        // المتغيرات العامة ونظام التخزين (نفس الكود السابق)
        // ============================================
        let productsData = [];
        let categoriesData = [];
        let ordersData = [];
        let customersData = [];
        let couponsData = [];
        let shippingData = [];

        let currentUser = null;
        let isInitialized = false;
        
        // مفاتيح التخزين المحلي
        const STORAGE_KEYS = {
            PRODUCTS: 'ecommerce_products',
            CATEGORIES: 'ecommerce_categories',
            ORDERS: 'ecommerce_orders',
            CUSTOMERS: 'ecommerce_customers',
            COUPONS: 'ecommerce_coupons',
            SETTINGS: 'ecommerce_settings'
        };

        // ============================================
        // دوال التخزين المحلي (نفس الكود السابق)
        // ============================================
        function loadAllLocalData() {
            try {
                productsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
                categoriesData = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
                ordersData = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
                customersData = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS)) || [];
                couponsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.COUPONS)) || [];
                
                // تحديث حالة المخزون للمنتجات
                productsData.forEach(product => {
                    product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                });
                
                return true;
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                return false;
            }
        }

        function saveAllLocalData() {
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(productsData));
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categoriesData));
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(ordersData));
            localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customersData));
            localStorage.setItem(STORAGE_KEYS.COUPONS, JSON.stringify(couponsData));
        }

        // ============================================
        // دوال إدارة المنتجات مع تحديث العملة
        // ============================================
        function saveProduct() {
            const id = document.getElementById('productId').value;
            const isEdit = !!id;
            
            const productData = {
                name: document.getElementById('productName').value,
                code: document.getElementById('productCode').value,
                categoryId: document.getElementById('productCategory').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                stockQuantity: parseInt(document.getElementById('stockQuantity').value),
                minStock: parseInt(document.getElementById('minStock').value),
                images: document.getElementById('productImages').value,
                status: calculateStockStatus(
                    parseInt(document.getElementById('stockQuantity').value),
                    parseInt(document.getElementById('minStock').value)
                )
            };
            
            if (!productData.name || !productData.code || !productData.categoryId) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    const index = productsData.findIndex(p => p.id == id);
                    if (index !== -1) {
                        productData.id = id;
                        productData.createdAt = productsData[index].createdAt;
                        productsData[index] = productData;
                    }
                } else {
                    productData.id = Date.now().toString();
                    productData.createdAt = new Date().toISOString();
                    productsData.push(productData);
                }
                
                saveAllLocalData();
                closeProductForm();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث المنتج بنجاح' : 'تم إضافة المنتج بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ المنتج');
                showLoading(false);
            }
        }

        // ============================================
        // دوال العرض مع تصميم عصري وعملة الجنيه
        // ============================================
        
        function showDashboard() {
            // تحديث الإحصائيات
            updateStats();
            
            const totalRevenue = ordersData.reduce((sum, order) => sum + (order.total || 0), 0);
            const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
            const lowStockCount = productsData.filter(p => p.status === 'low-stock').length;
            
            document.getElementById('contentArea').innerHTML = `
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;">مرحباً بك في متجري</h2>
                    <p style="color: var(--text-secondary);">نظرة عامة على أداء متجرك اليوم</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${ordersData.length}</h3>
                            <p>إجمالي الطلبات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${productsData.length}</h3>
                            <p>المنتجات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${customersData.length}</h3>
                            <p>العملاء</p>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #ec4899, #d946ef);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${formatCurrency(totalRevenue)}</h3>
                            <p>الإيرادات</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 24px;">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                                <i class="fas fa-clock" style="color: var(--primary-color); margin-left: 8px;"></i>
                                آخر الطلبات
                            </h3>
                            <button class="btn-modern btn-modern-sm" onclick="showOrders()">
                                عرض الكل
                            </button>
                        </div>
                        <div id="recentOrdersList">
                            ${renderRecentOrders()}
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-left: 8px;"></i>
                                تنبيهات المخزون
                            </h3>
                            <button class="btn-modern btn-modern-sm" onclick="showInventory()">
                                عرض الكل
                            </button>
                        </div>
                        <div id="lowStockList">
                            ${renderLowStockAlerts()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRecentOrders() {
            const recentOrders = [...ordersData]
                .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))
                .slice(0, 5);
            
            if (recentOrders.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 20px;">لا توجد طلبات حديثة</p>';
            }
            
            return recentOrders.map(order => {
                const customer = customersData.find(c => c.id === order.customerId);
                const statusColors = {
                    'pending': '#f59e0b',
                    'processing': '#3b82f6',
                    'shipped': '#8b5cf6',
                    'completed': '#10b981',
                    'cancelled': '#ef4444'
                };
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">${order.orderNumber}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${customer ? customer.name : 'غير معروف'}</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 700; color: var(--primary-color);">${formatCurrency(order.total || 0)}</div>
                            <span style="display: inline-block; padding: 4px 8px; background: ${statusColors[order.status]}20; color: ${statusColors[order.status]}; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 700;">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLowStockAlerts() {
            const lowStock = productsData.filter(p => p.status === 'low-stock').slice(0, 5);
            
            if (lowStock.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 20px;">لا توجد منتجات منخفضة المخزون</p>';
            }
            
            return lowStock.map(product => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">${product.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">المخزون: ${product.stockQuantity} / ${product.minStock}</div>
                    </div>
                    <button class="btn-modern btn-modern-sm" style="background: var(--warning-gradient);" onclick="updateProductStock('${product.id}')">
                        <i class="fas fa-plus"></i>
                        <span>تزويد</span>
                    </button>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        // تحديث عرض المنتجات مع العملة الجديدة
        function renderProductsGrid() {
            if (productsData.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">لا توجد منتجات. قم بإضافة منتج جديد</p>';
            }
            
            return productsData.map(product => {
                const category = categoriesData.find(c => c.id === product.categoryId);
                const stockStatus = product.status || calculateStockStatus(product.stockQuantity, product.minStock);
                const imageUrl = product.images ? product.images.split(',')[0] : '';
                
                return `
                    <div class="product-card-modern">
                        <div class="product-image-container">
                            ${imageUrl ? 
                                `<img src="${imageUrl.trim()}" alt="${product.name}">` : 
                                '<i class="fas fa-box-open" style="font-size: 3rem; color: var(--text-muted);"></i>'
                            }
                            <span class="product-badge badge-${stockStatus}">
                                ${stockStatus === 'in-stock' ? 'متوفر' : stockStatus === 'low-stock' ? 'منخفض' : 'نفذ'}
                            </span>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-code">
                                <i class="fas fa-barcode"></i>
                                <span>${product.code}</span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <span style="background: var(--bg-light); padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; color: var(--text-secondary);">
                                    ${category ? category.name : 'غير مصنف'}
                                </span>
                                ${product.brand ? `
                                    <span style="background: var(--bg-light); padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; color: var(--text-secondary);">
                                        ${product.brand}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="product-price-row">
                                <span class="product-price">${formatCurrency(product.salePrice)}</span>
                                <div class="product-stock">
                                    <i class="fas fa-boxes"></i>
                                    <span>${product.stockQuantity}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button class="btn-modern btn-modern-sm" style="flex: 1;" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i>
                                    <span>تعديل</span>
                                </button>
                                <button class="btn-modern btn-modern-sm" style="flex: 1; background: var(--danger-gradient);" onclick="deleteProduct('${product.id}')">
                                    <i class="fas fa-trash"></i>
                                    <span>حذف</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // تحديث دالة showProducts لاستخدام التصميم الجديد
        function showProducts() {
            setActiveMenuItem(1);
            
            document.getElementById('contentArea').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;">المنتجات</h2>
                        <p style="color: var(--text-secondary);">إدارة وعرض جميع منتجات متجرك</p>
                    </div>
                    <button class="btn-modern" onclick="openProductForm()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة منتج</span>
                    </button>
                </div>
                
                <div class="search-bar-modern">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchProducts" placeholder="ابحث عن منتج بالاسم أو الرمز..." onkeyup="filterProducts()">
                    <button onclick="filterProducts()">بحث</button>
                </div>
                
                <div class="product-grid" id="productsGrid">
                    ${renderProductsGrid()}
                </div>
            `;
        }

        // دوال مساعدة للتصميم الجديد
        function setActiveMenuItem(index) {
            // تحديث القائمة الجانبية
            document.querySelectorAll('.menu-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });
            
            // تحديث القائمة السفلية للجوال
            document.querySelectorAll('.mobile-nav-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });
        }

        function setActiveMobileNav(index) {
            document.querySelectorAll('.mobile-nav-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });
        }

        function closeMobileSidebar() {
            document.getElementById('mobileSidebar').classList.remove('active');
        }

        // تحديث دالة updateStats لاستخدام العملة الجديدة
        function updateStats() {
            try {
                const totalOrders = ordersData.length;
                const totalProducts = productsData.length;
                const totalCustomers = customersData.length;
                const totalRevenue = ordersData.reduce((sum, order) => sum + (order.total || 0), 0);
                
                if (document.getElementById('totalOrders')) {
                    document.getElementById('totalOrders').textContent = totalOrders;
                }
                if (document.getElementById('totalProducts')) {
                    document.getElementById('totalProducts').textContent = totalProducts;
                }
                if (document.getElementById('totalCustomers')) {
                    document.getElementById('totalCustomers').textContent = totalCustomers;
                }
                if (document.getElementById('totalRevenue')) {
                    document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // ============================================
        // تهيئة النظام والتحكم بالقوائم
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // قائمة الجوال
            const menuToggle = document.getElementById('menuToggle');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const fabButton = document.getElementById('fabButton');
            
            if (menuToggle && mobileSidebar) {
                menuToggle.addEventListener('click', function() {
                    mobileSidebar.classList.toggle('active');
                });
            }
            
            // زر القائمة العائم
            if (fabButton) {
                fabButton.addEventListener('click', function() {
                    // فتح قائمة الإجراءات السريعة
                    if (document.getElementById('contentArea').innerHTML.includes('المنتجات')) {
                        openProductForm();
                    } else {
                        showProducts();
                    }
                });
            }
            
            // إغلاق القائمة عند النقر خارجها
            document.addEventListener('click', function(event) {
                if (mobileSidebar && !mobileSidebar.contains(event.target) && 
                    menuToggle && !menuToggle.contains(event.target) && 
                    mobileSidebar.classList.contains('active')) {
                    mobileSidebar.classList.remove('active');
                }
            });
            
            // التحقق من حالة تسجيل الدخول
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('loggedInUser').textContent = user.email || 'مستخدم';
                    document.getElementById('mobileUserEmail').textContent = user.email || 'مستخدم';
                    loadAllLocalData();
                }
            });
        });

        // تحديث جميع دوال العرض الأخرى لاستخدام formatCurrency
        // بدلاً من إضافة 'ر.س' مباشرة
        function formatCurrency(amount) {
            return Number(amount || 0).toFixed(2) + ' ' + CURRENCY_SYMBOL;
        }

        // دوال مساعدة أخرى (نفس الكود السابق مع تحديث العملة)
        function calculateStockStatus(quantity, minStock) {
            if (quantity <= 0) return 'out-of-stock';
            if (quantity <= minStock) return 'low-stock';
            return 'in-stock';
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // ============================================
        // دوال المصادقة (نفس الكود السابق)
        // ============================================
        function handleLogin() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.style.display = 'none';
            
            if (!email || !password) {
                errorDiv.querySelector('span').textContent = 'الرجاء إدخال البريد الإلكتروني وكلمة المرور';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoading(true);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadAllLocalData();
                    
                    document.getElementById('loggedInUser').textContent = currentUser.email;
                    document.getElementById('mobileUserEmail').textContent = currentUser.email;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    
                    showDashboard();
                    showSuccess('تم تسجيل الدخول بنجاح');
                    showLoading(false);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    let errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    errorDiv.querySelector('span').textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    showLoading(false);
                });
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                auth.signOut().then(() => {
                    currentUser = null;
                    document.getElementById('main-content').style.display = 'none';
                    document.getElementById('login-screen').style.display = 'flex';
                    showSuccess('تم تسجيل الخروج بنجاح');
                });
            }
        }

        // نسخ جميع الدوال الأخرى من الكود الأصلي مع تحديث العملة
        // (products, orders, customers, inventory, backup, export, etc.)
        // مع الحفاظ على نفس الوظائف ولكن مع تنسيق العملة الجديد

        // ============================================
        // تصدير الدوال العامة
        // ============================================
        window.showDashboard = showDashboard;
        window.showProducts = showProducts;
        window.showCategories = showCategories;
        window.showOrders = showOrders;
        window.showCustomers = showCustomers;
        window.showInventory = showInventory;
        window.showAdvancedSearch = showAdvancedSearch;
        window.showReports = showReports;
        window.showBackupRestore = showBackupRestore;
        window.showSignupForm = showSignupForm;
        window.closeSignupForm = closeSignupForm;
        window.handleSignup = handleSignup;
        window.handlePasswordReset = handlePasswordReset;
        window.logout = logout;
        window.openProductForm = openProductForm;
        window.closeProductForm = closeProductForm;
        window.saveProduct = saveProduct;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.saveCategory = saveCategory;
        window.deleteCategory = deleteCategory;
        window.openOrderForm = openOrderForm;
        window.closeOrderForm = closeOrderForm;
        window.saveOrder = saveOrder;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.openCustomerForm = openCustomerForm;
        window.closeCustomerForm = closeCustomerForm;
        window.saveCustomer = saveCustomer;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.exportAllToExcel = exportAllToExcel;
        window.exportAllToJSON = exportAllToJSON;
        window.clearAllLocalData = clearAllLocalData;
        window.formatCurrency = formatCurrency;
        window.setActiveMobileNav = setActiveMobileNav;
        window.closeMobileSidebar = closeMobileSidebar;
        // ============================================
        // دوال إدارة المنتجات
        // ============================================
        function showProducts(page = 1, searchQuery = '') {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(2)').classList.add('active');
            currentPage.products = page;
            
            // فلترة المنتجات حسب البحث
            let filteredProducts = productsData;
            if (searchQuery) {
                filteredProducts = productsData.filter(product => 
                    product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.code.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    product.brand?.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            // حساب الصفحات
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            
            let productsHTML = '';
            
            if (pageProducts.length === 0) {
                productsHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i>
                            ${currentLanguage === 'ar' ? 'لا توجد منتجات' : 'No products found'}
                        </td>
                    </tr>
                `;
            } else {
                productsHTML = pageProducts.map(product => {
                    const category = categoriesData.find(c => c.id === product.categoryId);
                    const profit = product.salePrice - product.purchasePrice;
                    const profitMargin = product.purchasePrice > 0 ? (profit / product.purchasePrice * 100).toFixed(1) : 0;
                    
                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                        ${product.images ? 
                                            `<img src="${product.images.split(',')[0]}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                            `<i class="fas fa-box" style="font-size: 20px; color: #666;"></i>`
                                        }
                                    </div>
                                    <div>
                                        <div style="font-weight: bold;">${product.name}</div>
                                        <div style="font-size: 12px; color: #666;">${product.code}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${category ? category.name : 'غير مصنف'}</td>
                            <td>${product.brand || '-'}</td>
                            <td>${formatPriceWithCurrency(product.salePrice)}</td>
                            <td>
                                <span class="stock-badge ${product.status}">
                                    ${currentLanguage === 'ar' ? 
                                        (product.status === 'in-stock' ? 'متوفر' : 
                                         product.status === 'low-stock' ? 'منخفض' : 'نفذ') :
                                        (product.status === 'in-stock' ? 'In Stock' : 
                                         product.status === 'low-stock' ? 'Low Stock' : 'Out of Stock')
                                    }
                                </span>
                            </td>
                            <td>${product.stockQuantity}</td>
                            <td>${profitMargin}%</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-info" onclick="editProduct('${product.id}')" title="${currentLanguage === 'ar' ? 'تعديل' : 'Edit'}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="updateProductStock('${product.id}')" title="${currentLanguage === 'ar' ? 'إضافة مخزون' : 'Add Stock'}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')" title="${currentLanguage === 'ar' ? 'حذف' : 'Delete'}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // إنشاء ترميز الترقيم
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="pagination">
                        <button class="page-btn ${page === 1 ? 'disabled' : ''}" onclick="showProducts(${page - 1}, '${searchQuery}')" ${page === 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        ${Array.from({length: totalPages}, (_, i) => i + 1)
                            .filter(p => p === 1 || p === totalPages || (p >= page - 2 && p <= page + 2))
                            .map((p, index, array) => {
                                let html = '';
                                if (index > 0 && p - array[index - 1] > 1) {
                                    html += '<span style="padding: 8px 15px;">...</span>';
                                }
                                html += `
                                    <button class="page-btn ${p === page ? 'active' : ''}" onclick="showProducts(${p}, '${searchQuery}')">
                                        ${p}
                                    </button>
                                `;
                                return html;
                            }).join('')}
                        
                        <button class="page-btn ${page === totalPages ? 'disabled' : ''}" onclick="showProducts(${page + 1}, '${searchQuery}')" ${page === totalPages ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-box"></i> <span data-ar="إدارة المنتجات" data-en="Products Management">إدارة المنتجات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addNewProduct()">
                                <i class="fas fa-plus"></i> <span data-ar="إضافة منتج جديد" data-en="Add New Product">إضافة منتج جديد</span>
                            </button>
                            <button class="btn btn-info" onclick="exportProductsToExcel()">
                                <i class="fas fa-download"></i> <span data-ar="تصدير إلى Excel" data-en="Export to Excel">تصدير إلى Excel</span>
                            </button>
                            <button class="btn btn-warning" onclick="showLowStockAlerts()">
                                <i class="fas fa-exclamation-triangle"></i> <span data-ar="تنبيهات المخزون" data-en="Stock Alerts">تنبيهات المخزون</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--product-color);">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.length}</h3>
                                    <p data-ar="إجمالي المنتجات" data-en="Total Products">إجمالي المنتجات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.filter(p => p.status === 'in-stock').length}</h3>
                                    <p data-ar="متوفر في المخزون" data-en="In Stock">متوفر في المخزون</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--warning-color);">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.filter(p => p.status === 'low-stock').length}</h3>
                                    <p data-ar="منخفض المخزون" data-en="Low Stock">منخفض المخزون</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--danger-color);">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.filter(p => p.status === 'out-of-stock').length}</h3>
                                    <p data-ar="نفذ من المخزون" data-en="Out of Stock">نفذ من المخزون</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="productSearch" placeholder="${currentLanguage === 'ar' ? 'ابحث عن منتج بالاسم أو الرمز أو الماركة...' : 'Search product by name, code or brand...'}" 
                                   value="${searchQuery}" onkeypress="if(event.key === 'Enter') searchProducts()">
                            <button onclick="searchProducts()">
                                <i class="fas fa-search"></i> <span data-ar="بحث" data-en="Search">بحث</span>
                            </button>
                            <button class="btn btn-warning" onclick="showAdvancedSearch()">
                                <i class="fas fa-filter"></i> <span data-ar="بحث متقدم" data-en="Advanced Search">بحث متقدم</span>
                            </button>
                        </div>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="المنتج" data-en="Product">المنتج</th>
                                        <th data-ar="التصنيف" data-en="Category">التصنيف</th>
                                        <th data-ar="العلامة التجارية" data-en="Brand">العلامة التجارية</th>
                                        <th data-ar="سعر البيع" data-en="Sale Price">سعر البيع</th>
                                        <th data-ar="الحالة" data-en="Status">الحالة</th>
                                        <th data-ar="المخزون" data-en="Stock">المخزون</th>
                                        <th data-ar="هامش الربح" data-en="Profit Margin">هامش الربح</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productsHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        ${paginationHTML}
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                updateAllTexts();
            }, 100);
        }

        function searchProducts() {
            const searchQuery = document.getElementById('productSearch')?.value || '';
            showProducts(1, searchQuery);
        }

        function addNewProduct() {
            document.getElementById('productId').value = '';
            document.getElementById('productForm').reset();
            document.getElementById('productFormTitle').textContent = currentLanguage === 'ar' ? 'إضافة منتج جديد' : 'Add New Product';
            
            // تعبئة قائمة التصنيفات
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">اختر التصنيف</option>' + 
                    categoriesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
            
            document.getElementById('productFormModal').classList.add('active');
        }

        function editProduct(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCode').value = product.code;
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('purchasePrice').value = product.purchasePrice;
            document.getElementById('salePrice').value = product.salePrice;
            document.getElementById('stockQuantity').value = product.stockQuantity;
            document.getElementById('minStock').value = product.minStock;
            document.getElementById('productImages').value = product.images || '';
            
            // تعبئة قائمة التصنيفات
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">اختر التصنيف</option>' + 
                    categoriesData.map(c => `<option value="${c.id}" ${c.id === product.categoryId ? 'selected' : ''}>${c.name}</option>`).join('');
            }
            
            document.getElementById('productFormTitle').textContent = currentLanguage === 'ar' ? 'تعديل منتج' : 'Edit Product';
            document.getElementById('productFormModal').classList.add('active');
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                code: document.getElementById('productCode').value,
                categoryId: document.getElementById('productCategory').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                stockQuantity: parseInt(document.getElementById('stockQuantity').value),
                minStock: parseInt(document.getElementById('minStock').value),
                images: document.getElementById('productImages').value,
                status: calculateStockStatus(
                    parseInt(document.getElementById('stockQuantity').value),
                    parseInt(document.getElementById('minStock').value)
                ),
                updatedAt: new Date().toISOString()
            };
            
            if (!productData.name || !productData.code || !productData.categoryId) {
                showError(currentLanguage === 'ar' ? 'الرجاء ملء جميع الحقول المطلوبة' : 'Please fill all required fields');
                return;
            }
            
            if (productId) {
                // تحديث منتج موجود
                const index = productsData.findIndex(p => p.id === productId);
                if (index !== -1) {
                    productData.id = productId;
                    productData.createdAt = productsData[index].createdAt;
                    productsData[index] = productData;
                }
            } else {
                // إضافة منتج جديد
                productData.id = 'product-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                productData.createdAt = new Date().toISOString();
                productsData.unshift(productData);
            }
            
            saveProductsToLocal();
            updateCategoryCounts();
            closeProductForm();
            showProducts(currentPage.products);
            showSuccess(currentLanguage === 'ar' ? 'تم حفظ المنتج بنجاح' : 'Product saved successfully');
        }

        function deleteProduct(productId) {
            if (!confirm(currentLanguage === 'ar' ? 'هل أنت متأكد من حذف هذا المنتج؟' : 'Are you sure you want to delete this product?')) {
                return;
            }
            
            const index = productsData.findIndex(p => p.id === productId);
            if (index !== -1) {
                productsData.splice(index, 1);
                saveProductsToLocal();
                updateCategoryCounts();
                showProducts(currentPage.products);
                showSuccess(currentLanguage === 'ar' ? 'تم حذف المنتج بنجاح' : 'Product deleted successfully');
            }
        }

        function exportProductsToExcel() {
            try {
                showLoading(true);
                
                const ws = XLSX.utils.json_to_sheet(productsData.map(p => {
                    const category = categoriesData.find(c => c.id === p.categoryId);
                    return {
                        [currentLanguage === 'ar' ? 'اسم المنتج' : 'Product Name']: p.name,
                        [currentLanguage === 'ar' ? 'الرمز' : 'Code']: p.code,
                        [currentLanguage === 'ar' ? 'التصنيف' : 'Category']: category ? category.name : '',
                        [currentLanguage === 'ar' ? 'العلامة التجارية' : 'Brand']: p.brand || '',
                        [currentLanguage === 'ar' ? 'سعر الشراء' : 'Purchase Price']: p.purchasePrice,
                        [currentLanguage === 'ar' ? 'سعر البيع' : 'Sale Price']: p.salePrice,
                        [currentLanguage === 'ar' ? 'المخزون' : 'Stock']: p.stockQuantity,
                        [currentLanguage === 'ar' ? 'الحد الأدنى' : 'Minimum Stock']: p.minStock,
                        [currentLanguage === 'ar' ? 'الحالة' : 'Status']: p.status === 'in-stock' ? 
                            (currentLanguage === 'ar' ? 'متوفر' : 'In Stock') : 
                            p.status === 'low-stock' ? (currentLanguage === 'ar' ? 'منخفض' : 'Low Stock') : 
                            (currentLanguage === 'ar' ? 'نفذ' : 'Out of Stock')
                    };
                }));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'ar' ? 'المنتجات' : 'Products');
                
                const fileName = currentLanguage === 'ar' ? 
                    `منتجات_${new Date().toISOString().split('T')[0]}.xlsx` :
                    `products_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                
                showLoading(false);
                showSuccess(currentLanguage === 'ar' ? 
                    'تم تصدير المنتجات بنجاح' : 
                    'Products exported successfully');
            } catch (error) {
                showLoading(false);
                showError((currentLanguage === 'ar' ? 'فشل التصدير: ' : 'Export failed: ') + error.message);
            }
        }

        // ============================================
        // دوال إدارة العملاء
        // ============================================
        function showCustomers(page = 1, searchQuery = '') {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(5)').classList.add('active');
            currentPage.customers = page;
            
            // فلترة العملاء حسب البحث
            let filteredCustomers = customersData;
            if (searchQuery) {
                filteredCustomers = customersData.filter(customer => 
                    customer.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    customer.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    customer.phone?.includes(searchQuery)
                );
            }
            
            // حساب الصفحات
            const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageCustomers = filteredCustomers.slice(startIndex, endIndex);
            
            let customersHTML = '';
            
            if (pageCustomers.length === 0) {
                customersHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i>
                            ${currentLanguage === 'ar' ? 'لا توجد عملاء' : 'No customers found'}
                        </td>
                    </tr>
                `;
            } else {
                customersHTML = pageCustomers.map(customer => {
                    const customerOrders = ordersData.filter(o => o.customerId === customer.id);
                    const avgOrderValue = customerOrders.length > 0 ? 
                        customerOrders.reduce((sum, order) => sum + order.total, 0) / customerOrders.length : 0;
                    
                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--customer-color); display: flex; align-items: center; justify-content: center; color: white;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: bold;">${customer.name}</div>
                                        <div style="font-size: 12px; color: #666;">${customer.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${customer.phone}</td>
                            <td>${customer.city || '-'}</td>
                            <td>${customer.totalOrders || 0}</td>
                            <td>${formatPriceWithCurrency(customer.totalSpent || 0)}</td>
                            <td>${formatPriceWithCurrency(avgOrderValue)}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-info" onclick="editCustomer('${customer.id}')" title="${currentLanguage === 'ar' ? 'تعديل' : 'Edit'}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="viewCustomerOrders('${customer.id}')" title="${currentLanguage === 'ar' ? 'عرض الطلبات' : 'View Orders'}">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')" title="${currentLanguage === 'ar' ? 'حذف' : 'Delete'}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // إنشاء ترميز الترقيم
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="pagination">
                        <button class="page-btn ${page === 1 ? 'disabled' : ''}" onclick="showCustomers(${page - 1}, '${searchQuery}')" ${page === 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        ${Array.from({length: totalPages}, (_, i) => i + 1)
                            .filter(p => p === 1 || p === totalPages || (p >= page - 2 && p <= page + 2))
                            .map((p, index, array) => {
                                let html = '';
                                if (index > 0 && p - array[index - 1] > 1) {
                                    html += '<span style="padding: 8px 15px;">...</span>';
                                }
                                html += `
                                    <button class="page-btn ${p === page ? 'active' : ''}" onclick="showCustomers(${p}, '${searchQuery}')">
                                        ${p}
                                    </button>
                                `;
                                return html;
                            }).join('')}
                        
                        <button class="page-btn ${page === totalPages ? 'disabled' : ''}" onclick="showCustomers(${page + 1}, '${searchQuery}')" ${page === totalPages ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-users"></i> <span data-ar="إدارة العملاء" data-en="Customers Management">إدارة العملاء</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addNewCustomer()">
                                <i class="fas fa-user-plus"></i> <span data-ar="إضافة عميل جديد" data-en="Add New Customer">إضافة عميل جديد</span>
                            </button>
                            <button class="btn btn-info" onclick="exportCustomersToExcel()">
                                <i class="fas fa-download"></i> <span data-ar="تصدير العملاء" data-en="Export Customers">تصدير العملاء</span>
                            </button>
                            <button class="btn btn-warning" onclick="showCustomerReports()">
                                <i class="fas fa-chart-pie"></i> <span data-ar="تقارير العملاء" data-en="Customer Reports">تقارير العملاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--customer-color);">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customersData.length}</h3>
                                    <p data-ar="إجمالي العملاء" data-en="Total Customers">إجمالي العملاء</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customersData.filter(c => (c.totalOrders || 0) > 0).length}</h3>
                                    <p data-ar="عملاء نشطين" data-en="Active Customers">عملاء نشطين</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--info-color);">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customersData.filter(c => (c.totalOrders || 0) > 5).length}</h3>
                                    <p data-ar="عملاء متميزين" data-en="VIP Customers">عملاء متميزين</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--primary-color);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${formatPriceWithCurrency(customersData.reduce((sum, c) => sum + (c.totalSpent || 0), 0))}</h3>
                                    <p data-ar="إجمالي المشتريات" data-en="Total Purchases">إجمالي المشتريات</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="customerSearch" placeholder="${currentLanguage === 'ar' ? 'ابحث عن عميل بالاسم أو البريد أو الهاتف...' : 'Search customer by name, email or phone...'}" 
                                   value="${searchQuery}" onkeypress="if(event.key === 'Enter') searchCustomers()">
                            <button onclick="searchCustomers()">
                                <i class="fas fa-search"></i> <span data-ar="بحث" data-en="Search">بحث</span>
                            </button>
                        </div>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="العميل" data-en="Customer">العميل</th>
                                        <th data-ar="رقم الهاتف" data-en="Phone">رقم الهاتف</th>
                                        <th data-ar="المدينة" data-en="City">المدينة</th>
                                        <th data-ar="عدد الطلبات" data-en="Orders Count">عدد الطلبات</th>
                                        <th data-ar="إجمالي المشتريات" data-en="Total Spent">إجمالي المشتريات</th>
                                        <th data-ar="متوسط الطلب" data-en="Average Order">متوسط الطلب</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${customersHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        ${paginationHTML}
                        
                        <div class="chart-container">
                            <h3 class="chart-title"><i class="fas fa-chart-bar"></i> <span data-ar="توزيع العملاء حسب المدن" data-en="Customers Distribution by City">توزيع العملاء حسب المدن</span></h3>
                            <canvas id="customersByCityChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // رسم مخطط توزيع العملاء حسب المدن
            setTimeout(() => {
                renderCustomersByCityChart();
                updateAllTexts();
            }, 100);
        }

        function searchCustomers() {
            const searchQuery = document.getElementById('customerSearch')?.value || '';
            showCustomers(1, searchQuery);
        }

        function addNewCustomer() {
            // إنشاء نموذج إضافة عميل جديد
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-user-plus"></i> <span data-ar="إضافة عميل جديد" data-en="Add New Customer">إضافة عميل جديد</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="showCustomers()">
                                <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
                        <form id="newCustomerForm" onsubmit="event.preventDefault(); saveNewCustomer();">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required" data-ar="الاسم الكامل" data-en="Full Name">الاسم الكامل</label>
                                    <input type="text" class="form-input" id="customerName" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required" data-ar="البريد الإلكتروني" data-en="Email">البريد الإلكتروني</label>
                                    <input type="email" class="form-input" id="customerEmail" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required" data-ar="رقم الهاتف" data-en="Phone Number">رقم الهاتف</label>
                                    <input type="tel" class="form-input" id="customerPhone" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-ar="المدينة" data-en="City">المدينة</label>
                                    <input type="text" class="form-input" id="customerCity">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" data-ar="البلد" data-en="Country">البلد</label>
                                    <input type="text" class="form-input" id="customerCountry" value="السعودية">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-ar="العنوان" data-en="Address">العنوان</label>
                                    <input type="text" class="form-input" id="customerAddress">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" data-ar="ملاحظات" data-en="Notes">ملاحظات</label>
                                <textarea class="form-textarea" id="customerNotes" rows="3"></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" onclick="showCustomers()">
                                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> <span data-ar="حفظ العميل" data-en="Save Customer">حفظ العميل</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function saveNewCustomer() {
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                city: document.getElementById('customerCity').value,
                country: document.getElementById('customerCountry').value,
                address: document.getElementById('customerAddress').value,
                notes: document.getElementById('customerNotes').value,
                createdAt: new Date().toISOString(),
                totalOrders: 0,
                totalSpent: 0
            };
            
            if (!customerData.name || !customerData.email || !customerData.phone) {
                showError(currentLanguage === 'ar' ? 'الرجاء ملء جميع الحقول المطلوبة' : 'Please fill all required fields');
                return;
            }
            
            // التحقق من عدم تكرار البريد الإلكتروني
            const existingCustomer = customersData.find(c => c.email === customerData.email);
            if (existingCustomer) {
                showError(currentLanguage === 'ar' ? 'البريد الإلكتروني مسجل مسبقاً' : 'Email already registered');
                return;
            }
            
            customerData.id = 'customer-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            customersData.unshift(customerData);
            saveCustomersToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم إضافة العميل بنجاح' : 'Customer added successfully');
            showCustomers();
        }

        function editCustomer(customerId) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-user-edit"></i> <span data-ar="تعديل بيانات العميل" data-en="Edit Customer">تعديل بيانات العميل</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="showCustomers()">
                                <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
                        <form id="editCustomerForm" onsubmit="event.preventDefault(); updateCustomer('${customerId}');">
                            <input type="hidden" id="editCustomerId" value="${customerId}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required" data-ar="الاسم الكامل" data-en="Full Name">الاسم الكامل</label>
                                    <input type="text" class="form-input" id="editCustomerName" value="${customer.name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required" data-ar="البريد الإلكتروني" data-en="Email">البريد الإلكتروني</label>
                                    <input type="email" class="form-input" id="editCustomerEmail" value="${customer.email}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required" data-ar="رقم الهاتف" data-en="Phone Number">رقم الهاتف</label>
                                    <input type="tel" class="form-input" id="editCustomerPhone" value="${customer.phone}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-ar="المدينة" data-en="City">المدينة</label>
                                    <input type="text" class="form-input" id="editCustomerCity" value="${customer.city || ''}">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" data-ar="البلد" data-en="Country">البلد</label>
                                    <input type="text" class="form-input" id="editCustomerCountry" value="${customer.country || 'السعودية'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" data-ar="العنوان" data-en="Address">العنوان</label>
                                    <input type="text" class="form-input" id="editCustomerAddress" value="${customer.address || ''}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" data-ar="ملاحظات" data-en="Notes">ملاحظات</label>
                                <textarea class="form-textarea" id="editCustomerNotes" rows="3">${customer.notes || ''}</textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" onclick="showCustomers()">
                                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> <span data-ar="حفظ التعديلات" data-en="Save Changes">حفظ التعديلات</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function updateCustomer(customerId) {
            const customerIndex = customersData.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;
            
            const updatedData = {
                ...customersData[customerIndex],
                name: document.getElementById('editCustomerName').value,
                email: document.getElementById('editCustomerEmail').value,
                phone: document.getElementById('editCustomerPhone').value,
                city: document.getElementById('editCustomerCity').value,
                country: document.getElementById('editCustomerCountry').value,
                address: document.getElementById('editCustomerAddress').value,
                notes: document.getElementById('editCustomerNotes').value,
                updatedAt: new Date().toISOString()
            };
            
            // التحقق من عدم تكرار البريد الإلكتروني (باستثناء العميل الحالي)
            const emailExists = customersData.some((c, index) => 
                index !== customerIndex && c.email === updatedData.email
            );
            
            if (emailExists) {
                showError(currentLanguage === 'ar' ? 'البريد الإلكتروني مسجل مسبقاً' : 'Email already registered');
                return;
            }
            
            customersData[customerIndex] = updatedData;
            saveCustomersToLocal();
            
            // تحديث البريد الإلكتروني في الطلبات المرتبطة
            ordersData.forEach(order => {
                if (order.customerId === customerId) {
                    order.customerEmail = updatedData.email;
                }
            });
            saveOrdersToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم تحديث بيانات العميل بنجاح' : 'Customer updated successfully');
            showCustomers();
        }

        function deleteCustomer(customerId) {
            if (!confirm(currentLanguage === 'ar' ? 'هل أنت متأكد من حذف هذا العميل؟' : 'Are you sure you want to delete this customer?')) {
                return;
            }
            
            // التحقق من وجود طلبات مرتبطة بالعميل
            const customerOrders = ordersData.filter(o => o.customerId === customerId);
            if (customerOrders.length > 0) {
                if (!confirm(currentLanguage === 'ar' ? 
                    'هذا العميل لديه طلبات مرتبطة. هل تريد حذفه مع جميع طلباته؟' : 
                    'This customer has associated orders. Delete customer with all orders?')) {
                    return;
                }
                
                // حذف طلبات العميل
                ordersData = ordersData.filter(o => o.customerId !== customerId);
                saveOrdersToLocal();
            }
            
            // حذف العميل
            customersData = customersData.filter(c => c.id !== customerId);
            saveCustomersToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم حذف العميل بنجاح' : 'Customer deleted successfully');
            showCustomers(currentPage.customers);
        }

        function viewCustomerOrders(customerId) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;
            
            const customerOrders = ordersData.filter(o => o.customerId === customerId);
            
            let ordersHTML = '';
            if (customerOrders.length === 0) {
                ordersHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i>
                            ${currentLanguage === 'ar' ? 'لا توجد طلبات لهذا العميل' : 'No orders for this customer'}
                        </td>
                    </tr>
                `;
            } else {
                ordersHTML = customerOrders.map(order => {
                    const statusText = {
                        'pending': currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending',
                        'processing': currentLanguage === 'ar' ? 'قيد المعالجة' : 'Processing',
                        'shipped': currentLanguage === 'ar' ? 'تم الشحن' : 'Shipped',
                        'completed': currentLanguage === 'ar' ? 'مكتمل' : 'Completed',
                        'cancelled': currentLanguage === 'ar' ? 'ملغي' : 'Cancelled'
                    };
                    
                    return `
                        <tr>
                            <td>${order.orderNumber}</td>
                            <td>${order.orderDate}</td>
                            <td>${order.items.length}</td>
                            <td>${formatPriceWithCurrency(order.subtotal)}</td>
                            <td><span class="status-badge ${order.status}">${statusText[order.status]}</span></td>
                            <td>${order.paymentMethod}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewOrderDetails('${order.id}')" title="${currentLanguage === 'ar' ? 'عرض التفاصيل' : 'View Details'}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-shopping-cart"></i> <span data-ar="طلبات العميل: ${customer.name}" data-en="Customer Orders: ${customer.name}">طلبات العميل: ${customer.name}</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showCustomers()">
                                <i class="fas fa-arrow-right"></i> <span data-ar="العودة للعملاء" data-en="Back to Customers">العودة للعملاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--customer-color);">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customer.name}</h3>
                                    <p>${customer.email}</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--order-color);">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customerOrders.length}</h3>
                                    <p data-ar="إجمالي الطلبات" data-en="Total Orders">إجمالي الطلبات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${formatPriceWithCurrency(customer.totalSpent || 0)}</h3>
                                    <p data-ar="إجمالي المشتريات" data-en="Total Purchases">إجمالي المشتريات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--info-color);">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customer.lastOrder ? new Date(customer.lastOrder).toLocaleDateString('ar-SA') : '-'}</h3>
                                    <p data-ar="آخر طلب" data-en="Last Order">آخر طلب</p>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--header-bg); margin: 30px 0 20px 0;"><i class="fas fa-list"></i> <span data-ar="تفاصيل الطلبات" data-en="Order Details">تفاصيل الطلبات</span></h3>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="رقم الطلب" data-en="Order Number">رقم الطلب</th>
                                        <th data-ar="التاريخ" data-en="Date">التاريخ</th>
                                        <th data-ar="عدد المنتجات" data-en="Items Count">عدد المنتجات</th>
                                        <th data-ar="المجموع" data-en="Total">المجموع</th>
                                        <th data-ar="الحالة" data-en="Status">الحالة</th>
                                        <th data-ar="طريقة الدفع" data-en="Payment Method">طريقة الدفع</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordersHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function viewOrderDetails(orderId) {
            // دالة لعرض تفاصيل الطلب
            showOrderDetails(orderId);
        }

        function renderCustomersByCityChart() {
            const ctx = document.getElementById('customersByCityChart')?.getContext('2d');
            if (!ctx) return;
            
            // تجميع العملاء حسب المدينة
            const cityCounts = {};
            customersData.forEach(customer => {
                const city = customer.city || currentLanguage === 'ar' ? 'غير محدد' : 'Unknown';
                cityCounts[city] = (cityCounts[city] || 0) + 1;
            });
            
            const cities = Object.keys(cityCounts);
            const counts = Object.values(cityCounts);
            
            // ألوان للشرائح
            const colors = [
                '#4361ee', '#3a0ca3', '#7209b7', '#f72585',
                '#4cc9f0', '#560bad', '#38b000', '#ff9e00'
            ];
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: cities,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: currentLanguage === 'ar',
                            labels: {
                                font: {
                                    family: "'Cairo', sans-serif",
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        function exportCustomersToExcel() {
            try {
                showLoading(true);
                
                const ws = XLSX.utils.json_to_sheet(customersData.map(customer => ({
                    [currentLanguage === 'ar' ? 'الاسم' : 'Name']: customer.name,
                    [currentLanguage === 'ar' ? 'البريد الإلكتروني' : 'Email']: customer.email,
                    [currentLanguage === 'ar' ? 'رقم الهاتف' : 'Phone']: customer.phone,
                    [currentLanguage === 'ar' ? 'المدينة' : 'City']: customer.city || '',
                    [currentLanguage === 'ar' ? 'البلد' : 'Country']: customer.country || '',
                    [currentLanguage === 'ar' ? 'العنوان' : 'Address']: customer.address || '',
                    [currentLanguage === 'ar' ? 'عدد الطلبات' : 'Orders Count']: customer.totalOrders || 0,
                    [currentLanguage === 'ar' ? 'إجمالي المشتريات' : 'Total Spent']: customer.totalSpent || 0,
                    [currentLanguage === 'ar' ? 'تاريخ التسجيل' : 'Registration Date']: new Date(customer.createdAt).toLocaleDateString()
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'ar' ? 'العملاء' : 'Customers');
                
                const fileName = currentLanguage === 'ar' ? 
                    `عملاء_${new Date().toISOString().split('T')[0]}.xlsx` :
                    `customers_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                
                showLoading(false);
                showSuccess(currentLanguage === 'ar' ? 
                    'تم تصدير العملاء بنجاح' : 
                    'Customers exported successfully');
            } catch (error) {
                showLoading(false);
                showError((currentLanguage === 'ar' ? 'فشل التصدير: ' : 'Export failed: ') + error.message);
            }
        }

        function showCustomerReports() {
            // دالة لعرض تقارير العملاء
            alert(currentLanguage === 'ar' ? 'خاصية تقارير العملاء قيد التطوير' : 'Customer reports feature is under development');
        }

        // ============================================
        // دوال إدارة الطلبات
        // ============================================
        function showOrders(page = 1, searchQuery = '') {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(4)').classList.add('active');
            currentPage.orders = page;
            
            // فلترة الطلبات حسب البحث
            let filteredOrders = ordersData;
            if (searchQuery) {
                filteredOrders = ordersData.filter(order => 
                    order.orderNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    order.customerName.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            // حساب الصفحات
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageOrders = filteredOrders.slice(startIndex, endIndex);
            
            let ordersHTML = '';
            
            if (pageOrders.length === 0) {
                ordersHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i>
                            ${currentLanguage === 'ar' ? 'لا توجد طلبات' : 'No orders found'}
                        </td>
                    </tr>
                `;
            } else {
                ordersHTML = pageOrders.map(order => {
                    const statusText = {
                        'pending': currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending',
                        'processing': currentLanguage === 'ar' ? 'قيد المعالجة' : 'Processing',
                        'shipped': currentLanguage === 'ar' ? 'تم الشحن' : 'Shipped',
                        'completed': currentLanguage === 'ar' ? 'مكتمل' : 'Completed',
                        'cancelled': currentLanguage === 'ar' ? 'ملغي' : 'Cancelled'
                    };
                    
                    return `
                        <tr>
                            <td>${order.orderNumber}</td>
                            <td>${order.customerName}</td>
                            <td>${order.orderDate}</td>
                            <td>${order.items.length}</td>
                            <td>${formatPriceWithCurrency(order.subtotal)}</td>
                            <td>${formatPriceWithCurrency(order.total)}</td>
                            <td><span class="status-badge ${order.status}">${statusText[order.status]}</span></td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-info" onclick="viewOrderDetails('${order.id}')" title="${currentLanguage === 'ar' ? 'عرض التفاصيل' : 'View Details'}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="updateOrderStatus('${order.id}')" title="${currentLanguage === 'ar' ? 'تغيير الحالة' : 'Change Status'}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')" title="${currentLanguage === 'ar' ? 'حذف' : 'Delete'}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // إنشاء ترميز الترقيم
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="pagination">
                        <button class="page-btn ${page === 1 ? 'disabled' : ''}" onclick="showOrders(${page - 1}, '${searchQuery}')" ${page === 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        ${Array.from({length: totalPages}, (_, i) => i + 1)
                            .filter(p => p === 1 || p === totalPages || (p >= page - 2 && p <= page + 2))
                            .map((p, index, array) => {
                                let html = '';
                                if (index > 0 && p - array[index - 1] > 1) {
                                    html += '<span style="padding: 8px 15px;">...</span>';
                                }
                                html += `
                                    <button class="page-btn ${p === page ? 'active' : ''}" onclick="showOrders(${p}, '${searchQuery}')">
                                        ${p}
                                    </button>
                                `;
                                return html;
                            }).join('')}
                        
                        <button class="page-btn ${page === totalPages ? 'disabled' : ''}" onclick="showOrders(${page + 1}, '${searchQuery}')" ${page === totalPages ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                `;
            }
            
            // حساب إحصائيات الطلبات
            const totalRevenue = ordersData.reduce((sum, order) => sum + order.total, 0);
            const avgOrderValue = ordersData.length > 0 ? totalRevenue / ordersData.length : 0;
            const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
            const completedOrders = ordersData.filter(o => o.status === 'completed').length;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-shopping-cart"></i> <span data-ar="إدارة الطلبات" data-en="Orders Management">إدارة الطلبات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addNewOrder()">
                                <i class="fas fa-plus"></i> <span data-ar="إضافة طلب جديد" data-en="Add New Order">إضافة طلب جديد</span>
                            </button>
                            <button class="btn btn-info" onclick="exportOrdersToExcel()">
                                <i class="fas fa-download"></i> <span data-ar="تصدير الطلبات" data-en="Export Orders">تصدير الطلبات</span>
                            </button>
                            <button class="btn btn-warning" onclick="showSalesAnalytics()">
                                <i class="fas fa-chart-line"></i> <span data-ar="تحليل المبيعات" data-en="Sales Analytics">تحليل المبيعات</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--order-color);">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${ordersData.length}</h3>
                                    <p data-ar="إجمالي الطلبات" data-en="Total Orders">إجمالي الطلبات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${formatPriceWithCurrency(totalRevenue)}</h3>
                                    <p data-ar="إجمالي الإيرادات" data-en="Total Revenue">إجمالي الإيرادات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--warning-color);">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${pendingOrders}</h3>
                                    <p data-ar="طلبات قيد الانتظار" data-en="Pending Orders">طلبات قيد الانتظار</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--info-color);">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${formatPriceWithCurrency(avgOrderValue)}</h3>
                                    <p data-ar="متوسط قيمة الطلب" data-en="Average Order Value">متوسط قيمة الطلب</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="orderSearch" placeholder="${currentLanguage === 'ar' ? 'ابحث عن طلب بالرقم أو اسم العميل...' : 'Search order by number or customer name...'}" 
                                   value="${searchQuery}" onkeypress="if(event.key === 'Enter') searchOrders()">
                            <button onclick="searchOrders()">
                                <i class="fas fa-search"></i> <span data-ar="بحث" data-en="Search">بحث</span>
                            </button>
                            <button class="btn btn-warning" onclick="filterOrdersByStatus()">
                                <i class="fas fa-filter"></i> <span data-ar="فلترة حسب الحالة" data-en="Filter by Status">فلترة حسب الحالة</span>
                            </button>
                        </div>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="رقم الطلب" data-en="Order Number">رقم الطلب</th>
                                        <th data-ar="اسم العميل" data-en="Customer Name">اسم العميل</th>
                                        <th data-ar="التاريخ" data-en="Date">التاريخ</th>
                                        <th data-ar="عدد المنتجات" data-en="Items Count">عدد المنتجات</th>
                                        <th data-ar="المجموع الفرعي" data-en="Subtotal">المجموع الفرعي</th>
                                        <th data-ar="الإجمالي" data-en="Total">الإجمالي</th>
                                        <th data-ar="الحالة" data-en="Status">الحالة</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordersHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        ${paginationHTML}
                        
                        <div class="chart-container">
                            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> <span data-ar="توزيع الطلبات حسب الحالة" data-en="Orders Distribution by Status">توزيع الطلبات حسب الحالة</span></h3>
                            <canvas id="ordersByStatusChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // رسم مخطط توزيع الطلبات
            setTimeout(() => {
                renderOrdersByStatusChart();
                updateAllTexts();
            }, 100);
        }

        function searchOrders() {
            const searchQuery = document.getElementById('orderSearch')?.value || '';
            showOrders(1, searchQuery);
        }

        function filterOrdersByStatus() {
            const status = prompt(currentLanguage === 'ar' ? 
                'أدخل حالة الطلب للفلترة:\n\npending - قيد الانتظار\nprocessing - قيد المعالجة\nshipped - تم الشحن\ncompleted - مكتمل\ncancelled - ملغي\n\nأو اترك فارغاً لعرض الجميع' :
                'Enter order status to filter:\n\npending - Pending\nprocessing - Processing\nshipped - Shipped\ncompleted - Completed\ncancelled - Cancelled\n\nOr leave empty to show all');
            
            if (status === null) return;
            
            if (status) {
                const filteredOrders = ordersData.filter(order => order.status === status);
                if (filteredOrders.length === 0) {
                    showError(currentLanguage === 'ar' ? 'لا توجد طلبات بهذه الحالة' : 'No orders with this status');
                    return;
                }
                showFilteredOrders(filteredOrders, status);
            } else {
                showOrders();
            }
        }

        function showFilteredOrders(filteredOrders, status) {
            const statusText = {
                'pending': currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending',
                'processing': currentLanguage === 'ar' ? 'قيد المعالجة' : 'Processing',
                'shipped': currentLanguage === 'ar' ? 'تم الشحن' : 'Shipped',
                'completed': currentLanguage === 'ar' ? 'مكتمل' : 'Completed',
                'cancelled': currentLanguage === 'ar' ? 'ملغي' : 'Cancelled'
            };
            
            let ordersHTML = filteredOrders.map(order => `
                <tr>
                    <td>${order.orderNumber}</td>
                    <td>${order.customerName}</td>
                    <td>${order.orderDate}</td>
                    <td>${order.items.length}</td>
                    <td>${formatPriceWithCurrency(order.subtotal)}</td>
                    <td>${formatPriceWithCurrency(order.total)}</td>
                    <td><span class="status-badge ${order.status}">${statusText[order.status]}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-info" onclick="viewOrderDetails('${order.id}')" title="${currentLanguage === 'ar' ? 'عرض التفاصيل' : 'View Details'}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="updateOrderStatus('${order.id}')" title="${currentLanguage === 'ar' ? 'تغيير الحالة' : 'Change Status'}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-filter"></i> <span data-ar="الطلبات - ${statusText[status] || status}" data-en="Orders - ${statusText[status] || status}">الطلبات - ${statusText[status] || status}</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showOrders()">
                                <i class="fas fa-arrow-right"></i> <span data-ar="عرض جميع الطلبات" data-en="View All Orders">عرض جميع الطلبات</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="رقم الطلب" data-en="Order Number">رقم الطلب</th>
                                        <th data-ar="اسم العميل" data-en="Customer Name">اسم العميل</th>
                                        <th data-ar="التاريخ" data-en="Date">التاريخ</th>
                                        <th data-ar="عدد المنتجات" data-en="Items Count">عدد المنتجات</th>
                                        <th data-ar="المجموع الفرعي" data-en="Subtotal">المجموع الفرعي</th>
                                        <th data-ar="الإجمالي" data-en="Total">الإجمالي</th>
                                        <th data-ar="الحالة" data-en="Status">الحالة</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordersHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <p>${currentLanguage === 'ar' ? 'عدد الطلبات:' : 'Number of orders:'} <strong>${filteredOrders.length}</strong></p>
                            <button class="btn btn-primary" onclick="showOrders()">
                                <i class="fas fa-arrow-right"></i> <span data-ar="عرض جميع الطلبات" data-en="View All Orders">عرض جميع الطلبات</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function addNewOrder() {
            // إنشاء نموذج إضافة طلب جديد
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-plus-circle"></i> <span data-ar="إضافة طلب جديد" data-en="Add New Order">إضافة طلب جديد</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="showOrders()">
                                <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; max-width: 900px; margin: 0 auto;">
                        <form id="newOrderForm" onsubmit="event.preventDefault(); saveNewOrder();">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required" data-ar="العميل" data-en="Customer">العميل</label>
                                    <select class="form-select" id="orderCustomer" required>
                                        <option value="">اختر العميل</option>
                                        ${customersData.map(c => `<option value="${c.id}">${c.name} - ${c.email}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required" data-ar="تاريخ الطلب" data-en="Order Date">تاريخ الطلب</label>
                                    <input type="date" class="form-input" id="orderDate" value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label required" data-ar="طريقة الدفع" data-en="Payment Method">طريقة الدفع</label>
                                    <select class="form-select" id="orderPayment" required>
                                        <option value="">اختر طريقة الدفع</option>
                                        <option value="بطاقة ائتمان">بطاقة ائتمان</option>
                                        <option value="تحويل بنكي">تحويل بنكي</option>
                                        <option value="الدفع عند الاستلام">الدفع عند الاستلام</option>
                                        <option value="محفظة إلكترونية">محفظة إلكترونية</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required" data-ar="حالة الطلب" data-en="Order Status">حالة الطلب</label>
                                    <select class="form-select" id="orderStatus" required>
                                        <option value="pending">قيد الانتظار</option>
                                        <option value="processing">قيد المعالجة</option>
                                        <option value="shipped">تم الشحن</option>
                                        <option value="completed">مكتمل</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h3 style="color: var(--header-bg); margin: 30px 0 20px 0;"><i class="fas fa-shopping-cart"></i> <span data-ar="المنتجات المطلوبة" data-en="Order Items">المنتجات المطلوبة</span></h3>
                            
                            <div id="orderItems">
                                <div class="order-item" style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                                    <div style="flex: 2;">
                                        <select class="form-select product-select" onchange="updateProductPrice(this)">
                                            <option value="">اختر المنتج</option>
                                            ${productsData.map(p => `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${formatPriceWithCurrency(p.salePrice)} (المخزون: ${p.stockQuantity})</option>`).join('')}
                                        </select>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" class="form-input quantity-input" placeholder="الكمية" min="1" value="1" onchange="updateItemTotal(this)">
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" class="form-input price-input" placeholder="السعر" readonly>
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" class="form-input total-input" placeholder="المجموع" readonly>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="addOrderItem()" style="margin-bottom: 20px;">
                                <i class="fas fa-plus"></i> <span data-ar="إضافة منتج آخر" data-en="Add Another Item">إضافة منتج آخر</span>
                            </button>
                            
                            <div class="order-summary" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span data-ar="المجموع الفرعي:" data-en="Subtotal:">المجموع الفرعي:</span>
                                    <span id="orderSubtotal">0.00 ر.س</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span data-ar="رسوم الشحن:" data-en="Shipping:">رسوم الشحن:</span>
                                    <input type="number" id="orderShipping" value="50" min="0" style="width: 100px; padding: 5px; border: 1px solid #dee2e6; border-radius: 5px;" onchange="updateOrderTotal()">
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span data-ar="الخصم:" data-en="Discount:">الخصم:</span>
                                    <input type="number" id="orderDiscount" value="0" min="0" style="width: 100px; padding: 5px; border: 1px solid #dee2e6; border-radius: 5px;" onchange="updateOrderTotal()">
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em; border-top: 2px solid #dee2e6; padding-top: 10px;">
                                    <span data-ar="الإجمالي:" data-en="Total:">الإجمالي:</span>
                                    <span id="orderTotal">0.00 ر.س</span>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <label class="form-label" data-ar="ملاحظات الطلب" data-en="Order Notes">ملاحظات الطلب</label>
                                <textarea class="form-textarea" id="orderNotes" rows="3"></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" onclick="showOrders()">
                                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> <span data-ar="حفظ الطلب" data-en="Save Order">حفظ الطلب</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            updateAllTexts();
            updateOrderTotal();
        }

        function addOrderItem() {
            const orderItems = document.getElementById('orderItems');
            const newItem = document.createElement('div');
            newItem.className = 'order-item';
            newItem.style.cssText = 'display: flex; gap: 15px; margin-bottom: 15px; align-items: center;';
            newItem.innerHTML = `
                <div style="flex: 2;">
                    <select class="form-select product-select" onchange="updateProductPrice(this)">
                        <option value="">اختر المنتج</option>
                        ${productsData.map(p => `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${formatPriceWithCurrency(p.salePrice)} (المخزون: ${p.stockQuantity})</option>`).join('')}
                    </select>
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-input quantity-input" placeholder="الكمية" min="1" value="1" onchange="updateItemTotal(this)">
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-input price-input" placeholder="السعر" readonly>
                </div>
                <div style="flex: 1;">
                    <input type="number" class="form-input total-input" placeholder="المجموع" readonly>
                </div>
                <div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            orderItems.appendChild(newItem);
        }

        function removeOrderItem(button) {
            const itemDiv = button.closest('.order-item');
            if (itemDiv && document.querySelectorAll('.order-item').length > 1) {
                itemDiv.remove();
                updateOrderTotal();
            }
        }

        function updateProductPrice(select) {
            const price = select.options[select.selectedIndex]?.getAttribute('data-price') || 0;
            const priceInput = select.closest('.order-item').querySelector('.price-input');
            const quantityInput = select.closest('.order-item').querySelector('.quantity-input');
            const totalInput = select.closest('.order-item').querySelector('.total-input');
            
            priceInput.value = price;
            totalInput.value = price * quantityInput.value;
            updateOrderTotal();
        }

        function updateItemTotal(input) {
            const priceInput = input.closest('.order-item').querySelector('.price-input');
            const totalInput = input.closest('.order-item').querySelector('.total-input');
            totalInput.value = priceInput.value * input.value;
            updateOrderTotal();
        }

        function updateOrderTotal() {
            let subtotal = 0;
            document.querySelectorAll('.total-input').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });
            
            const shipping = parseFloat(document.getElementById('orderShipping')?.value) || 0;
            const discount = parseFloat(document.getElementById('orderDiscount')?.value) || 0;
            const total = subtotal + shipping - discount;
            
            const subtotalElement = document.getElementById('orderSubtotal');
            const totalElement = document.getElementById('orderTotal');
            
            if (subtotalElement) subtotalElement.textContent = formatPriceWithCurrency(subtotal);
            if (totalElement) totalElement.textContent = formatPriceWithCurrency(total);
        }

        function saveNewOrder() {
            const customerId = document.getElementById('orderCustomer').value;
            const orderDate = document.getElementById('orderDate').value;
            const paymentMethod = document.getElementById('orderPayment').value;
            const status = document.getElementById('orderStatus').value;
            const shipping = parseFloat(document.getElementById('orderShipping').value) || 0;
            const discount = parseFloat(document.getElementById('orderDiscount').value) || 0;
            const notes = document.getElementById('orderNotes').value;
            
            // جمع عناصر الطلب
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('.order-item').forEach(itemDiv => {
                const productSelect = itemDiv.querySelector('.product-select');
                const productId = productSelect.value;
                const quantity = parseInt(itemDiv.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(itemDiv.querySelector('.price-input').value) || 0;
                
                if (productId && quantity > 0 && price > 0) {
                    const product = productsData.find(p => p.id === productId);
                    if (product) {
                        items.push({
                            productId: productId,
                            name: product.name,
                            quantity: quantity,
                            price: price
                        });
                        subtotal += price * quantity;
                        
                        // تحديث المخزون
                        product.stockQuantity -= quantity;
                        product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                    }
                }
            });
            
            if (items.length === 0) {
                showError(currentLanguage === 'ar' ? 'الرجاء إضافة منتجات للطلب' : 'Please add items to the order');
                return;
            }
            
            if (!customerId) {
                showError(currentLanguage === 'ar' ? 'الرجاء اختيار عميل' : 'Please select a customer');
                return;
            }
            
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) {
                showError(currentLanguage === 'ar' ? 'العميل غير موجود' : 'Customer not found');
                return;
            }
            
            const total = subtotal + shipping - discount;
            
            // إنشاء الطلب
            const order = {
                id: 'order-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                orderNumber: 'ORD-' + new Date().getFullYear() + '-' + (ordersData.length + 1001),
                customerId: customerId,
                customerName: customer.name,
                customerEmail: customer.email,
                items: items,
                subtotal: subtotal,
                shipping: shipping,
                discount: discount,
                total: total,
                status: status,
                paymentMethod: paymentMethod,
                shippingAddress: customer.address || '',
                orderDate: orderDate,
                notes: notes,
                createdAt: new Date().toISOString()
            };
            
            // حفظ الطلب
            ordersData.unshift(order);
            saveOrdersToLocal();
            
            // تحديث بيانات العميل
            customer.totalOrders = (customer.totalOrders || 0) + 1;
            customer.totalSpent = (customer.totalSpent || 0) + total;
            customer.lastOrder = orderDate;
            saveCustomersToLocal();
            
            // حفظ المنتجات (بعد تحديث المخزون)
            saveProductsToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم إضافة الطلب بنجاح' : 'Order added successfully');
            showOrders();
        }

        function viewOrderDetails(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            const statusText = {
                'pending': currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending',
                'processing': currentLanguage === 'ar' ? 'قيد المعالجة' : 'Processing',
                'shipped': currentLanguage === 'ar' ? 'تم الشحن' : 'Shipped',
                'completed': currentLanguage === 'ar' ? 'مكتمل' : 'Completed',
                'cancelled': currentLanguage === 'ar' ? 'ملغي' : 'Cancelled'
            };
            
            const itemsHTML = order.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatPriceWithCurrency(item.price)}</td>
                    <td>${formatPriceWithCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-file-invoice"></i> <span data-ar="تفاصيل الطلب: ${order.orderNumber}" data-en="Order Details: ${order.orderNumber}">تفاصيل الطلب: ${order.orderNumber}</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showOrders()">
                                <i class="fas fa-arrow-right"></i> <span data-ar="العودة للطلبات" data-en="Back to Orders">العودة للطلبات</span>
                            </button>
                            <button class="btn btn-warning" onclick="printOrder('${orderId}')">
                                <i class="fas fa-print"></i> <span data-ar="طباعة" data-en="Print">طباعة</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; max-width: 900px; margin: 0 auto;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--header-bg); margin-bottom: 15px;"><i class="fas fa-info-circle"></i> <span data-ar="معلومات الطلب" data-en="Order Information">معلومات الطلب</span></h4>
                                <p><strong data-ar="رقم الطلب:" data-en="Order Number:">رقم الطلب:</strong> ${order.orderNumber}</p>
                                <p><strong data-ar="التاريخ:" data-en="Date:">التاريخ:</strong> ${order.orderDate}</p>
                                <p><strong data-ar="الحالة:" data-en="Status:">الحالة:</strong> <span class="status-badge ${order.status}">${statusText[order.status]}</span></p>
                                <p><strong data-ar="طريقة الدفع:" data-en="Payment Method:">طريقة الدفع:</strong> ${order.paymentMethod}</p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <h4 style="color: var(--header-bg); margin-bottom: 15px;"><i class="fas fa-user"></i> <span data-ar="معلومات العميل" data-en="Customer Information">معلومات العميل</span></h4>
                                <p><strong data-ar="الاسم:" data-en="Name:">الاسم:</strong> ${order.customerName}</p>
                                <p><strong data-ar="البريد الإلكتروني:" data-en="Email:">البريد الإلكتروني:</strong> ${order.customerEmail}</p>
                                <p><strong data-ar="العنوان:" data-en="Address:">العنوان:</strong> ${order.shippingAddress || 'غير محدد'}</p>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--header-bg); margin: 30px 0 20px 0;"><i class="fas fa-shopping-cart"></i> <span data-ar="المنتجات المطلوبة" data-en="Order Items">المنتجات المطلوبة</span></h4>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="المنتج" data-en="Product">المنتج</th>
                                        <th data-ar="الكمية" data-en="Quantity">الكمية</th>
                                        <th data-ar="سعر الوحدة" data-en="Unit Price">سعر الوحدة</th>
                                        <th data-ar="المجموع" data-en="Total">المجموع</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px; max-width: 400px; margin-left: auto;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span data-ar="المجموع الفرعي:" data-en="Subtotal:">المجموع الفرعي:</span>
                                <span>${formatPriceWithCurrency(order.subtotal)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span data-ar="رسوم الشحن:" data-en="Shipping:">رسوم الشحن:</span>
                                <span>${formatPriceWithCurrency(order.shipping)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span data-ar="الخصم:" data-en="Discount:">الخصم:</span>
                                <span>${formatPriceWithCurrency(order.discount)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em; border-top: 2px solid #dee2e6; padding-top: 10px;">
                                <span data-ar="الإجمالي:" data-en="Total:">الإجمالي:</span>
                                <span>${formatPriceWithCurrency(order.total)}</span>
                            </div>
                        </div>
                        
                        ${order.notes ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                                <h4 style="color: var(--header-bg); margin-bottom: 15px;"><i class="fas fa-sticky-note"></i> <span data-ar="ملاحظات" data-en="Notes">ملاحظات</span></h4>
                                <p>${order.notes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="form-actions" style="margin-top: 30px;">
                            <button type="button" class="btn btn-primary" onclick="showOrders()">
                                <i class="fas fa-arrow-right"></i> <span data-ar="العودة للطلبات" data-en="Back to Orders">العودة للطلبات</span>
                            </button>
                            <button type="button" class="btn btn-warning" onclick="updateOrderStatus('${order.id}')">
                                <i class="fas fa-edit"></i> <span data-ar="تغيير الحالة" data-en="Change Status">تغيير الحالة</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function updateOrderStatus(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            const newStatus = prompt(currentLanguage === 'ar' ? 
                `تغيير حالة الطلب ${order.orderNumber}:\n\npending - قيد الانتظار\nprocessing - قيد المعالجة\nshipped - تم الشحن\ncompleted - مكتمل\ncancelled - ملغي\n\nأدخل الحالة الجديدة:` :
                `Change status for order ${order.orderNumber}:\n\npending - Pending\nprocessing - Processing\nshipped - Shipped\ncompleted - Completed\ncancelled - Cancelled\n\nEnter new status:`, 
                order.status);
            
            if (newStatus && ['pending', 'processing', 'shipped', 'completed', 'cancelled'].includes(newStatus)) {
                order.status = newStatus;
                
                // إذا تم إلغاء الطلب، إرجاع المنتجات للمخزون
                if (newStatus === 'cancelled' && order.status !== 'cancelled') {
                    order.items.forEach(item => {
                        const product = productsData.find(p => p.id === item.productId);
                        if (product) {
                            product.stockQuantity += item.quantity;
                            product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                        }
                    });
                    saveProductsToLocal();
                }
                
                saveOrdersToLocal();
                showSuccess(currentLanguage === 'ar' ? 'تم تحديث حالة الطلب بنجاح' : 'Order status updated successfully');
                showOrders(currentPage.orders);
            }
        }

        function deleteOrder(orderId) {
            if (!confirm(currentLanguage === 'ar' ? 'هل أنت متأكد من حذف هذا الطلب؟' : 'Are you sure you want to delete this order?')) {
                return;
            }
            
            const orderIndex = ordersData.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                const order = ordersData[orderIndex];
                
                // إرجاع المنتجات للمخزون
                order.items.forEach(item => {
                    const product = productsData.find(p => p.id === item.productId);
                    if (product) {
                        product.stockQuantity += item.quantity;
                        product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                    }
                });
                saveProductsToLocal();
                
                // تحديث بيانات العميل
                const customer = customersData.find(c => c.id === order.customerId);
                if (customer) {
                    customer.totalOrders = Math.max(0, (customer.totalOrders || 0) - 1);
                    customer.totalSpent = Math.max(0, (customer.totalSpent || 0) - order.total);
                    saveCustomersToLocal();
                }
                
                // حذف الطلب
                ordersData.splice(orderIndex, 1);
                saveOrdersToLocal();
                
                showSuccess(currentLanguage === 'ar' ? 'تم حذف الطلب بنجاح' : 'Order deleted successfully');
                showOrders(currentPage.orders);
            }
        }

        function printOrder(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>فاتورة الطلب ${order.orderNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #333; }
                        .info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                        .info div { flex: 1; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                        .total { text-align: left; margin-top: 20px; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>فاتورة الطلب</h1>
                        <h2>${order.orderNumber}</h2>
                    </div>
                    
                    <div class="info">
                        <div>
                            <h3>معلومات المتجر</h3>
                            <p>نظام إدارة المتجر الإلكتروني</p>
                            <p>البريد: info@store.com</p>
                            <p>الهاتف: 0123456789</p>
                        </div>
                        <div>
                            <h3>معلومات العميل</h3>
                            <p>الاسم: ${order.customerName}</p>
                            <p>البريد: ${order.customerEmail}</p>
                            <p>العنوان: ${order.shippingAddress}</p>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)} ر.س</td>
                                    <td>${(item.price * item.quantity).toFixed(2)} ر.س</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        <p><strong>المجموع الفرعي:</strong> ${order.subtotal.toFixed(2)} ر.س</p>
                        <p><strong>رسوم الشحن:</strong> ${order.shipping.toFixed(2)} ر.س</p>
                        <p><strong>الخصم:</strong> ${order.discount.toFixed(2)} ر.س</p>
                        <p><strong>الإجمالي:</strong> ${order.total.toFixed(2)} ر.س</p>
                    </div>
                    
                    <div class="footer">
                        <p>شكراً لثقتكم بنا</p>
                        <p>تاريخ الطباعة: ${new Date().toLocaleString('ar-SA')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportOrdersToExcel() {
            try {
                showLoading(true);
                
                const ws = XLSX.utils.json_to_sheet(ordersData.map(order => ({
                    [currentLanguage === 'ar' ? 'رقم الطلب' : 'Order Number']: order.orderNumber,
                    [currentLanguage === 'ar' ? 'اسم العميل' : 'Customer Name']: order.customerName,
                    [currentLanguage === 'ar' ? 'التاريخ' : 'Date']: order.orderDate,
                    [currentLanguage === 'ar' ? 'عدد المنتجات' : 'Items Count']: order.items.length,
                    [currentLanguage === 'ar' ? 'المجموع الفرعي' : 'Subtotal']: order.subtotal,
                    [currentLanguage === 'ar' ? 'رسوم الشحن' : 'Shipping']: order.shipping,
                    [currentLanguage === 'ar' ? 'الخصم' : 'Discount']: order.discount,
                    [currentLanguage === 'ar' ? 'الإجمالي' : 'Total']: order.total,
                    [currentLanguage === 'ar' ? 'الحالة' : 'Status']: order.status,
                    [currentLanguage === 'ar' ? 'طريقة الدفع' : 'Payment Method']: order.paymentMethod
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'ar' ? 'الطلبات' : 'Orders');
                
                const fileName = currentLanguage === 'ar' ? 
                    `طلبات_${new Date().toISOString().split('T')[0]}.xlsx` :
                    `orders_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                
                showLoading(false);
                showSuccess(currentLanguage === 'ar' ? 
                    'تم تصدير الطلبات بنجاح' : 
                    'Orders exported successfully');
            } catch (error) {
                showLoading(false);
                showError((currentLanguage === 'ar' ? 'فشل التصدير: ' : 'Export failed: ') + error.message);
            }
        }

        function renderOrdersByStatusChart() {
            const ctx = document.getElementById('ordersByStatusChart')?.getContext('2d');
            if (!ctx) return;
            
            // تجميع الطلبات حسب الحالة
            const statusCounts = {
                'pending': 0,
                'processing': 0,
                'shipped': 0,
                'completed': 0,
                'cancelled': 0
            };
            
            ordersData.forEach(order => {
                statusCounts[order.status] = (statusCounts[order.status] || 0) + 1;
            });
            
            const statusText = currentLanguage === 'ar' ? {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            } : {
                'pending': 'Pending',
                'processing': 'Processing',
                'shipped': 'Shipped',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            
            const labels = Object.keys(statusCounts).map(key => statusText[key]);
            const data = Object.values(statusCounts);
            
            // ألوان للحالات
            const backgroundColors = [
                '#fff3cd', // pending - أصفر
                '#cce5ff', // processing - أزرق
                '#d1ecf1', // shipped - أزرق فاتح
                '#d4edda', // completed - أخضر
                '#f8d7da'  // cancelled - أحمر
            ];
            
            const borderColors = [
                '#856404', '#004085', '#0c5460', '#155724', '#721c24'
            ];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // دوال إدارة التصنيفات
        // ============================================
        function showCategories() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(3)').classList.add('active');
            
            const categoriesHTML = categoriesData.map(category => {
                const categoryProducts = productsData.filter(p => p.categoryId === category.id);
                const totalValue = categoryProducts.reduce((sum, p) => sum + (p.salePrice * p.stockQuantity), 0);
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: var(--primary-color);">
                                    <i class="${category.icon || 'fas fa-folder'}"></i>
                                </div>
                                <div>
                                    <div style="font-weight: bold;">${category.name}</div>
                                    <div style="font-size: 12px; color: #666;">${category.description}</div>
                                </div>
                            </div>
                        </td>
                        <td>${categoryProducts.length}</td>
                        <td>${formatPriceWithCurrency(totalValue)}</td>
                        <td>${new Date(category.createdAt).toLocaleDateString('ar-SA')}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-info" onclick="editCategory('${category.id}')" title="${currentLanguage === 'ar' ? 'تعديل' : 'Edit'}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category.id}')" title="${currentLanguage === 'ar' ? 'حذف' : 'Delete'}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-tags"></i> <span data-ar="إدارة التصنيفات" data-en="Categories Management">إدارة التصنيفات</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addNewCategory()">
                                <i class="fas fa-plus"></i> <span data-ar="إضافة تصنيف جديد" data-en="Add New Category">إضافة تصنيف جديد</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--primary-color);">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${categoriesData.length}</h3>
                                    <p data-ar="إجمالي التصنيفات" data-en="Total Categories">إجمالي التصنيفات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--product-color);">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.length}</h3>
                                    <p data-ar="إجمالي المنتجات" data-en="Total Products">إجمالي المنتجات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${categoriesData.filter(c => c.productCount > 0).length}</h3>
                                    <p data-ar="تصنيفات نشطة" data-en="Active Categories">تصنيفات نشطة</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--warning-color);">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${categoriesData.filter(c => c.productCount === 0).length}</h3>
                                    <p data-ar="تصنيفات فارغة" data-en="Empty Categories">تصنيفات فارغة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="التصنيف" data-en="Category">التصنيف</th>
                                        <th data-ar="عدد المنتجات" data-en="Products Count">عدد المنتجات</th>
                                        <th data-ar="القيمة الإجمالية" data-en="Total Value">القيمة الإجمالية</th>
                                        <th data-ar="تاريخ الإضافة" data-en="Created Date">تاريخ الإضافة</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${categoriesHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function addNewCategory() {
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-plus-circle"></i> <span data-ar="إضافة تصنيف جديد" data-en="Add New Category">إضافة تصنيف جديد</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="showCategories()">
                                <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
                        <form id="newCategoryForm" onsubmit="event.preventDefault(); saveNewCategory();">
                            <div class="form-group">
                                <label class="form-label required" data-ar="اسم التصنيف" data-en="Category Name">اسم التصنيف</label>
                                <input type="text" class="form-input" id="categoryName" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" data-ar="وصف التصنيف" data-en="Category Description">وصف التصنيف</label>
                                <textarea class="form-textarea" id="categoryDescription" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" data-ar="أيقونة التصنيف" data-en="Category Icon">أيقونة التصنيف</label>
                                <select class="form-select" id="categoryIcon">
                                    <option value="fas fa-folder">📁 مجلد</option>
                                    <option value="fas fa-laptop">💻 لابتوب</option>
                                    <option value="fas fa-mobile-alt">📱 جوال</option>
                                    <option value="fas fa-tshirt">👕 ملابس</option>
                                    <option value="fas fa-shoe-prints">👟 أحذية</option>
                                    <option value="fas fa-book">📚 كتاب</option>
                                    <option value="fas fa-home">🏠 منزل</option>
                                    <option value="fas fa-utensils">🍴 أدوات مطبخ</option>
                                    <option value="fas fa-heart">❤️ صحة وجمال</option>
                                    <option value="fas fa-car">🚗 سيارات</option>
                                    <option value="fas fa-gamepad">🎮 ألعاب</option>
                                    <option value="fas fa-music">🎵 موسيقى</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" onclick="showCategories()">
                                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> <span data-ar="حفظ التصنيف" data-en="Save Category">حفظ التصنيف</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function saveNewCategory() {
            const categoryName = document.getElementById('categoryName').value;
            const categoryDescription = document.getElementById('categoryDescription').value;
            const categoryIcon = document.getElementById('categoryIcon').value;
            
            if (!categoryName) {
                showError(currentLanguage === 'ar' ? 'الرجاء إدخال اسم التصنيف' : 'Please enter category name');
                return;
            }
            
            // التحقق من عدم تكرار اسم التصنيف
            const existingCategory = categoriesData.find(c => c.name === categoryName);
            if (existingCategory) {
                showError(currentLanguage === 'ar' ? 'اسم التصنيف موجود مسبقاً' : 'Category name already exists');
                return;
            }
            
            const newCategory = {
                id: 'category-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                name: categoryName,
                description: categoryDescription,
                icon: categoryIcon,
                createdAt: new Date().toISOString(),
                productCount: 0
            };
            
            categoriesData.push(newCategory);
            saveCategoriesToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم إضافة التصنيف بنجاح' : 'Category added successfully');
            showCategories();
        }

        function editCategory(categoryId) {
            const category = categoriesData.find(c => c.id === categoryId);
            if (!category) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-edit"></i> <span data-ar="تعديل التصنيف" data-en="Edit Category">تعديل التصنيف</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="showCategories()">
                                <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
                        <form id="editCategoryForm" onsubmit="event.preventDefault(); updateCategory('${categoryId}');">
                            <div class="form-group">
                                <label class="form-label required" data-ar="اسم التصنيف" data-en="Category Name">اسم التصنيف</label>
                                <input type="text" class="form-input" id="editCategoryName" value="${category.name}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" data-ar="وصف التصنيف" data-en="Category Description">وصف التصنيف</label>
                                <textarea class="form-textarea" id="editCategoryDescription" rows="3">${category.description}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" data-ar="أيقونة التصنيف" data-en="Category Icon">أيقونة التصنيف</label>
                                <select class="form-select" id="editCategoryIcon">
                                    <option value="fas fa-folder" ${category.icon === 'fas fa-folder' ? 'selected' : ''}>📁 مجلد</option>
                                    <option value="fas fa-laptop" ${category.icon === 'fas fa-laptop' ? 'selected' : ''}>💻 لابتوب</option>
                                    <option value="fas fa-mobile-alt" ${category.icon === 'fas fa-mobile-alt' ? 'selected' : ''}>📱 جوال</option>
                                    <option value="fas fa-tshirt" ${category.icon === 'fas fa-tshirt' ? 'selected' : ''}>👕 ملابس</option>
                                    <option value="fas fa-shoe-prints" ${category.icon === 'fas fa-shoe-prints' ? 'selected' : ''}>👟 أحذية</option>
                                    <option value="fas fa-book" ${category.icon === 'fas fa-book' ? 'selected' : ''}>📚 كتاب</option>
                                    <option value="fas fa-home" ${category.icon === 'fas fa-home' ? 'selected' : ''}>🏠 منزل</option>
                                    <option value="fas fa-utensils" ${category.icon === 'fas fa-utensils' ? 'selected' : ''}>🍴 أدوات مطبخ</option>
                                    <option value="fas fa-heart" ${category.icon === 'fas fa-heart' ? 'selected' : ''}>❤️ صحة وجمال</option>
                                    <option value="fas fa-car" ${category.icon === 'fas fa-car' ? 'selected' : ''}>🚗 سيارات</option>
                                    <option value="fas fa-gamepad" ${category.icon === 'fas fa-gamepad' ? 'selected' : ''}>🎮 ألعاب</option>
                                    <option value="fas fa-music" ${category.icon === 'fas fa-music' ? 'selected' : ''}>🎵 موسيقى</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" onclick="showCategories()">
                                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> <span data-ar="حفظ التعديلات" data-en="Save Changes">حفظ التعديلات</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            updateAllTexts();
        }

        function updateCategory(categoryId) {
            const categoryIndex = categoriesData.findIndex(c => c.id === categoryId);
            if (categoryIndex === -1) return;
            
            const categoryName = document.getElementById('editCategoryName').value;
            const categoryDescription = document.getElementById('editCategoryDescription').value;
            const categoryIcon = document.getElementById('editCategoryIcon').value;
            
            if (!categoryName) {
                showError(currentLanguage === 'ar' ? 'الرجاء إدخال اسم التصنيف' : 'Please enter category name');
                return;
            }
            
            // التحقق من عدم تكرار اسم التصنيف (باستثناء التصنيف الحالي)
            const nameExists = categoriesData.some((c, index) => 
                index !== categoryIndex && c.name === categoryName
            );
            
            if (nameExists) {
                showError(currentLanguage === 'ar' ? 'اسم التصنيف موجود مسبقاً' : 'Category name already exists');
                return;
            }
            
            categoriesData[categoryIndex] = {
                ...categoriesData[categoryIndex],
                name: categoryName,
                description: categoryDescription,
                icon: categoryIcon,
                updatedAt: new Date().toISOString()
            };
            
            saveCategoriesToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم تحديث التصنيف بنجاح' : 'Category updated successfully');
            showCategories();
        }

        function deleteCategory(categoryId) {
            const category = categoriesData.find(c => c.id === categoryId);
            if (!category) return;
            
            // التحقق من وجود منتجات في هذا التصنيف
            const categoryProducts = productsData.filter(p => p.categoryId === categoryId);
            
            if (categoryProducts.length > 0) {
                if (!confirm(currentLanguage === 'ar' ? 
                    `هذا التصنيف يحتوي على ${categoryProducts.length} منتج. هل تريد نقلها إلى تصنيف آخر قبل الحذف؟` : 
                    `This category contains ${categoryProducts.length} products. Move them to another category before deleting?`)) {
                    return;
                }
                
                // عرض قائمة التصنيفات لنقل المنتجات
                let optionsHTML = '<option value="">اختر تصنيف جديد</option>';
                categoriesData
                    .filter(c => c.id !== categoryId)
                    .forEach(c => {
                        optionsHTML += `<option value="${c.id}">${c.name}</option>`;
                    });
                
                const newCategoryId = prompt(currentLanguage === 'ar' ? 
                    `اختر تصنيف جديد للمنتجات:\n\n${optionsHTML.replace(/<[^>]*>/g, '\n')}` :
                    `Select new category for products:\n\n${optionsHTML.replace(/<[^>]*>/g, '\n')}`);
                
                if (!newCategoryId) {
                    showError(currentLanguage === 'ar' ? 'الرجاء اختيار تصنيف جديد' : 'Please select a new category');
                    return;
                }
                
                // نقل المنتجات للتصنيف الجديد
                productsData.forEach(product => {
                    if (product.categoryId === categoryId) {
                        product.categoryId = newCategoryId;
                    }
                });
                saveProductsToLocal();
                
                // تحديث عدد المنتجات في التصنيفات
                updateCategoryCounts();
            }
            
            // حذف التصنيف
            categoriesData = categoriesData.filter(c => c.id !== categoryId);
            saveCategoriesToLocal();
            
            showSuccess(currentLanguage === 'ar' ? 'تم حذف التصنيف بنجاح' : 'Category deleted successfully');
            showCategories();
        }

        // ============================================
        // دوال إدارة المخزون
        // ============================================
        function showInventory() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(6)').classList.add('active');
            
            // حساب إحصائيات المخزون
            const totalStockValue = productsData.reduce((sum, p) => sum + (p.purchasePrice * p.stockQuantity), 0);
            const totalSaleValue = productsData.reduce((sum, p) => sum + (p.salePrice * p.stockQuantity), 0);
            const potentialProfit = totalSaleValue - totalStockValue;
            const lowStockCount = productsData.filter(p => p.status === 'low-stock').length;
            const outOfStockCount = productsData.filter(p => p.status === 'out-of-stock').length;
            
            let inventoryHTML = productsData.map(product => {
                const category = categoriesData.find(c => c.id === product.categoryId);
                const stockValue = product.purchasePrice * product.stockQuantity;
                const saleValue = product.salePrice * product.stockQuantity;
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; border-radius: 8px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    ${product.images ? 
                                        `<img src="${product.images.split(',')[0]}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                        `<i class="fas fa-box" style="font-size: 16px; color: #666;"></i>`
                                    }
                                </div>
                                <div>
                                    <div style="font-weight: bold;">${product.name}</div>
                                    <div style="font-size: 12px; color: #666;">${product.code}</div>
                                </div>
                            </div>
                        </td>
                        <td>${category ? category.name : 'غير مصنف'}</td>
                        <td>
                            <span class="stock-badge ${product.status}">
                                ${currentLanguage === 'ar' ? 
                                    (product.status === 'in-stock' ? 'متوفر' : 
                                     product.status === 'low-stock' ? 'منخفض' : 'نفذ') :
                                    (product.status === 'in-stock' ? 'In Stock' : 
                                     product.status === 'low-stock' ? 'Low Stock' : 'Out of Stock')
                                }
                            </span>
                        </td>
                        <td>${product.stockQuantity}</td>
                        <td>${product.minStock}</td>
                        <td>${formatPriceWithCurrency(stockValue)}</td>
                        <td>${formatPriceWithCurrency(saleValue)}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-warning" onclick="updateProductStock('${product.id}')" title="${currentLanguage === 'ar' ? 'إضافة مخزون' : 'Add Stock'}">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-info" onclick="adjustProductStock('${product.id}')" title="${currentLanguage === 'ar' ? 'تعديل المخزون' : 'Adjust Stock'}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-warehouse"></i> <span data-ar="إدارة المخزون" data-en="Inventory Management">إدارة المخزون</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="showProducts()">
                                <i class="fas fa-box"></i> <span data-ar="المنتجات" data-en="Products">المنتجات</span>
                            </button>
                            <button class="btn btn-warning" onclick="showLowStockAlerts()">
                                <i class="fas fa-exclamation-triangle"></i> <span data-ar="تنبيهات المخزون" data-en="Stock Alerts">تنبيهات المخزون</span>
                            </button>
                            <button class="btn btn-info" onclick="exportInventoryReport()">
                                <i class="fas fa-download"></i> <span data-ar="تقرير المخزون" data-en="Inventory Report">تقرير المخزون</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--product-color);">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.reduce((sum, p) => sum + p.stockQuantity, 0)}</h3>
                                    <p data-ar="إجمالي الوحدات" data-en="Total Units">إجمالي الوحدات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${formatPriceWithCurrency(totalStockValue)}</h3>
                                    <p data-ar="قيمة المخزون" data-en="Inventory Value">قيمة المخزون</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--warning-color);">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${lowStockCount}</h3>
                                    <p data-ar="منتجات منخفضة" data-en="Low Stock Items">منتجات منخفضة</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--danger-color);">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${outOfStockCount}</h3>
                                    <p data-ar="منتجات نفذت" data-en="Out of Stock">منتجات نفذت</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3 class="chart-title"><i class="fas fa-chart-bar"></i> <span data-ar="تحليل قيمة المخزون" data-en="Inventory Value Analysis">تحليل قيمة المخزون</span></h3>
                            <canvas id="inventoryValueChart" width="400" height="200"></canvas>
                        </div>
                        
                        <h3 style="color: var(--header-bg); margin: 30px 0 20px 0;"><i class="fas fa-list"></i> <span data-ar="تفاصيل المخزون" data-en="Inventory Details">تفاصيل المخزون</span></h3>
                        
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-ar="المنتج" data-en="Product">المنتج</th>
                                        <th data-ar="التصنيف" data-en="Category">التصنيف</th>
                                        <th data-ar="الحالة" data-en="Status">الحالة</th>
                                        <th data-ar="الكمية الحالية" data-en="Current Stock">الكمية الحالية</th>
                                        <th data-ar="الحد الأدنى" data-en="Minimum Stock">الحد الأدنى</th>
                                        <th data-ar="قيمة التكلفة" data-en="Cost Value">قيمة التكلفة</th>
                                        <th data-ar="قيمة البيع" data-en="Sale Value">قيمة البيع</th>
                                        <th data-ar="الإجراءات" data-en="Actions">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inventoryHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                            <h4 style="color: var(--header-bg); margin-bottom: 15px;"><i class="fas fa-chart-line"></i> <span data-ar="ملخص المخزون" data-en="Inventory Summary">ملخص المخزون</span></h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <p><strong data-ar="إجمالي قيمة المخزون (التكلفة):" data-en="Total Inventory Value (Cost):">إجمالي قيمة المخزون (التكلفة):</strong> ${formatPriceWithCurrency(totalStockValue)}</p>
                                    <p><strong data-ar="إجمالي قيمة المخزون (البيع):" data-en="Total Inventory Value (Sale):">إجمالي قيمة المخزون (البيع):</strong> ${formatPriceWithCurrency(totalSaleValue)}</p>
                                </div>
                                <div>
                                    <p><strong data-ar="الربح المحتمل:" data-en="Potential Profit:">الربح المحتمل:</strong> ${formatPriceWithCurrency(potentialProfit)}</p>
                                    <p><strong data-ar="هامش الربح:" data-en="Profit Margin:">هامش الربح:</strong> ${totalStockValue > 0 ? ((potentialProfit / totalStockValue) * 100).toFixed(1) : 0}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // رسم مخطط قيمة المخزون
            setTimeout(() => {
                renderInventoryValueChart();
                updateAllTexts();
            }, 100);
        }

        function adjustProductStock(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            const newStock = prompt(currentLanguage === 'ar' ? 
                `تعديل مخزون المنتج: ${product.name}\nالمخزون الحالي: ${product.stockQuantity}\nأدخل الكمية الجديدة:` :
                `Adjust stock for: ${product.name}\nCurrent stock: ${product.stockQuantity}\nEnter new quantity:`, 
                product.stockQuantity);
            
            if (newStock !== null && !isNaN(newStock) && parseInt(newStock) >= 0) {
                product.stockQuantity = parseInt(newStock);
                product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                saveProductsToLocal();
                showSuccess(currentLanguage === 'ar' ? 
                    `تم تحديث مخزون ${product.name} إلى ${product.stockQuantity}` :
                    `Stock updated for ${product.name} to ${product.stockQuantity}`);
                showInventory();
            }
        }

        function updateProductStock(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            const addStock = prompt(currentLanguage === 'ar' ? 
                `إضافة مخزون للمنتج: ${product.name}\nالمخزون الحالي: ${product.stockQuantity}\nأدخل الكمية المراد إضافتها:` :
                `Add stock for: ${product.name}\nCurrent stock: ${product.stockQuantity}\nEnter quantity to add:`, "10");
            
            if (addStock && !isNaN(addStock) && parseInt(addStock) > 0) {
                product.stockQuantity += parseInt(addStock);
                product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                saveProductsToLocal();
                showSuccess(currentLanguage === 'ar' ? 
                    `تم تحديث مخزون ${product.name} إلى ${product.stockQuantity}` :
                    `Stock updated for ${product.name} to ${product.stockQuantity}`);
                showInventory();
            }
        }

        function renderInventoryValueChart() {
            const ctx = document.getElementById('inventoryValueChart')?.getContext('2d');
            if (!ctx) return;
            
            // تجميع قيمة المخزون حسب التصنيف
            const categoryValues = {};
            productsData.forEach(product => {
                const category = categoriesData.find(c => c.id === product.categoryId);
                const categoryName = category ? category.name : currentLanguage === 'ar' ? 'غير مصنف' : 'Uncategorized';
                const value = product.purchasePrice * product.stockQuantity;
                
                if (!categoryValues[categoryName]) {
                    categoryValues[categoryName] = 0;
                }
                categoryValues[categoryName] += value;
            });
            
            const labels = Object.keys(categoryValues);
            const data = Object.values(categoryValues);
            
            // ألوان عشوائية
            const backgroundColors = labels.map(() => 
                `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`
            );
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentLanguage === 'ar' ? 'قيمة المخزون' : 'Inventory Value',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('60%)', '40%)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatPriceWithCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportInventoryReport() {
            try {
                showLoading(true);
                
                const ws = XLSX.utils.json_to_sheet(productsData.map(product => {
                    const category = categoriesData.find(c => c.id === product.categoryId);
                    const stockValue = product.purchasePrice * product.stockQuantity;
                    const saleValue = product.salePrice * product.stockQuantity;
                    
                    return {
                        [currentLanguage === 'ar' ? 'اسم المنتج' : 'Product Name']: product.name,
                        [currentLanguage === 'ar' ? 'الرمز' : 'Code']: product.code,
                        [currentLanguage === 'ar' ? 'التصنيف' : 'Category']: category ? category.name : '',
                        [currentLanguage === 'ar' ? 'الكمية الحالية' : 'Current Stock']: product.stockQuantity,
                        [currentLanguage === 'ar' ? 'الحد الأدنى' : 'Minimum Stock']: product.minStock,
                        [currentLanguage === 'ar' ? 'الحالة' : 'Status']: product.status === 'in-stock' ? 
                            (currentLanguage === 'ar' ? 'متوفر' : 'In Stock') : 
                            product.status === 'low-stock' ? (currentLanguage === 'ar' ? 'منخفض' : 'Low Stock') : 
                            (currentLanguage === 'ar' ? 'نفذ' : 'Out of Stock'),
                        [currentLanguage === 'ar' ? 'سعر الشراء' : 'Purchase Price']: product.purchasePrice,
                        [currentLanguage === 'ar' ? 'سعر البيع' : 'Sale Price']: product.salePrice,
                        [currentLanguage === 'ar' ? 'قيمة التكلفة' : 'Cost Value']: stockValue,
                        [currentLanguage === 'ar' ? 'قيمة البيع' : 'Sale Value']: saleValue,
                        [currentLanguage === 'ar' ? 'الربح المحتمل' : 'Potential Profit']: saleValue - stockValue
                    };
                }));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'ar' ? 'المخزون' : 'Inventory');
                
                const fileName = currentLanguage === 'ar' ? 
                    `تقرير_المخزون_${new Date().toISOString().split('T')[0]}.xlsx` :
                    `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                
                showLoading(false);
                showSuccess(currentLanguage === 'ar' ? 
                    'تم تصدير تقرير المخزون بنجاح' : 
                    'Inventory report exported successfully');
            } catch (error) {
                showLoading(false);
                showError((currentLanguage === 'ar' ? 'فشل التصدير: ' : 'Export failed: ') + error.message);
            }
        }

        // ============================================
        // دوال إضافية
        // ============================================
        function calculateStockStatus(stockQuantity, minStock) {
            if (stockQuantity <= 0) {
                return 'out-of-stock';
            } else if (stockQuantity <= minStock) {
                return 'low-stock';
            } else {
                return 'in-stock';
            }
        }

        function formatPriceWithCurrency(priceInSAR) {
            const convertedPrice = convertPrice(priceInSAR);
            return formatPrice(convertedPrice);
        }

        function convertPrice(priceInSAR) {
            const rate = exchangeRates[currentCurrency]?.rate || 1;
            return priceInSAR * rate;
        }

        function formatPrice(price) {
            const currency = exchangeRates[currentCurrency];
            if (!currency) return `${price.toFixed(2)} ر.س`;
            
            return `${price.toFixed(2)} ${currency.symbol}`;
        }

        // ============================================
        // تهيئة النظام عند التحميل
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل التفضيلات والبيانات
            loadPreferences();
            loadAllLocalData();
            populateCurrencyDropdowns();
            applyPreferences();
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
            
            console.log('System initialized successfully');
        });

        function setupEventListeners() {
            // إعداد نموذج تسجيل الدخول
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // إغلاق القوائم المنسدلة عند النقر خارجها
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.currency-dropdown')) {
                    closeAllCurrencyDropdowns();
                }
                
                // إغلاق الشريط الجانبي على الجوال
                const sidebar = document.getElementById('sidebar');
                const mobileToggle = document.getElementById('mobileMenuToggle');
                
                if (sidebar && mobileToggle && 
                    sidebar.classList.contains('active') &&
                    !sidebar.contains(event.target) && 
                    !mobileToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            });
            
            // زر القائمة للجوال
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
            }
        }

        // ============================================
        // دوال إضافية لاستكمال النظام
        // ============================================

        // دالة عرض لوحة التحكم
        function showDashboard() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:nth-child(1)').classList.add('active');
            
            // حساب الإحصائيات
            const totalRevenue = ordersData.reduce((sum, order) => sum + order.total, 0);
            const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
            const lowStockProducts = productsData.filter(p => p.status === 'low-stock').length;
            const newCustomersThisMonth = customersData.filter(c => {
                const createdDate = new Date(c.createdAt);
                const now = new Date();
                return createdDate.getMonth() === now.getMonth() && 
                       createdDate.getFullYear() === now.getFullYear();
            }).length;
            
            // حساب المبيعات خلال آخر 7 أيام
            const last7DaysSales = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const daySales = ordersData
                    .filter(o => o.orderDate === dateStr)
                    .reduce((sum, o) => sum + o.total, 0);
                
                last7DaysSales.push({
                    date: date.toLocaleDateString('ar-SA', { weekday: 'short' }),
                    sales: daySales
                });
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-home"></i> <span data-ar="لوحة التحكم" data-en="Dashboard">لوحة التحكم</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt"></i> <span data-ar="تحديث" data-en="Refresh">تحديث</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--order-color);">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${ordersData.length}</h3>
                                    <p data-ar="إجمالي الطلبات" data-en="Total Orders">إجمالي الطلبات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--success-color);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${formatPriceWithCurrency(totalRevenue)}</h3>
                                    <p data-ar="إجمالي المبيعات" data-en="Total Revenue">إجمالي المبيعات</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--customer-color);">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customersData.length}</h3>
                                    <p data-ar="إجمالي العملاء" data-en="Total Customers">إجمالي العملاء</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--product-color);">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.length}</h3>
                                    <p data-ar="إجمالي المنتجات" data-en="Total Products">إجمالي المنتجات</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                            <div class="chart-container">
                                <h3 class="chart-title"><i class="fas fa-chart-line"></i> <span data-ar="المبيعات خلال آخر 7 أيام" data-en="Sales Last 7 Days">المبيعات خلال آخر 7 أيام</span></h3>
                                <canvas id="salesChart" width="400" height="200"></canvas>
                            </div>
                            
                            <div class="chart-container">
                                <h3 class="chart-title"><i class="fas fa-chart-pie"></i> <span data-ar="توزيع الطلبات" data-en="Orders Distribution">توزيع الطلبات</span></h3>
                                <canvas id="ordersChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow-light);">
                                <h4 style="color: var(--header-bg); margin-bottom: 15px;"><i class="fas fa-exclamation-triangle"></i> <span data-ar="تنبيهات سريعة" data-en="Quick Alerts">تنبيهات سريعة</span></h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    ${pendingOrders > 0 ? `
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                            <i class="fas fa-clock" style="color: #856404;"></i>
                                            <div>
                                                <div style="font-weight: bold;">${pendingOrders} ${currentLanguage === 'ar' ? 'طلبات قيد الانتظار' : 'Pending Orders'}</div>
                                                <div style="font-size: 12px; color: #856404;">${currentLanguage === 'ar' ? 'تحتاج إلى معالجة' : 'Need processing'}</div>
                                            </div>
                                            <button class="btn btn-sm btn-warning" onclick="showOrders()" style="margin-left: auto;">${currentLanguage === 'ar' ? 'عرض' : 'View'}</button>
                                        </div>
                                    ` : ''}
                                    
                                    ${lowStockProducts > 0 ? `
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                            <i class="fas fa-exclamation-circle" style="color: #856404;"></i>
                                            <div>
                                                <div style="font-weight: bold;">${lowStockProducts} ${currentLanguage === 'ar' ? 'منتجات منخفضة المخزون' : 'Low Stock Products'}</div>
                                                <div style="font-size: 12px; color: #856404;">${currentLanguage === 'ar' ? 'تحتاج إلى إعادة تخزين' : 'Need restocking'}</div>
                                            </div>
                                            <button class="btn btn-sm btn-warning" onclick="showLowStockAlerts()" style="margin-left: auto;">${currentLanguage === 'ar' ? 'عرض' : 'View'}</button>
                                        </div>
                                    ` : ''}
                                    
                                    ${newCustomersThisMonth > 0 ? `
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #d4edda; border-radius: 8px;">
                                            <i class="fas fa-user-plus" style="color: #155724;"></i>
                                            <div>
                                                <div style="font-weight: bold;">${newCustomersThisMonth} ${currentLanguage === 'ar' ? 'عملاء جدد هذا الشهر' : 'New Customers This Month'}</div>
                                                <div style="font-size: 12px; color: #155724;">${currentLanguage === 'ar' ? 'زيادة في قاعدة العملاء' : 'Customer base growth'}</div>
                                            </div>
                                            <button class="btn btn-sm btn-success" onclick="showCustomers()" style="margin-left: auto;">${currentLanguage === 'ar' ? 'عرض' : 'View'}</button>
                                        </div>
                                    ` : ''}
                                    
                                    ${!pendingOrders && !lowStockProducts && !newCustomersThisMonth ? `
                                        <div style="text-align: center; padding: 20px; color: #666;">
                                            <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; color: #d4edda;"></i>
                                            <p>${currentLanguage === 'ar' ? 'لا توجد تنبيهات حالياً' : 'No alerts at the moment'}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow-light);">
                                <h4 style="color: var(--header-bg); margin-bottom: 15px;"><i class="fas fa-bolt"></i> <span data-ar="إجراءات سريعة" data-en="Quick Actions">إجراءات سريعة</span></h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <button class="btn btn-primary" onclick="addNewProduct()" style="display: flex; flex-direction: column; align-items: center; padding: 15px;">
                                        <i class="fas fa-plus" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                        <span data-ar="إضافة منتج" data-en="Add Product">إضافة منتج</span>
                                    </button>
                                    <button class="btn btn-success" onclick="addNewOrder()" style="display: flex; flex-direction: column; align-items: center; padding: 15px;">
                                        <i class="fas fa-shopping-cart" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                        <span data-ar="إضافة طلب" data-en="Add Order">إضافة طلب</span>
                                    </button>
                                    <button class="btn btn-info" onclick="showReports()" style="display: flex; flex-direction: column; align-items: center; padding: 15px;">
                                        <i class="fas fa-chart-bar" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                        <span data-ar="التقارير" data-en="Reports">التقارير</span>
                                    </button>
                                    <button class="btn btn-warning" onclick="showBackupRestore()" style="display: flex; flex-direction: column; align-items: center; padding: 15px;">
                                        <i class="fas fa-database" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                        <span data-ar="نسخ احتياطي" data-en="Backup">نسخ احتياطي</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // رسم الرسوم البيانية
            setTimeout(() => {
                renderDashboardCharts(last7DaysSales);
                updateAllTexts();
            }, 100);
        }

        function refreshDashboard() {
            showDashboard();
        }

        function renderDashboardCharts(last7DaysSales) {
            // مخطط المبيعات خلال آخر 7 أيام
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            if (salesCtx) {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: last7DaysSales.map(day => day.date),
                        datasets: [{
                            label: currentLanguage === 'ar' ? 'المبيعات' : 'Sales',
                            data: last7DaysSales.map(day => day.sales),
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatPriceWithCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // مخطط توزيع الطلبات
            const ordersCtx = document.getElementById('ordersChart')?.getContext('2d');
            if (ordersCtx) {
                const statusCounts = {
                    'completed': ordersData.filter(o => o.status === 'completed').length,
                    'pending': ordersData.filter(o => o.status === 'pending').length,
                    'processing': ordersData.filter(o => o.status === 'processing').length,
                    'shipped': ordersData.filter(o => o.status === 'shipped').length,
                    'cancelled': ordersData.filter(o => o.status === 'cancelled').length
                };
                
                const statusText = currentLanguage === 'ar' ? {
                    'completed': 'مكتمل',
                    'pending': 'قيد الانتظار',
                    'processing': 'قيد المعالجة',
                    'shipped': 'تم الشحن',
                    'cancelled': 'ملغي'
                } : {
                    'completed': 'Completed',
                    'pending': 'Pending',
                    'processing': 'Processing',
                    'shipped': 'Shipped',
                    'cancelled': 'Cancelled'
                };
                
                const labels = Object.keys(statusCounts).map(key => statusText[key]);
                const data = Object.values(statusCounts);
                
                new Chart(ordersCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#d4edda',
                                '#fff3cd',
                                '#cce5ff',
                                '#d1ecf1',
                                '#f8d7da'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                rtl: currentLanguage === 'ar'
                            }
                        }
                    }
                });
            }
        }
        // ============================================
// دوال عرض الصفحات الرئيسية
// ============================================

function showDashboard() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(1)').classList.add('active');
    
    // تحديث الإحصائيات
    updateStats();
    updateRecentData();
    
    document.getElementById('contentArea').innerHTML = `
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon orders">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalOrders">0</h3>
                    <p>إجمالي الطلبات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon products">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalProducts">0</h3>
                    <p>المنتجات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon customers">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalCustomers">0</h3>
                    <p>العملاء</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon revenue">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">0 ر.س</h3>
                    <p>الإيرادات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="pendingOrders">0</h3>
                    <p>طلبات معلقة</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon categories">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalCategories">0</h3>
                    <p>التصنيفات</p>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-line"></i> <span>نظرة عامة على المتجر</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showProducts()">
                        <i class="fas fa-box"></i> <span>إدارة المنتجات</span>
                    </button>
                    <button class="btn btn-success" onclick="showOrders()">
                        <i class="fas fa-shopping-cart"></i> <span>إدارة الطلبات</span>
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div>
                    <h4 style="color: var(--header-bg); margin-bottom: 15px;">آخر الطلبات</h4>
                    <div id="recentOrdersTable">
                        <p>جاري تحميل الطلبات...</p>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--header-bg); margin-bottom: 15px;">المنتجات منخفضة المخزون</h4>
                    <div id="lowStockProducts">
                        <p>جاري تحميل المنتجات...</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="color: var(--header-bg); margin-bottom: 15px;">إحصائيات المبيعات</h4>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <canvas id="salesChart" height="100"></canvas>
                </div>
            </div>
        </div>
    `;
    
    // تحميل البيانات بعد العرض
    setTimeout(() => {
        loadDashboardCharts();
    }, 100);
}

function showProducts() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(2)').classList.add('active');
    
    const categoriesOptions = categoriesData.map(c => 
        `<option value="${c.id}">${c.name}</option>`
    ).join('');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-box"></i> <span>إدارة المنتجات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openProductForm()">
                        <i class="fas fa-plus"></i> <span>إضافة منتج جديد</span>
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel('products')">
                        <i class="fas fa-download"></i> <span>تصدير Excel</span>
                    </button>
                    <div class="export-options">
                        <button class="btn btn-info" onclick="toggleExportMenu()">
                            <i class="fas fa-ellipsis-h"></i> <span>خيارات إضافية</span>
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <a class="export-option" onclick="exportToPDF('products')">
                                <i class="fas fa-file-pdf"></i> <span>تصدير PDF</span>
                            </a>
                            <a class="export-option" onclick="printTable('products')">
                                <i class="fas fa-print"></i> <span>طباعة</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <input type="text" id="searchProducts" class="form-input" 
                       placeholder="ابحث عن منتج بالاسم أو الرمز..." 
                       style="width: 100%; padding: 10px;" 
                       onkeyup="filterProductsTable()">
            </div>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الصورة</th>
                            <th>اسم المنتج</th>
                            <th>الرمز</th>
                            <th>التصنيف</th>
                            <th>سعر البيع</th>
                            <th>المخزون</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        ${renderProductsTable()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي المنتجات: <strong>${productsData.length}</strong> منتج</p>
            </div>
        </div>
    `;
    
    // تحديث خانة التصنيف في نموذج المنتج
    updateCategorySelect();
}

function renderProductsTable() {
    if (productsData.length === 0) {
        return `<tr><td colspan="8" style="text-align: center; padding: 30px;">لا توجد منتجات. قم بإضافة منتجات جديدة.</td></tr>`;
    }
    
    return productsData.map(product => {
        const category = categoriesData.find(c => c.id === product.categoryId);
        const stockStatus = product.status || calculateStockStatus(product.stockQuantity, product.minStock);
        const imageUrl = product.images ? product.images.split(',')[0] : '';
        
        return `
            <tr>
                <td style="text-align: center;">
                    ${imageUrl ? `<img src="${imageUrl.trim()}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : '<i class="fas fa-image" style="color: #ccc;"></i>'}
                </td>
                <td>${product.name}</td>
                <td><span class="product-code">${product.code}</span></td>
                <td>${category ? category.name : 'غير مصنف'}</td>
                <td><span class="price-tag">${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س</span></td>
                <td>${product.stockQuantity}</td>
                <td>
                    <span class="stock-badge ${stockStatus}">
                        ${stockStatus === 'in-stock' ? 'متوفر' : stockStatus === 'low-stock' ? 'منخفض' : 'نفذ'}
                    </span>
                </td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit" onclick="editProduct('${product.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteProduct('${product.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn view" onclick="viewProductDetails('${product.id}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showCategories() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(3)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-tags"></i> <span>إدارة التصنيفات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveCategory()">
                        <i class="fas fa-plus"></i> <span>إضافة تصنيف جديد</span>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                ${categoriesData.length === 0 ? 
                    '<p style="text-align: center; padding: 30px; color: #666;">لا توجد تصنيفات. قم بإضافة تصنيفات جديدة.</p>' :
                    categoriesData.map(category => {
                        const productCount = productsData.filter(p => p.categoryId === category.id).length;
                        return `
                            <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: var(--header-bg);">${category.name}</h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${category.description || 'لا يوجد وصف'}</p>
                                    <span style="font-size: 12px; color: #4361ee;">${productCount} منتج</span>
                                </div>
                                <div>
                                    <button class="action-btn delete" onclick="deleteCategory('${category.id}')" style="margin-right: 5px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')
                }
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي التصنيفات: <strong>${categoriesData.length}</strong> تصنيف</p>
            </div>
        </div>
    `;
}

function showOrders() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(4)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-shopping-cart"></i> <span>إدارة الطلبات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openOrderForm()">
                        <i class="fas fa-plus"></i> <span>إضافة طلب جديد</span>
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel('orders')">
                        <i class="fas fa-download"></i> <span>تصدير Excel</span>
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>رقم الطلب</th>
                            <th>العميل</th>
                            <th>التاريخ</th>
                            <th>المجموع</th>
                            <th>الحالة</th>
                            <th>طريقة الدفع</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        ${renderOrdersTable()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي الطلبات: <strong>${ordersData.length}</strong> طلب</p>
            </div>
        </div>
    `;
}

function renderOrdersTable() {
    if (ordersData.length === 0) {
        return `<tr><td colspan="7" style="text-align: center; padding: 30px;">لا توجد طلبات. قم بإضافة طلبات جديدة.</td></tr>`;
    }
    
    return ordersData.map(order => {
        const customer = customersData.find(c => c.id === order.customerId);
        const statusText = {
            'pending': 'قيد الانتظار',
            'processing': 'قيد المعالجة',
            'shipped': 'تم الشحن',
            'completed': 'مكتمل',
            'cancelled': 'ملغي'
        };
        
        return `
            <tr>
                <td><strong>${order.orderNumber}</strong></td>
                <td>${customer ? customer.name : 'غير معروف'}</td>
                <td>${order.orderDate}</td>
                <td><span class="price-tag">${order.total ? order.total.toFixed(2) : '0.00'} ر.س</span></td>
                <td><span class="status-badge ${order.status}">${statusText[order.status] || order.status}</span></td>
                <td>${order.paymentMethod || 'غير محدد'}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn view" onclick="viewOrderDetails('${order.id}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit" onclick="editOrder('${order.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteOrder('${order.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showCustomers() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(5)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-users"></i> <span>إدارة العملاء</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openCustomerForm()">
                        <i class="fas fa-plus"></i> <span>إضافة عميل جديد</span>
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel('customers')">
                        <i class="fas fa-download"></i> <span>تصدير Excel</span>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <input type="text" id="searchCustomers" class="form-input" 
                       placeholder="ابحث عن عميل بالاسم أو البريد الإلكتروني..." 
                       style="width: 100%; padding: 10px;" 
                       onkeyup="filterCustomersTable()">
            </div>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>رقم الهاتف</th>
                            <th>المدينة</th>
                            <th>عدد الطلبات</th>
                            <th>إجمالي المشتريات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        ${renderCustomersTable()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي العملاء: <strong>${customersData.length}</strong> عميل</p>
            </div>
        </div>
    `;
}

function renderCustomersTable() {
    if (customersData.length === 0) {
        return `<tr><td colspan="7" style="text-align: center; padding: 30px;">لا توجد عملاء. قم بإضافة عملاء جدد.</td></tr>`;
    }
    
    return customersData.map(customer => {
        const orderCount = ordersData.filter(o => o.customerId === customer.id).length;
        const totalSpent = ordersData
            .filter(o => o.customerId === customer.id)
            .reduce((sum, order) => sum + (order.total || 0), 0);
        
        return `
            <tr>
                <td>${customer.name}</td>
                <td>${customer.email}</td>
                <td>${customer.phone}</td>
                <td>${customer.city || 'غير محدد'}</td>
                <td>${orderCount}</td>
                <td><span class="price-tag">${totalSpent.toFixed(2)} ر.س</span></td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn view" onclick="viewCustomerDetails('${customer.id}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showInventory() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(6)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-warehouse"></i> <span>إدارة المخزون</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showProducts()">
                        <i class="fas fa-box"></i> <span>المنتجات</span>
                    </button>
                    <button class="btn btn-warning" onclick="showLowStockAlerts()">
                        <i class="fas fa-exclamation-triangle"></i> <span>عرض التنبيهات</span>
                    </button>
                </div>
            </div>
            
            <div class="stock-tracker">
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--product-color);">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stock-info">
                        <h4>المنتجات المتوفرة</h4>
                        <p>${productsData.filter(p => p.status === 'in-stock').length} منتج</p>
                        <div class="stock-progress">
                            <div class="progress-bar high" style="width: ${calculateStockPercentage('in-stock')}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--warning-color);">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div class="stock-info">
                        <h4>المنتجات منخفضة المخزون</h4>
                        <p>${productsData.filter(p => p.status === 'low-stock').length} منتج</p>
                        <div class="stock-progress">
                            <div class="progress-bar medium" style="width: ${calculateStockPercentage('low-stock')}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--danger-color);">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stock-info">
                        <h4>المنتجات غير المتوفرة</h4>
                        <p>${productsData.filter(p => p.status === 'out-of-stock').length} منتج</p>
                        <div class="stock-progress">
                            <div class="progress-bar low" style="width: ${calculateStockPercentage('out-of-stock')}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="color: var(--header-bg); margin-bottom: 15px;">منتجات منخفضة المخزون</h4>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الرمز</th>
                                <th>المخزون الحالي</th>
                                <th>الحد الأدنى</th>
                                <th>الفرق</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderLowStockProducts()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function calculateStockPercentage(status) {
    if (productsData.length === 0) return 0;
    const count = productsData.filter(p => p.status === status).length;
    return Math.round((count / productsData.length) * 100);
}

function renderLowStockProducts() {
    const lowStockProducts = productsData.filter(p => p.status === 'low-stock');
    
    if (lowStockProducts.length === 0) {
        return `<tr><td colspan="6" style="text-align: center; padding: 30px;">لا توجد منتجات منخفضة المخزون.</td></tr>`;
    }
    
    return lowStockProducts.map(product => {
        const difference = product.stockQuantity - product.minStock;
        return `
            <tr>
                <td>${product.name}</td>
                <td><span class="product-code">${product.code}</span></td>
                <td><span class="stock-badge low-stock">${product.stockQuantity}</span></td>
                <td>${product.minStock}</td>
                <td style="color: ${difference < 0 ? 'var(--danger-color)' : 'var(--warning-color)'};">
                    ${difference}
                </td>
                <td>
                    <button class="action-btn stock" onclick="updateProductStock('${product.id}')" title="تحديث المخزون">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateProductStock(productId) {
    const product = productsData.find(p => p.id === productId);
    if (!product) return;
    
    const newStock = prompt(`إضافة كميات للمنتج: ${product.name}\nالمخزون الحالي: ${product.stockQuantity}\nأدخل الكمية المراد إضافتها:`, "10");
    
    if (newStock && !isNaN(newStock) && parseInt(newStock) > 0) {
        product.stockQuantity += parseInt(newStock);
        product.status = calculateStockStatus(product.stockQuantity, product.minStock);
        saveProductsToLocal();
        showSuccess(`تم تحديث مخزون ${product.name} إلى ${product.stockQuantity}`);
        showInventory();
    }
}

function showAdvancedSearch() {
    document.getElementById('searchModal').classList.add('active');
}

function showLowStockAlerts() {
    document.getElementById('alertsModal').classList.add('active');
    loadLowStockAlerts();
}

function showReports() {
    document.getElementById('reportsModal').classList.add('active');
}

function showSalesAnalytics() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(10)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-line"></i> <span>تحليل المبيعات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="exportToExcel('analytics')">
                        <i class="fas fa-download"></i> <span>تصدير التقرير</span>
                    </button>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3>مبيعات المنتجات حسب التصنيف</h3>
                    <select class="chart-select" onchange="updateSalesChart()" id="chartPeriod">
                        <option value="month">آخر شهر</option>
                        <option value="quarter">آخر ربع سنة</option>
                        <option value="year">آخر سنة</option>
                        <option value="all">كل الفترات</option>
                    </select>
                </div>
                <canvas id="categorySalesChart" height="100"></canvas>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="chart-container">
                    <h3>أفضل المنتجات مبيعاً</h3>
                    <div id="topProductsList" style="margin-top: 15px;">
                        ${renderTopProducts()}
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>المبيعات الشهرية</h3>
                    <canvas id="monthlySalesChart" height="200"></canvas>
                </div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        loadSalesAnalyticsCharts();
    }, 100);
}

function showCoupons() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(11)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-ticket-alt"></i> <span>إدارة الكوبونات والعروض</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addCoupon()">
                        <i class="fas fa-plus"></i> <span>إضافة كوبون جديد</span>
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <p style="text-align: center; color: #666; padding: 20px;">
                    هذه الصفحة قيد التطوير. ستتوفر قريباً.
                </p>
            </div>
        </div>
    `;
}

function showShipping() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(12)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-shipping-fast"></i> <span>إدارة الشحن والتوصيل</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addShippingMethod()">
                        <i class="fas fa-plus"></i> <span>إضافة طريقة شحن</span>
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <p style="text-align: center; color: #666; padding: 20px;">
                    هذه الصفحة قيد التطوير. ستتوفر قريباً.
                </p>
            </div>
        </div>
    `;
}

// ============================================
// دوال النماذج والفتح والإغلاق
// ============================================

function openProductForm(productId = null) {
    const modal = document.getElementById('productFormModal');
    const formTitle = document.getElementById('productFormTitle');
    const form = document.getElementById('productForm');
    
    form.reset();
    document.getElementById('productId').value = '';
    
    if (productId) {
        const product = productsData.find(p => p.id === productId);
        if (product) {
            formTitle.textContent = 'تعديل بيانات المنتج';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCode').value = product.code;
            document.getElementById('productCategory').value = product.categoryId;
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('purchasePrice').value = product.purchasePrice || '';
            document.getElementById('salePrice').value = product.salePrice || '';
            document.getElementById('stockQuantity').value = product.stockQuantity || 0;
            document.getElementById('minStock').value = product.minStock || 5;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImages').value = product.images || '';
        }
    } else {
        formTitle.textContent = 'إضافة منتج جديد';
    }
    
    updateCategorySelect();
    modal.classList.add('active');
}

function closeProductForm() {
    document.getElementById('productFormModal').classList.remove('active');
    document.getElementById('productForm').reset();
}

function editProduct(id) {
    openProductForm(id);
}

function openOrderForm(orderId = null) {
    const modal = document.getElementById('orderFormModal');
    const formTitle = document.getElementById('orderFormTitle');
    const form = document.getElementById('orderForm');
    
    form.reset();
    document.getElementById('orderId').value = '';
    document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
    
    // توليد رقم طلب تلقائي
    document.getElementById('orderNumber').value = 'ORD-' + Date.now().toString().slice(-6);
    
    // تحديث قوائم العملاء والمنتجات
    updateCustomerSelect();
    updateOrderProductsSelect();
    
    if (orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (order) {
            formTitle.textContent = 'تعديل بيانات الطلب';
            document.getElementById('orderId').value = order.id;
            document.getElementById('orderNumber').value = order.orderNumber;
            document.getElementById('orderCustomerId').value = order.customerId;
            document.getElementById('orderDate').value = order.orderDate;
            document.getElementById('orderStatus').value = order.status;
            document.getElementById('paymentMethod').value = order.paymentMethod || 'cash';
            document.getElementById('shippingMethod').value = order.shippingMethod || 'standard';
            document.getElementById('shippingAddress').value = order.shippingAddress;
            document.getElementById('orderNotes').value = order.notes || '';
            
            // إضافة منتجات الطلب
            const container = document.getElementById('orderItemsContainer');
            container.innerHTML = '';
            
            order.items.forEach(item => {
                addOrderItem(item);
            });
        }
    } else {
        formTitle.textContent = 'إضافة طلب جديد';
        document.getElementById('orderItemsContainer').innerHTML = '';
        addOrderItem(); // إضافة منتج واحد افتراضي
    }
    
    modal.classList.add('active');
}

function addOrderItem(itemData = null) {
    const container = document.getElementById('orderItemsContainer');
    const itemId = 'item-' + Date.now();
    
    const itemHTML = `
        <div class="order-item" id="${itemId}" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
            <select class="order-product-select form-select" style="flex: 2;" onchange="updateOrderItemPrice(this)">
                <option value="">اختر المنتج</option>
                ${productsData.map(p => 
                    `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${p.salePrice} ر.س</option>`
                ).join('')}
            </select>
            <input type="number" class="order-quantity form-input" placeholder="الكمية" min="1" value="${itemData ? itemData.quantity : 1}" style="flex: 1;" onchange="calculateOrderTotal()">
            <input type="number" class="order-price form-input" placeholder="السعر" min="0" step="0.01" value="${itemData ? itemData.price : 0}" style="flex: 1;" onchange="calculateOrderTotal()">
            <button type="button" class="btn btn-danger" onclick="removeOrderItem('${itemId}')" style="width: 40px;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHTML);
    
    if (itemData) {
        const select = document.querySelector(`#${itemId} .order-product-select`);
        if (select) {
            select.value = itemData.productId;
            updateOrderItemPrice(select);
        }
    }
    
    calculateOrderTotal();
}

function removeOrderItem(itemId) {
    const item = document.getElementById(itemId);
    if (item) {
        item.remove();
        calculateOrderTotal();
    }
}

function updateOrderItemPrice(select) {
    const price = select.options[select.selectedIndex]?.dataset.price || 0;
    const quantityInput = select.closest('.order-item').querySelector('.order-quantity');
    const priceInput = select.closest('.order-item').querySelector('.order-price');
    
    if (priceInput) {
        priceInput.value = price;
        calculateOrderTotal();
    }
}

function calculateOrderTotal() {
    // يمكن تنفيذ حساب المجموع هنا إذا لزم الأمر
}

function closeOrderForm() {
    document.getElementById('orderFormModal').classList.remove('active');
    document.getElementById('orderForm').reset();
}

function editOrder(id) {
    openOrderForm(id);
}

function openCustomerForm(customerId = null) {
    const modal = document.getElementById('customerFormModal');
    const formTitle = document.getElementById('customerFormTitle');
    const form = document.getElementById('customerForm');
    
    form.reset();
    document.getElementById('customerId').value = '';
    
    if (customerId) {
        const customer = customersData.find(c => c.id === customerId);
        if (customer) {
            formTitle.textContent = 'تعديل بيانات العميل';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerCity').value = customer.city || '';
            document.getElementById('customerBirthdate').value = customer.birthdate || '';
            document.getElementById('customerNotes').value = customer.notes || '';
        }
    } else {
        formTitle.textContent = 'إضافة عميل جديد';
    }
    
    modal.classList.add('active');
}

function closeCustomerForm() {
    document.getElementById('customerFormModal').classList.remove('active');
    document.getElementById('customerForm').reset();
}

function editCustomer(id) {
    openCustomerForm(id);
}

function closeSearchModal() {
    document.getElementById('searchModal').classList.remove('active');
}

function closeAlertsModal() {
    document.getElementById('alertsModal').classList.remove('active');
}

function closeReportsModal() {
    document.getElementById('reportsModal').classList.remove('active');
}

// ============================================
// دوال تحديث الإحصائيات
// ============================================

function updateStats() {
    try {
        // حساب الإحصائيات
        const totalOrders = ordersData.length;
        const totalProducts = productsData.length;
        const totalCustomers = customersData.length;
        const totalCategories = categoriesData.length;
        
        const totalRevenue = ordersData.reduce((sum, order) => sum + (order.total || 0), 0);
        const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
        
        // تحديث DOM إذا كان موجوداً
        if (document.getElementById('totalOrders')) {
            document.getElementById('totalOrders').textContent = totalOrders;
        }
        if (document.getElementById('totalProducts')) {
            document.getElementById('totalProducts').textContent = totalProducts;
        }
        if (document.getElementById('totalCustomers')) {
            document.getElementById('totalCustomers').textContent = totalCustomers;
        }
        if (document.getElementById('totalCategories')) {
            document.getElementById('totalCategories').textContent = totalCategories;
        }
        if (document.getElementById('totalRevenue')) {
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' ر.س';
        }
        if (document.getElementById('pendingOrders')) {
            document.getElementById('pendingOrders').textContent = pendingOrders;
        }
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

function updateRecentData() {
    try {
        // تحديث أحدث الطلبات
        const recentOrders = [...ordersData].sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)).slice(0, 5);
        
        if (document.getElementById('recentOrdersTable')) {
            if (recentOrders.length === 0) {
                document.getElementById('recentOrdersTable').innerHTML = '<p style="text-align: center; color: #666;">لا توجد طلبات حديثة</p>';
            } else {
                document.getElementById('recentOrdersTable').innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>المجموع</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentOrders.map(order => {
                                const customer = customersData.find(c => c.id === order.customerId);
                                const statusText = {
                                    'pending': 'قيد الانتظار',
                                    'processing': 'قيد المعالجة',
                                    'shipped': 'تم الشحن',
                                    'completed': 'مكتمل',
                                    'cancelled': 'ملغي'
                                };
                                
                                return `
                                    <tr>
                                        <td><strong>${order.orderNumber}</strong></td>
                                        <td>${customer ? customer.name : 'غير معروف'}</td>
                                        <td>${order.total ? order.total.toFixed(2) : '0.00'} ر.س</td>
                                        <td><span class="status-badge ${order.status}">${statusText[order.status] || order.status}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
        
        // تحديث المنتجات منخفضة المخزون
        const lowStockProducts = productsData.filter(p => p.status === 'low-stock').slice(0, 5);
        
        if (document.getElementById('lowStockProducts')) {
            if (lowStockProducts.length === 0) {
                document.getElementById('lowStockProducts').innerHTML = '<p style="text-align: center; color: #666;">لا توجد منتجات منخفضة المخزون</p>';
            } else {
                document.getElementById('lowStockProducts').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${lowStockProducts.map(product => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                <div>
                                    <strong>${product.name}</strong>
                                    <div style="font-size: 12px; color: #666;">المخزون: ${product.stockQuantity}</div>
                                </div>
                                <button class="action-btn stock" onclick="updateProductStock('${product.id}')" title="تحديث المخزون">
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error updating recent data:', error);
    }
}

// ============================================
// دوال تحديث القوائم المنسدلة
// ============================================

function updateCategorySelect() {
    const select = document.getElementById('productCategory');
    if (select) {
        select.innerHTML = '<option value="">اختر التصنيف</option>' + 
            categoriesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
}

function updateCustomerSelect() {
    const select = document.getElementById('orderCustomerId');
    if (select) {
        select.innerHTML = '<option value="">اختر العميل</option>' + 
            customersData.map(c => `<option value="${c.id}">${c.name} - ${c.email}</option>`).join('');
    }
}

function updateOrderProductsSelect() {
    const selects = document.querySelectorAll('.order-product-select');
    selects.forEach(select => {
        if (select && select.id !== 'orderCustomerId') {
            select.innerHTML = '<option value="">اختر المنتج</option>' + 
                productsData.map(p => `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${p.salePrice} ر.س</option>`).join('');
        }
    });
}

// ============================================
// دوال الرسوم البيانية
// ============================================

function loadDashboardCharts() {
    try {
        // إنشاء مخطط المبيعات
        const salesCtx = document.getElementById('salesChart');
        if (salesCtx) {
            const monthlySales = calculateMonthlySales();
            
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: monthlySales.labels,
                    datasets: [{
                        label: 'المبيعات الشهرية',
                        data: monthlySales.values,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading charts:', error);
    }
}

function calculateMonthlySales() {
    const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                   'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    
    const sales = Array(12).fill(0);
    const currentYear = new Date().getFullYear();
    
    ordersData.forEach(order => {
        if (order.orderDate) {
            const date = new Date(order.orderDate);
            if (date.getFullYear() === currentYear) {
                const month = date.getMonth();
                sales[month] += order.total || 0;
            }
        }
    });
    
    return {
        labels: months,
        values: sales
    };
}

function loadSalesAnalyticsCharts() {
    try {
        // مخطط مبيعات التصنيفات
        const categoryCtx = document.getElementById('categorySalesChart');
        if (categoryCtx) {
            const categorySales = calculateCategorySales();
            
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categorySales.labels,
                    datasets: [{
                        data: categorySales.values,
                        backgroundColor: [
                            '#d131bc', '#631a5f', '#4cc9f0', '#87ad2f', '#f72585',
                            '#7209b7', '#38b000', '#ff9e00', '#560bad', '#0077b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        // مخطط المبيعات الشهرية
        const monthlyCtx = document.getElementById('monthlySalesChart');
        if (monthlyCtx) {
            const monthlySales = calculateMonthlySales();
            
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: monthlySales.labels,
                    datasets: [{
                        label: 'المبيعات',
                        data: monthlySales.values,
                        backgroundColor: 'rgba(67, 97, 238, 0.8)',
                        borderColor: '#4361ee',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading analytics charts:', error);
    }
}

function calculateCategorySales() {
    const categorySales = {};
    
    ordersData.forEach(order => {
        order.items?.forEach(item => {
            const product = productsData.find(p => p.id === item.productId);
            if (product) {
                const category = categoriesData.find(c => c.id === product.categoryId);
                const categoryName = category ? category.name : 'غير مصنف';
                
                if (!categorySales[categoryName]) {
                    categorySales[categoryName] = 0;
                }
                
                categorySales[categoryName] += item.quantity * item.price;
            }
        });
    });
    
    const labels = Object.keys(categorySales);
    const values = Object.values(categorySales);
    
    return { labels, values };
}

function renderTopProducts() {
    const productSales = {};
    
    ordersData.forEach(order => {
        order.items?.forEach(item => {
            const product = productsData.find(p => p.id === item.productId);
            if (product) {
                if (!productSales[product.id]) {
                    productSales[product.id] = {
                        name: product.name,
                        quantity: 0,
                        revenue: 0
                    };
                }
                
                productSales[product.id].quantity += item.quantity;
                productSales[product.id].revenue += item.quantity * item.price;
            }
        });
    });
    
    const sortedProducts = Object.values(productSales)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 5);
    
    if (sortedProducts.length === 0) {
        return '<p style="text-align: center; color: #666;">لا توجد بيانات مبيعات</p>';
    }
    
    return sortedProducts.map((product, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 8px; margin-bottom: 8px;">
            <div>
                <strong>${product.name}</strong>
                <div style="font-size: 12px; color: #666;">${product.quantity} وحدة</div>
            </div>
            <div>
                <span class="price-tag">${product.revenue.toFixed(2)} ر.س</span>
            </div>
        </div>
    `).join('');
}

// ============================================
// دوال البحث والتصدير
// ============================================

function filterProductsTable() {
    const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
    const tableBody = document.getElementById('productsTableBody');
    
    if (!tableBody) return;
    
    const filteredProducts = productsData.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.code.toLowerCase().includes(searchTerm)
    );
    
    tableBody.innerHTML = filteredProducts.length > 0 ? 
        filteredProducts.map(product => {
            const category = categoriesData.find(c => c.id === product.categoryId);
            const stockStatus = product.status || calculateStockStatus(product.stockQuantity, product.minStock);
            
            return `
                <tr>
                    <td><i class="fas fa-image" style="color: #ccc;"></i></td>
                    <td>${product.name}</td>
                    <td><span class="product-code">${product.code}</span></td>
                    <td>${category ? category.name : 'غير مصنف'}</td>
                    <td><span class="price-tag">${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س</span></td>
                    <td>${product.stockQuantity}</td>
                    <td>
                        <span class="stock-badge ${stockStatus}">
                            ${stockStatus === 'in-stock' ? 'متوفر' : stockStatus === 'low-stock' ? 'منخفض' : 'نفذ'}
                        </span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('') :
        '<tr><td colspan="8" style="text-align: center; padding: 30px;">لم يتم العثور على منتجات مطابقة</td></tr>';
}

function filterCustomersTable() {
    const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
    const tableBody = document.getElementById('customersTableBody');
    
    if (!tableBody) return;
    
    const filteredCustomers = customersData.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) || 
        customer.email.toLowerCase().includes(searchTerm)
    );
    
    tableBody.innerHTML = filteredCustomers.length > 0 ? 
        filteredCustomers.map(customer => {
            const orderCount = ordersData.filter(o => o.customerId === customer.id).length;
            const totalSpent = ordersData
                .filter(o => o.customerId === customer.id)
                .reduce((sum, order) => sum + (order.total || 0), 0);
            
            return `
                <tr>
                    <td>${customer.name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.city || 'غير محدد'}</td>
                    <td>${orderCount}</td>
                    <td><span class="price-tag">${totalSpent.toFixed(2)} ر.س</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="editCustomer('${customer.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteCustomer('${customer.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('') :
        '<tr><td colspan="7" style="text-align: center; padding: 30px;">لم يتم العثور على عملاء مطابقين</td></tr>';
}

function toggleExportMenu() {
    const menu = document.getElementById('exportMenu');
    if (menu) {
        menu.classList.toggle('show');
    }
}

function exportToExcel(type) {
    try {
        showExportLoading('جاري تحضير الملف...');
        
        let ws, fileName;
        
        switch(type) {
            case 'products':
                ws = XLSX.utils.json_to_sheet(productsData.map(p => ({
                    'اسم المنتج': p.name,
                    'الرمز': p.code,
                    'التصنيف': categoriesData.find(c => c.id === p.categoryId)?.name || '',
                    'سعر البيع': p.salePrice,
                    'المخزون': p.stockQuantity,
                    'الحالة': p.status === 'in-stock' ? 'متوفر' : p.status === 'low-stock' ? 'منخفض' : 'نفذ'
                })));
                fileName = 'المنتجات.xlsx';
                break;
                
            case 'customers':
                ws = XLSX.utils.json_to_sheet(customersData.map(c => ({
                    'الاسم': c.name,
                    'البريد الإلكتروني': c.email,
                    'الهاتف': c.phone,
                    'المدينة': c.city,
                    'عدد الطلبات': ordersData.filter(o => o.customerId === c.id).length
                })));
                fileName = 'العملاء.xlsx';
                break;
                
            case 'orders':
                ws = XLSX.utils.json_to_sheet(ordersData.map(o => {
                    const customer = customersData.find(c => c.id === o.customerId);
                    return {
                        'رقم الطلب': o.orderNumber,
                        'العميل': customer ? customer.name : '',
                        'التاريخ': o.orderDate,
                        'الحالة': o.status,
                        'المجموع': o.total
                    };
                }));
                fileName = 'الطلبات.xlsx';
                break;
                
            case 'analytics':
                const categorySales = calculateCategorySales();
                ws = XLSX.utils.json_to_sheet(
                    categorySales.labels.map((label, index) => ({
                        'التصنيف': label,
                        'المبيعات': categorySales.values[index]
                    }))
                );
                fileName = 'تحليل_المبيعات.xlsx';
                break;
        }
        
        if (ws) {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'البيانات');
            XLSX.writeFile(wb, fileName);
        }
        
        hideExportLoading();
        showSuccess('تم التصدير بنجاح');
    } catch (error) {
        hideExportLoading();
        showError('فشل التصدير: ' + error.message);
    }
}

// ============================================
// دوال إضافية
// ============================================

function loadLowStockAlerts() {
    const lowStockProducts = productsData.filter(p => p.status === 'low-stock');
    const alertsList = document.getElementById('alertsList');
    
    if (!alertsList) return;
    
    if (lowStockProducts.length === 0) {
        alertsList.innerHTML = '<p style="text-align: center; padding: 30px; color: #666;">لا توجد تنبيهات للمخزون المنخفض</p>';
        return;
    }
    
    alertsList.innerHTML = lowStockProducts.map(product => `
        <div class="alert-item">
            <div class="alert-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-content">
                <div class="alert-title">${product.name}</div>
                <div class="alert-message">
                    المخزون الحالي: ${product.stockQuantity} | الحد الأدنى: ${product.minStock}
                    <br>
                    الفرق: ${product.stockQuantity - product.minStock}
                </div>
            </div>
        </div>
    `).join('');
}

function viewProductDetails(id) {
    const product = productsData.find(p => p.id === id);
    if (!product) return;
    
    const category = categoriesData.find(c => c.id === product.categoryId);
    
    alert(`
تفاصيل المنتج:
──────────────
الاسم: ${product.name}
الرمز: ${product.code}
التصنيف: ${category ? category.name : 'غير مصنف'}
العلامة التجارية: ${product.brand || 'غير محدد'}
سعر الشراء: ${product.purchasePrice ? product.purchasePrice.toFixed(2) : '0.00'} ر.س
سعر البيع: ${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س
المخزون: ${product.stockQuantity}
الحد الأدنى: ${product.minStock}
الحالة: ${product.status === 'in-stock' ? 'متوفر' : product.status === 'low-stock' ? 'منخفض' : 'نفذ'}
    `);
}

function viewCustomerDetails(id) {
    const customer = customersData.find(c => c.id === id);
    if (!customer) return;
    
    const customerOrders = ordersData.filter(o => o.customerId === id);
    
    alert(`
تفاصيل العميل:
─────────────
الاسم: ${customer.name}
البريد الإلكتروني: ${customer.email}
رقم الهاتف: ${customer.phone}
العنوان: ${customer.address || 'غير محدد'}
المدينة: ${customer.city || 'غير محدد'}
تاريخ الميلاد: ${customer.birthdate || 'غير محدد'}
عدد الطلبات: ${customerOrders.length}
إجمالي المشتريات: ${customerOrders.reduce((sum, order) => sum + (order.total || 0), 0).toFixed(2)} ر.س
الملاحظات: ${customer.notes || 'لا توجد ملاحظات'}
    `);
}

function viewOrderDetails(id) {
    const order = ordersData.find(o => o.id === id);
    if (!order) return;
    
    const customer = customersData.find(c => c.id === order.customerId);
    
    let itemsText = '';
    order.items?.forEach((item, index) => {
        const product = productsData.find(p => p.id === item.productId);
        itemsText += `${index + 1}. ${product ? product.name : 'منتج غير معروف'} (${item.quantity} × ${item.price} ر.س) = ${(item.quantity * item.price).toFixed(2)} ر.س\n`;
    });
    
    alert(`
تفاصيل الطلب:
────────────
رقم الطلب: ${order.orderNumber}
العميل: ${customer ? customer.name : 'غير معروف'}
تاريخ الطلب: ${order.orderDate}
حالة الطلب: ${order.status}
طريقة الدفع: ${order.paymentMethod}
طريقة الشحن: ${order.shippingMethod}
عنوان الشحن: ${order.shippingAddress}
الملاحظات: ${order.notes || 'لا توجد ملاحظات'}

منتجات الطلب:
────────────
${itemsText}

المجموع الفرعي: ${order.subtotal ? order.subtotal.toFixed(2) : '0.00'} ر.س
الضريبة: ${order.tax ? order.tax.toFixed(2) : '0.00'} ر.س
الشحن: ${order.shippingCost ? order.shippingCost.toFixed(2) : '0.00'} ر.س
الإجمالي: ${order.total ? order.total.toFixed(2) : '0.00'} ر.س
    `);
}

function addCoupon() {
    alert('هذه الميزة قيد التطوير. ستتوفر قريباً.');
}

function addShippingMethod() {
    alert('هذه الميزة قيد التطوير. ستتوفر قريباً.');
}

// ============================================
// إغلاق القائمة عند النقر خارجها
// ============================================

document.addEventListener('click', function(event) {
    // إغلاق قائمة التصدير عند النقر خارجها
    const exportMenu = document.getElementById('exportMenu');
    const exportBtn = document.querySelector('.export-options button');
    
    if (exportMenu && exportBtn && 
        !exportMenu.contains(event.target) && 
        !exportBtn.contains(event.target)) {
        exportMenu.classList.remove('show');
    }
    
    // إغلاق الشريط الجانبي على الجوال
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (sidebar && mobileToggle && 
        sidebar.classList.contains('active') &&
        !sidebar.contains(event.target) && 
        !mobileToggle.contains(event.target)) {
        sidebar.classList.remove('active');
    }
});
        // ============================================
        // دوال أخرى مطلوبة
        // ============================================

        // دوال اللغة والعملة (نفسها من الكود الأصلي)
        function changeLanguage(lang) {
            currentLanguage = lang;
            document.body.classList.toggle('english', lang === 'en');
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', 
                    (lang === 'ar' && btn.textContent.includes('عربي')) ||
                    (lang === 'en' && btn.textContent.includes('English'))
                );
            });
            updateAllTexts();
            savePreferences();
        }

        function updateAllTexts() {
            document.querySelectorAll('[data-ar], [data-en]').forEach(element => {
                const text = element.getAttribute(`data-${currentLanguage}`);
                if (text) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        const placeholderAttr = `data-${currentLanguage}-placeholder`;
                        const placeholder = element.getAttribute(placeholderAttr);
                        if (placeholder) {
                            element.placeholder = placeholder;
                        }
                    } else {
                        element.textContent = text;
                    }
                }
            });
            document.querySelectorAll('[data-ar-placeholder], [data-en-placeholder]').forEach(element => {
                const placeholderAttr = `data-${currentLanguage}-placeholder`;
                const placeholder = element.getAttribute(placeholderAttr);
                if (placeholder) {
                    element.placeholder = placeholder;
                }
            });
        }

        function selectCurrency(currencyCode) {
            currentCurrency = currencyCode;
            const currencySymbol = exchangeRates[currencyCode]?.symbol || 'ر.س';
            document.getElementById('loginCurrencySymbol').textContent = currencySymbol;
            document.getElementById('mainCurrencySymbol').textContent = currencySymbol;
            document.getElementById('sidebarCurrencySymbol').textContent = currencySymbol;
            document.getElementById('purchasePriceCurrency').textContent = currencySymbol;
            document.getElementById('salePriceCurrency').textContent = currencySymbol;
            document.querySelectorAll('.currency-option').forEach(option => {
                option.classList.toggle('active', option.getAttribute('data-currency') === currencyCode);
            });
            updateAllPrices();
            closeAllCurrencyDropdowns();
            savePreferences();
        }

        function toggleCurrencyDropdown(event, dropdownId) {
            event.stopPropagation();
            document.querySelectorAll('.currency-dropdown-content').forEach(content => {
                if (content.id !== dropdownId + 'Content') {
                    content.classList.remove('show');
                }
            });
            const dropdownContent = document.getElementById(dropdownId + 'Content');
            if (dropdownContent) {
                dropdownContent.classList.toggle('show');
            }
        }

        function closeAllCurrencyDropdowns() {
            document.querySelectorAll('.currency-dropdown-content').forEach(content => {
                content.classList.remove('show');
            });
        }

        function updateAllPrices() {
            // تحديث الأسعار حسب العملة المحددة
            console.log('Updating prices for currency:', currentCurrency);
        }

        function populateCurrencyDropdowns() {
            const dropdowns = [
                'loginCurrencyDropdownContent',
                'mainCurrencyDropdownContent',
                'sidebarCurrencyDropdownContent'
            ];
            
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.innerHTML = '';
                    Object.entries(exchangeRates).forEach(([code, info]) => {
                        const option = document.createElement('div');
                        option.className = `currency-option ${code === currentCurrency ? 'active' : ''}`;
                        option.setAttribute('data-currency', code);
                        option.onclick = () => selectCurrency(code);
                        option.innerHTML = `
                            <i class="fas fa-money-bill" style="color: ${code === currentCurrency ? 'white' : '#4361ee'}"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${info.symbol} ${currentLanguage === 'ar' ? info.name.ar : info.name.en}</div>
                                <small style="color: ${code === currentCurrency ? '#ddd' : '#666'}">${code}</small>
                            </div>
                        `;
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        function savePreferences() {
            try {
                localStorage.setItem('ecommerce_language', currentLanguage);
                localStorage.setItem('ecommerce_currency', currentCurrency);
            } catch (error) {
                console.error('Error saving preferences:', error);
            }
        }

        function loadPreferences() {
            try {
                const savedLanguage = localStorage.getItem('ecommerce_language');
                const savedCurrency = localStorage.getItem('ecommerce_currency');
                if (savedLanguage) currentLanguage = savedLanguage;
                if (savedCurrency) currentCurrency = savedCurrency;
                applyPreferences();
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        function applyPreferences() {
            document.body.classList.toggle('english', currentLanguage === 'en');
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', 
                    (currentLanguage === 'ar' && btn.textContent.includes('عربي')) ||
                    (currentLanguage === 'en' && btn.textContent.includes('English'))
                );
            });
            const currencySymbol = exchangeRates[currentCurrency]?.symbol || 'ر.س';
            document.getElementById('loginCurrencySymbol').textContent = currencySymbol;
            document.getElementById('mainCurrencySymbol').textContent = currencySymbol;
            document.getElementById('sidebarCurrencySymbol').textContent = currencySymbol;
            updateAllTexts();
            populateCurrencyDropdowns();
        }

        // دوال المصادقة (نفسها من الكود الأصلي)
        function handleLogin(e) {
            if (e) e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';
            
            if (!email || !password) {
                errorDiv.querySelector('span').textContent = currentLanguage === 'ar' ? 
                    'الرجاء إدخال البريد الإلكتروني وكلمة المرور' : 
                    'Please enter email and password';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoading(true);
            const demoAccounts = {
                'admin@store.com': 'admin123',
                'user@store.com': 'user123',
                'demo@store.com': 'demo123'
            };
            
            if (demoAccounts[email] && demoAccounts[email] === password) {
                setTimeout(() => {
                    currentUser = { email: email };
                    document.getElementById('loggedInUser').textContent = email;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    initSystem();
                    showDashboard();
                    showSuccess(currentLanguage === 'ar' ? 'تم تسجيل الدخول بنجاح' : 'Logged in successfully');
                    showLoading(false);
                }, 1000);
                return;
            }
            
            showLoading(false);
            showError(currentLanguage === 'ar' ? 
                'استخدم الحسابات التجريبية: admin@store.com / admin123' : 
                'Use demo accounts: admin@store.com / admin123');
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        function initSystem() {
            console.log('System initialized');
            loadAllLocalData();
            populateCurrencyDropdowns();
        }

        function logout() {
            if (confirm(currentLanguage === 'ar' ? 'هل تريد تسجيل الخروج؟' : 'Do you want to logout?')) {
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                currentUser = null;
            }
        }

        // دوال النماذج الأخرى
        function closeProductForm() {
            document.getElementById('productFormModal').classList.remove('active');
            document.getElementById('productForm').reset();
        }

        function showSalesAnalytics() {
            // يمكن إضافة محتوى حقيقي هنا
            alert(currentLanguage === 'ar' ? 'صفحة تحليل المبيعات قيد التطوير' : 'Sales Analytics page under development');
        }

        function showCoupons() {
            // يمكن إضافة محتوى حقيقي هنا
            alert(currentLanguage === 'ar' ? 'صفحة الكوبونات والعروض قيد التطوير' : 'Coupons & Offers page under development');
        }

        function showShipping() {
            // يمكن إضافة محتوى حقيقي هنا
            alert(currentLanguage === 'ar' ? 'صفحة الشحن والتوصيل قيد التطوير' : 'Shipping & Delivery page under development');
        }

        function showSignupForm() {
            alert(currentLanguage === 'ar' ? 'خاصية إنشاء حساب جديد قيد التطوير' : 'Sign up feature is under development');
        }

        function handlePasswordReset() {
            alert(currentLanguage === 'ar' ? 'خاصية استعادة كلمة المرور قيد التطوير' : 'Password reset feature is under development');
        }
    </script>
</body>
</html>
