<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>نظام إدارة المتجر الإلكتروني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK للتخزين السحابي للمصادقة فقط -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- المكتبات الأخرى -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* متغيرات الألوان للنظام التجاري - تصميم عصري */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            
            --bg-dark: #0f172a;
            --bg-card: #ffffff;
            --bg-light: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* قيمة العملة - جنيه مصري */
            --currency-symbol: "ج.م";
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Tajawal', sans-serif;
        }
        
        body {
            background-color: #f1f5f9;
            direction: rtl;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* شاشة الدخول الحديثة */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 420px;
            text-align: center;
            animation: fadeInUp 0.6s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-logo {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-title {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .login-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
            transition: all 0.3s;
            background-color: var(--bg-light);
            font-weight: 500;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background-color: white;
        }
        
        .login-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* التصميم العصري للجوال - يشبه التطبيقات */
        .mobile-app-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f8fafc;
        }
        
        /* الهيدر السفلي للجوال - يشبه تطبيقات الجوال */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            border-radius: 25px 25px 0 0;
            padding: 10px 5px;
            z-index: 1000;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            transition: all 0.2s;
            cursor: pointer;
            flex: 1;
        }
        
        .mobile-nav-item i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        
        .mobile-nav-item span {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .mobile-nav-item.active {
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* زر القائمة العائم - FAB */
        .fab-button {
            position: fixed;
            bottom: 85px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s;
            border: 2px solid white;
        }
        
        .fab-button:hover {
            transform: scale(1.1);
        }
        
        /* بطاقات الإحصائيات الحديثة */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card-modern {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .stat-card-modern:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon-modern {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            background: var(--primary-gradient);
        }
        
        .stat-info-modern h3 {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .stat-info-modern p {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* بطاقات المنتجات العصرية */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card-modern {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .product-card-modern:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .product-image-container {
            position: relative;
            height: 200px;
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.5s;
        }
        
        .product-card-modern:hover .product-image-container img {
            transform: scale(1.05);
        }
        
        .product-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            z-index: 10;
        }
        
        .badge-in-stock { background: var(--success-gradient); }
        .badge-low-stock { background: var(--warning-gradient); }
        .badge-out-of-stock { background: var(--danger-gradient); }
        
        .product-info {
            padding: 20px;
        }
        
        .product-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .product-code {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .product-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .product-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        
        .product-price::after {
            content: " ج.م";
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .product-stock {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* الجداول الحديثة */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
        }
        
        .modern-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .modern-table th {
            text-align: right;
            padding: 16px 12px;
            background: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modern-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .modern-table tr:hover {
            background: var(--bg-light);
        }
        
        /* أزرار العمل الحديثة */
        .action-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-modern {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            background: var(--primary-gradient);
        }
        
        .btn-modern-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-modern-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
        }
        
        /* الفلاتر والبحث */
        .search-bar-modern {
            background: white;
            border-radius: var(--radius-full);
            padding: 4px;
            display: flex;
            align-items: center;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .search-bar-modern i {
            padding: 0 16px;
            color: var(--text-muted);
        }
        
        .search-bar-modern input {
            flex: 1;
            padding: 12px 0;
            border: none;
            background: transparent;
            font-size: 0.95rem;
        }
        
        .search-bar-modern input:focus {
            outline: none;
        }
        
        .search-bar-modern button {
            padding: 10px 24px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* تصميم الشريط الجانبي للجوال */
        .mobile-sidebar {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            z-index: 2000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-xl);
            overflow-y: auto;
        }
        
        .mobile-sidebar.active {
            right: 0;
        }
        
        .mobile-sidebar-header {
            padding: 24px 20px;
            background: var(--primary-gradient);
            color: white;
        }
        
        .mobile-sidebar-menu {
            list-style: none;
            padding: 16px;
        }
        
        .mobile-sidebar-item {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mobile-sidebar-item i {
            width: 24px;
            color: var(--primary-color);
        }
        
        .mobile-sidebar-item:hover {
            background: var(--bg-light);
        }
        
        .mobile-sidebar-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }
        
        /* تنسيق العملة - جنيه مصري */
        .currency-egp {
            font-weight: 700;
        }
        
        .currency-egp::after {
            content: " ج.م";
            font-size: 0.9em;
            margin-right: 2px;
        }
        
        .price-tag-egp {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
        }
        
        .price-tag-egp::after {
            content: " ج.م";
            font-size: 0.8em;
            margin-right: 4px;
        }
        
        /* تحسينات للجوال */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content-area {
                margin-right: 0;
                width: 100%;
                padding: 16px;
                padding-bottom: 90px;
            }
            
            .mobile-bottom-nav {
                display: block;
            }
            
            .fab-button {
                display: flex;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .stat-card-modern {
                padding: 16px;
            }
            
            .stat-icon-modern {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
            
            .stat-info-modern h3 {
                font-size: 1.3rem;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: stretch;
            }
            
            .btn-modern {
                flex: 1;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-container {
                padding: 30px 20px;
            }
            
            .login-title {
                font-size: 1.5rem;
            }
            
            .product-image-container {
                height: 160px;
            }
        }
        
        /* أنيميشنات */
        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease;
        }
        
        /* شاشة التحميل */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل الحديثة -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div id="loadingText" style="font-size: 1.2rem; font-weight: 600;">جاري التحميل...</div>
    </div>

    <!-- زر القائمة العائم (FAB) للجوال -->
    <div class="fab-button" id="fabButton">
        <i class="fas fa-plus"></i>
    </div>

    <!-- القائمة الجانبية للجوال -->
    <div class="mobile-sidebar" id="mobileSidebar">
        <div class="mobile-sidebar-header">
            <i class="fas fa-store" style="font-size: 2rem; margin-bottom: 16px;"></i>
            <h3 style="margin-bottom: 8px;">نظام إدارة المتجر</h3>
            <p style="opacity: 0.9; font-size: 0.9rem;" id="mobileUserEmail">مستخدم</p>
        </div>
        <ul class="mobile-sidebar-menu">
            <li class="mobile-sidebar-item active" onclick="showDashboard(); closeMobileSidebar()">
                <i class="fas fa-home"></i> الرئيسية
            </li>
            <li class="mobile-sidebar-item" onclick="showProducts(); closeMobileSidebar()">
                <i class="fas fa-box"></i> المنتجات
            </li>
            <li class="mobile-sidebar-item" onclick="showCategories(); closeMobileSidebar()">
                <i class="fas fa-tags"></i> التصنيفات
            </li>
            <li class="mobile-sidebar-item" onclick="showOrders(); closeMobileSidebar()">
                <i class="fas fa-shopping-cart"></i> الطلبات
            </li>
            <li class="mobile-sidebar-item" onclick="showCustomers(); closeMobileSidebar()">
                <i class="fas fa-users"></i> العملاء
            </li>
            <li class="mobile-sidebar-item" onclick="showInventory(); closeMobileSidebar()">
                <i class="fas fa-warehouse"></i> المخزون
            </li>
            <li class="mobile-sidebar-item" onclick="showReports(); closeMobileSidebar()">
                <i class="fas fa-chart-bar"></i> التقارير
            </li>
            <li class="mobile-sidebar-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </li>
        </ul>
    </div>

    <!-- شاشة الدخول -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-store"></i>
            </div>
            <h2 class="login-title">متجري</h2>
            <p class="login-subtitle">نظام إدارة المتجر الإلكتروني المتطور</p>
            
            <form class="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="form-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="username" class="login-input" placeholder="البريد الإلكتروني" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="login-input" placeholder="كلمة المرور" required>
                </div>
                
                <div class="login-error" id="loginError" style="display: none; color: var(--danger-color); padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage">خطأ في تسجيل الدخول</span>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> <span>دخول</span>
                </button>
            </form>
            
            <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                <a href="javascript:void(0);" onclick="showSignupForm()" style="color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 0.9rem;">
                    <i class="fas fa-user-plus"></i> إنشاء حساب
                </a>
                <a href="javascript:void(0);" onclick="handlePasswordReset()" style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem;">
                    <i class="fas fa-key"></i> نسيت كلمة المرور؟
                </a>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div id="main-content" style="display: none;">
        <!-- الهيدر -->
        <div style="background: white; box-shadow: var(--shadow-sm); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <i class="fas fa-bars" style="font-size: 1.5rem; color: var(--text-primary); display: none; cursor: pointer;" id="menuToggle"></i>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-store" style="color: var(--primary-color); font-size: 1.8rem;"></i>
                    <h1 style="font-size: 1.3rem; font-weight: 800; color: var(--text-primary);">متجري</h1>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: var(--text-secondary); font-weight: 600;" id="loggedInUser">مستخدم</span>
                <button onclick="logout()" style="background: none; border: none; color: var(--danger-color); font-size: 1.2rem; cursor: pointer;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- الشريط الجانبي للويب -->
        <div class="sidebar" id="sidebar" style="background: white; box-shadow: var(--shadow-md); width: 260px; top: 80px;">
            <ul class="sidebar-menu" style="padding: 20px 0;">
                <li class="menu-item" onclick="showDashboard()">
                    <i class="fas fa-home"></i> الرئيسية
                </li>
                <li class="menu-item" onclick="showProducts()">
                    <i class="fas fa-box"></i> المنتجات
                </li>
                <li class="menu-item" onclick="showCategories()">
                    <i class="fas fa-tags"></i> التصنيفات
                </li>
                <li class="menu-item" onclick="showOrders()">
                    <i class="fas fa-shopping-cart"></i> الطلبات
                </li>
                <li class="menu-item" onclick="showCustomers()">
                    <i class="fas fa-users"></i> العملاء
                </li>
                <li class="menu-item" onclick="showInventory()">
                    <i class="fas fa-warehouse"></i> المخزون
                </li>
                <li class="menu-item" onclick="showAdvancedSearch()">
                    <i class="fas fa-search"></i> البحث المتقدم
                </li>
                <li class="menu-item" onclick="showReports()">
                    <i class="fas fa-chart-bar"></i> التقارير
                </li>
                <li class="menu-item" onclick="showBackupRestore()">
                    <i class="fas fa-database"></i> النسخ الاحتياطي
                </li>
            </ul>
        </div>

        <!-- القائمة السفلية للجوال - تصميم تطبيق -->
        <div class="mobile-bottom-nav">
            <div class="mobile-nav-items">
                <div class="mobile-nav-item active" onclick="showDashboard(); setActiveMobileNav(0)">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="mobile-nav-item" onclick="showProducts(); setActiveMobileNav(1)">
                    <i class="fas fa-box"></i>
                    <span>المنتجات</span>
                </div>
                <div class="mobile-nav-item" onclick="showOrders(); setActiveMobileNav(2)">
                    <i class="fas fa-shopping-cart"></i>
                    <span>الطلبات</span>
                </div>
                <div class="mobile-nav-item" onclick="showCustomers(); setActiveMobileNav(3)">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </div>
                <div class="mobile-nav-item" onclick="showInventory(); setActiveMobileNav(4)">
                    <i class="fas fa-warehouse"></i>
                    <span>المخزون</span>
                </div>
            </div>
        </div>

        <!-- منطقة المحتوى الرئيسي -->
        <div class="main-content-area" id="contentArea"></div>
    </div>

    <!-- باقي النماذج بنفس الهيكل ولكن مع تحديث العملة إلى جنيه -->

    <script>
        // ============================================
        // تعريف العملة - جنيه مصري
        // ============================================
        const CURRENCY_SYMBOL = 'ج.م';
        const CURRENCY_CODE = 'EGP';

        // دالة تنسيق العملة بالجنيه المصري
        function formatCurrency(amount) {
            return Number(amount).toFixed(2) + ' ' + CURRENCY_SYMBOL;
        }

        // ============================================
        // تهيئة Firebase للمصادقة فقط (نفس الإعدادات)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDmdHcXWducb8fg721sxa2gn3Ev6f3W0cc",
            authDomain: "ramdan-5aedb.firebaseapp.com",
            projectId: "ramdan-5aedb",
            storageBucket: "ramdan-5aedb.firebasestorage.app",
            messagingSenderId: "430366107983",
            appId: "1:430366107983:web:3b3105c8404f06de16bd3a",
            measurementId: "G-LLHG4FQCDZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // ============================================
        // المتغيرات العامة ونظام التخزين (نفس الكود السابق)
        // ============================================
        let productsData = [];
        let categoriesData = [];
        let ordersData = [];
        let customersData = [];
        let couponsData = [];
        let shippingData = [];

        let currentUser = null;
        let isInitialized = false;
        
        // مفاتيح التخزين المحلي
        const STORAGE_KEYS = {
            PRODUCTS: 'ecommerce_products',
            CATEGORIES: 'ecommerce_categories',
            ORDERS: 'ecommerce_orders',
            CUSTOMERS: 'ecommerce_customers',
            COUPONS: 'ecommerce_coupons',
            SETTINGS: 'ecommerce_settings'
        };

        // ============================================
        // دوال التخزين المحلي (نفس الكود السابق)
        // ============================================
        function loadAllLocalData() {
            try {
                productsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
                categoriesData = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
                ordersData = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
                customersData = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS)) || [];
                couponsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.COUPONS)) || [];
                
                // تحديث حالة المخزون للمنتجات
                productsData.forEach(product => {
                    product.status = calculateStockStatus(product.stockQuantity, product.minStock);
                });
                
                return true;
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                return false;
            }
        }

        function saveAllLocalData() {
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(productsData));
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categoriesData));
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(ordersData));
            localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customersData));
            localStorage.setItem(STORAGE_KEYS.COUPONS, JSON.stringify(couponsData));
        }

        // ============================================
        // دوال إدارة المنتجات مع تحديث العملة
        // ============================================
        function saveProduct() {
            const id = document.getElementById('productId').value;
            const isEdit = !!id;
            
            const productData = {
                name: document.getElementById('productName').value,
                code: document.getElementById('productCode').value,
                categoryId: document.getElementById('productCategory').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                stockQuantity: parseInt(document.getElementById('stockQuantity').value),
                minStock: parseInt(document.getElementById('minStock').value),
                images: document.getElementById('productImages').value,
                status: calculateStockStatus(
                    parseInt(document.getElementById('stockQuantity').value),
                    parseInt(document.getElementById('minStock').value)
                )
            };
            
            if (!productData.name || !productData.code || !productData.categoryId) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    const index = productsData.findIndex(p => p.id == id);
                    if (index !== -1) {
                        productData.id = id;
                        productData.createdAt = productsData[index].createdAt;
                        productsData[index] = productData;
                    }
                } else {
                    productData.id = Date.now().toString();
                    productData.createdAt = new Date().toISOString();
                    productsData.push(productData);
                }
                
                saveAllLocalData();
                closeProductForm();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث المنتج بنجاح' : 'تم إضافة المنتج بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ المنتج');
                showLoading(false);
            }
        }

        // ============================================
        // دوال العرض مع تصميم عصري وعملة الجنيه
        // ============================================
        
        function showDashboard() {
            // تحديث الإحصائيات
            updateStats();
            
            const totalRevenue = ordersData.reduce((sum, order) => sum + (order.total || 0), 0);
            const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
            const lowStockCount = productsData.filter(p => p.status === 'low-stock').length;
            
            document.getElementById('contentArea').innerHTML = `
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;">مرحباً بك في متجري</h2>
                    <p style="color: var(--text-secondary);">نظرة عامة على أداء متجرك اليوم</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${ordersData.length}</h3>
                            <p>إجمالي الطلبات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${productsData.length}</h3>
                            <p>المنتجات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${customersData.length}</h3>
                            <p>العملاء</p>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern">
                        <div class="stat-icon-modern" style="background: linear-gradient(135deg, #ec4899, #d946ef);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info-modern">
                            <h3>${formatCurrency(totalRevenue)}</h3>
                            <p>الإيرادات</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 24px;">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                                <i class="fas fa-clock" style="color: var(--primary-color); margin-left: 8px;"></i>
                                آخر الطلبات
                            </h3>
                            <button class="btn-modern btn-modern-sm" onclick="showOrders()">
                                عرض الكل
                            </button>
                        </div>
                        <div id="recentOrdersList">
                            ${renderRecentOrders()}
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-left: 8px;"></i>
                                تنبيهات المخزون
                            </h3>
                            <button class="btn-modern btn-modern-sm" onclick="showInventory()">
                                عرض الكل
                            </button>
                        </div>
                        <div id="lowStockList">
                            ${renderLowStockAlerts()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRecentOrders() {
            const recentOrders = [...ordersData]
                .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))
                .slice(0, 5);
            
            if (recentOrders.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 20px;">لا توجد طلبات حديثة</p>';
            }
            
            return recentOrders.map(order => {
                const customer = customersData.find(c => c.id === order.customerId);
                const statusColors = {
                    'pending': '#f59e0b',
                    'processing': '#3b82f6',
                    'shipped': '#8b5cf6',
                    'completed': '#10b981',
                    'cancelled': '#ef4444'
                };
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary);">${order.orderNumber}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${customer ? customer.name : 'غير معروف'}</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 700; color: var(--primary-color);">${formatCurrency(order.total || 0)}</div>
                            <span style="display: inline-block; padding: 4px 8px; background: ${statusColors[order.status]}20; color: ${statusColors[order.status]}; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 700;">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLowStockAlerts() {
            const lowStock = productsData.filter(p => p.status === 'low-stock').slice(0, 5);
            
            if (lowStock.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 20px;">لا توجد منتجات منخفضة المخزون</p>';
            }
            
            return lowStock.map(product => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">${product.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">المخزون: ${product.stockQuantity} / ${product.minStock}</div>
                    </div>
                    <button class="btn-modern btn-modern-sm" style="background: var(--warning-gradient);" onclick="updateProductStock('${product.id}')">
                        <i class="fas fa-plus"></i>
                        <span>تزويد</span>
                    </button>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        // تحديث عرض المنتجات مع العملة الجديدة
        function renderProductsGrid() {
            if (productsData.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">لا توجد منتجات. قم بإضافة منتج جديد</p>';
            }
            
            return productsData.map(product => {
                const category = categoriesData.find(c => c.id === product.categoryId);
                const stockStatus = product.status || calculateStockStatus(product.stockQuantity, product.minStock);
                const imageUrl = product.images ? product.images.split(',')[0] : '';
                
                return `
                    <div class="product-card-modern">
                        <div class="product-image-container">
                            ${imageUrl ? 
                                `<img src="${imageUrl.trim()}" alt="${product.name}">` : 
                                '<i class="fas fa-box-open" style="font-size: 3rem; color: var(--text-muted);"></i>'
                            }
                            <span class="product-badge badge-${stockStatus}">
                                ${stockStatus === 'in-stock' ? 'متوفر' : stockStatus === 'low-stock' ? 'منخفض' : 'نفذ'}
                            </span>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <div class="product-code">
                                <i class="fas fa-barcode"></i>
                                <span>${product.code}</span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <span style="background: var(--bg-light); padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; color: var(--text-secondary);">
                                    ${category ? category.name : 'غير مصنف'}
                                </span>
                                ${product.brand ? `
                                    <span style="background: var(--bg-light); padding: 4px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; color: var(--text-secondary);">
                                        ${product.brand}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="product-price-row">
                                <span class="product-price">${formatCurrency(product.salePrice)}</span>
                                <div class="product-stock">
                                    <i class="fas fa-boxes"></i>
                                    <span>${product.stockQuantity}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button class="btn-modern btn-modern-sm" style="flex: 1;" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i>
                                    <span>تعديل</span>
                                </button>
                                <button class="btn-modern btn-modern-sm" style="flex: 1; background: var(--danger-gradient);" onclick="deleteProduct('${product.id}')">
                                    <i class="fas fa-trash"></i>
                                    <span>حذف</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // تحديث دالة showProducts لاستخدام التصميم الجديد
        function showProducts() {
            setActiveMenuItem(1);
            
            document.getElementById('contentArea').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;">المنتجات</h2>
                        <p style="color: var(--text-secondary);">إدارة وعرض جميع منتجات متجرك</p>
                    </div>
                    <button class="btn-modern" onclick="openProductForm()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة منتج</span>
                    </button>
                </div>
                
                <div class="search-bar-modern">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchProducts" placeholder="ابحث عن منتج بالاسم أو الرمز..." onkeyup="filterProducts()">
                    <button onclick="filterProducts()">بحث</button>
                </div>
                
                <div class="product-grid" id="productsGrid">
                    ${renderProductsGrid()}
                </div>
            `;
        }

        // دوال مساعدة للتصميم الجديد
        function setActiveMenuItem(index) {
            // تحديث القائمة الجانبية
            document.querySelectorAll('.menu-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });
            
            // تحديث القائمة السفلية للجوال
            document.querySelectorAll('.mobile-nav-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });
        }

        function setActiveMobileNav(index) {
            document.querySelectorAll('.mobile-nav-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });
        }

        function closeMobileSidebar() {
            document.getElementById('mobileSidebar').classList.remove('active');
        }

        // تحديث دالة updateStats لاستخدام العملة الجديدة
        function updateStats() {
            try {
                const totalOrders = ordersData.length;
                const totalProducts = productsData.length;
                const totalCustomers = customersData.length;
                const totalRevenue = ordersData.reduce((sum, order) => sum + (order.total || 0), 0);
                
                if (document.getElementById('totalOrders')) {
                    document.getElementById('totalOrders').textContent = totalOrders;
                }
                if (document.getElementById('totalProducts')) {
                    document.getElementById('totalProducts').textContent = totalProducts;
                }
                if (document.getElementById('totalCustomers')) {
                    document.getElementById('totalCustomers').textContent = totalCustomers;
                }
                if (document.getElementById('totalRevenue')) {
                    document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // ============================================
        // تهيئة النظام والتحكم بالقوائم
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // قائمة الجوال
            const menuToggle = document.getElementById('menuToggle');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const fabButton = document.getElementById('fabButton');
            
            if (menuToggle && mobileSidebar) {
                menuToggle.addEventListener('click', function() {
                    mobileSidebar.classList.toggle('active');
                });
            }
            
            // زر القائمة العائم
            if (fabButton) {
                fabButton.addEventListener('click', function() {
                    // فتح قائمة الإجراءات السريعة
                    if (document.getElementById('contentArea').innerHTML.includes('المنتجات')) {
                        openProductForm();
                    } else {
                        showProducts();
                    }
                });
            }
            
            // إغلاق القائمة عند النقر خارجها
            document.addEventListener('click', function(event) {
                if (mobileSidebar && !mobileSidebar.contains(event.target) && 
                    menuToggle && !menuToggle.contains(event.target) && 
                    mobileSidebar.classList.contains('active')) {
                    mobileSidebar.classList.remove('active');
                }
            });
            
            // التحقق من حالة تسجيل الدخول
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('loggedInUser').textContent = user.email || 'مستخدم';
                    document.getElementById('mobileUserEmail').textContent = user.email || 'مستخدم';
                    loadAllLocalData();
                }
            });
        });

        // تحديث جميع دوال العرض الأخرى لاستخدام formatCurrency
        // بدلاً من إضافة 'ر.س' مباشرة
        function formatCurrency(amount) {
            return Number(amount || 0).toFixed(2) + ' ' + CURRENCY_SYMBOL;
        }

        // دوال مساعدة أخرى (نفس الكود السابق مع تحديث العملة)
        function calculateStockStatus(quantity, minStock) {
            if (quantity <= 0) return 'out-of-stock';
            if (quantity <= minStock) return 'low-stock';
            return 'in-stock';
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // ============================================
        // دوال المصادقة (نفس الكود السابق)
        // ============================================
        function handleLogin() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.style.display = 'none';
            
            if (!email || !password) {
                errorDiv.querySelector('span').textContent = 'الرجاء إدخال البريد الإلكتروني وكلمة المرور';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoading(true);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadAllLocalData();
                    
                    document.getElementById('loggedInUser').textContent = currentUser.email;
                    document.getElementById('mobileUserEmail').textContent = currentUser.email;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    
                    showDashboard();
                    showSuccess('تم تسجيل الدخول بنجاح');
                    showLoading(false);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    let errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    errorDiv.querySelector('span').textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    showLoading(false);
                });
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                auth.signOut().then(() => {
                    currentUser = null;
                    document.getElementById('main-content').style.display = 'none';
                    document.getElementById('login-screen').style.display = 'flex';
                    showSuccess('تم تسجيل الخروج بنجاح');
                });
            }
        }

        // نسخ جميع الدوال الأخرى من الكود الأصلي مع تحديث العملة
        // (products, orders, customers, inventory, backup, export, etc.)
        // مع الحفاظ على نفس الوظائف ولكن مع تنسيق العملة الجديد

        // ============================================
        // تصدير الدوال العامة
        // ============================================
        window.showDashboard = showDashboard;
        window.showProducts = showProducts;
        window.showCategories = showCategories;
        window.showOrders = showOrders;
        window.showCustomers = showCustomers;
        window.showInventory = showInventory;
        window.showAdvancedSearch = showAdvancedSearch;
        window.showReports = showReports;
        window.showBackupRestore = showBackupRestore;
        window.showSignupForm = showSignupForm;
        window.closeSignupForm = closeSignupForm;
        window.handleSignup = handleSignup;
        window.handlePasswordReset = handlePasswordReset;
        window.logout = logout;
        window.openProductForm = openProductForm;
        window.closeProductForm = closeProductForm;
        window.saveProduct = saveProduct;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.saveCategory = saveCategory;
        window.deleteCategory = deleteCategory;
        window.openOrderForm = openOrderForm;
        window.closeOrderForm = closeOrderForm;
        window.saveOrder = saveOrder;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.openCustomerForm = openCustomerForm;
        window.closeCustomerForm = closeCustomerForm;
        window.saveCustomer = saveCustomer;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.exportAllToExcel = exportAllToExcel;
        window.exportAllToJSON = exportAllToJSON;
        window.clearAllLocalData = clearAllLocalData;
        window.formatCurrency = formatCurrency;
        window.setActiveMobileNav = setActiveMobileNav;
        window.closeMobileSidebar = closeMobileSidebar;
// ============================================
        // دوال إدارة النماذج
        // ============================================

        function showSignupForm() {
            document.getElementById('signupFormModal').classList.add('active');
        }

        function closeSignupForm() {
            const modal = document.getElementById('signupFormModal');
            modal.classList.remove('active');
            document.getElementById('signupForm').reset();
            document.getElementById('signupError').style.display = 'none';
        }

        function showBackupRestore() {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.sidebar-menu li:last-child').classList.add('active');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="control-panel">
                    <div class="panel-header">
                        <h2><i class="fas fa-database"></i> <span>النسخ الاحتياطي والاستعادة</span></h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="openBackupModal()">
                                <i class="fas fa-cog"></i> <span>إدارة النسخ الاحتياطي</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <h3>مرحلاً بك في صفحة النسخ الاحتياطي</h3>
                        <p>هنا يمكنك إدارة النسخ الاحتياطية لبيانات متجرك.</p>
                        
                        <div class="stats-cards" style="margin-top: 30px;">
                            <div class="stat-card">
                                <div class="stat-icon products">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${productsData.length}</h3>
                                    <p>المنتجات</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon customers">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${customersData.length}</h3>
                                    <p>العملاء</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon orders">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${ordersData.length}</h3>
                                    <p>الطلبات</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon categories">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>${categoriesData.length}</h3>
                                    <p>التصنيفات</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <h4><i class="fas fa-file-excel" style="color: green;"></i> تصدير إلى Excel</h4>
                                <p>تصدير جميع البيانات إلى ملف Excel متعدد الأوراق</p>
                                <button class="btn btn-success" onclick="exportAllToExcel()" style="margin-top: 10px;">
                                    <i class="fas fa-download"></i> تصدير Excel
                                </button>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <h4><i class="fas fa-file-code" style="color: blue;"></i> تصدير إلى JSON</h4>
                                <p>تصدير جميع البيانات إلى ملف JSON للنسخ الاحتياطية</p>
                                <button class="btn btn-info" onclick="exportAllToJSON()" style="margin-top: 10px;">
                                    <i class="fas fa-download"></i> تصدير JSON
                                </button>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <h4><i class="fas fa-file-import" style="color: orange;"></i> استيراد من JSON</h4>
                                <p>استيراد البيانات من ملف JSON نسخة احتياطية</p>
                                <div style="margin-top: 10px;">
                                    <input type="file" id="importFileMain" accept=".json" style="display: none;" onchange="importFromJSON(event)">
                                    <button class="btn btn-warning" onclick="document.getElementById('importFileMain').click()">
                                        <i class="fas fa-upload"></i> استيراد بيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px; padding: 20px; background: #fff3cd; border-radius: 12px; border: 1px solid #ffeaa7;">
                            <h4><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> منطقة الخطر</h4>
                            <p>حذف جميع البيانات المحلية. هذا الإجراء لا يمكن التراجع عنه.</p>
                            <button class="btn btn-danger" onclick="clearAllLocalData()" style="margin-top: 10px;">
                                <i class="fas fa-trash"></i> حذف جميع البيانات
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openBackupModal() {
            document.getElementById('backupModal').classList.add('active');
            
            // تحديث الإحصائيات
            document.getElementById('localProductsCount').textContent = productsData.length;
            document.getElementById('localCustomersCount').textContent = customersData.length;
            document.getElementById('localOrdersCount').textContent = ordersData.length;
            document.getElementById('localCategoriesCount').textContent = categoriesData.length;
        }

        function closeBackupModal() {
            document.getElementById('backupModal').classList.remove('active');
        }

        // ============================================
        // دوال النظام الأساسية
        // ============================================

        function initSystem() {
            if (isInitialized) return;
            
            console.log('جاري تهيئة نظام إدارة المتجر مع التخزين المحلي...');
            
            try {
                loadAllLocalData();
                updateStats();
                updateRecentData();
                
                isInitialized = true;
                
                console.log('تم التهيئة بنجاح:', {
                    categories: categoriesData.length,
                    products: productsData.length,
                    customers: customersData.length,
                    orders: ordersData.length,
                    coupons: couponsData.length
                });
            } catch (error) {
                console.error('Error initializing system:', error);
                showError('حدث خطأ أثناء تحميل البيانات');
            }
        }

        // ============================================
        // دوال إدارة المنتجات (محلي)
        // ============================================

        function saveProduct() {
            const id = document.getElementById('productId').value;
            const isEdit = !!id;
            
            const productData = {
                name: document.getElementById('productName').value,
                code: document.getElementById('productCode').value,
                categoryId: document.getElementById('productCategory').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                stockQuantity: parseInt(document.getElementById('stockQuantity').value),
                minStock: parseInt(document.getElementById('minStock').value),
                images: document.getElementById('productImages').value,
                status: calculateStockStatus(
                    parseInt(document.getElementById('stockQuantity').value),
                    parseInt(document.getElementById('minStock').value)
                )
            };
            
            if (!productData.name || !productData.code || !productData.categoryId) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    // تحديث المنتج الموجود
                    const index = productsData.findIndex(p => p.id == id);
                    if (index !== -1) {
                        productData.id = id;
                        productsData[index] = productData;
                    }
                } else {
                    // إضافة منتج جديد
                    productData.id = Date.now().toString(); // معرف فريد
                    productData.createdAt = new Date().toISOString();
                    productsData.push(productData);
                }
                
                // حفظ البيانات محلياً
                saveProductsToLocal();
                
                closeProductForm();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث بيانات المنتج بنجاح' : 'تم إضافة المنتج الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ المنتج: ' + error.message);
                showLoading(false);
            }
        }

        function deleteProduct(id) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
            
            try {
                showLoading(true);
                productsData = productsData.filter(p => p.id != id);
                saveProductsToLocal();
                showDashboard();
                showSuccess('تم حذف المنتج بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف المنتج: ' + error.message);
                showLoading(false);
            }
        }

        // ============================================
        // دوال إدارة التصنيفات (محلي)
        // ============================================

        function saveCategory() {
            const name = prompt('أدخل اسم التصنيف الجديد:');
            if (!name) return;
            
            const description = prompt('أدخل وصف التصنيف (اختياري):');
            
            const categoryData = {
                id: Date.now().toString(),
                name: name,
                description: description || '',
                createdAt: new Date().toISOString()
            };
            
            try {
                showLoading(true);
                categoriesData.push(categoryData);
                saveCategoriesToLocal();
                showCategories();
                showSuccess('تم إضافة التصنيف الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء إضافة التصنيف: ' + error.message);
                showLoading(false);
            }
        }

        function deleteCategory(id) {
            if (!confirm('هل أنت متأكد من حذف هذا التصنيف؟')) return;
            
            try {
                showLoading(true);
                categoriesData = categoriesData.filter(c => c.id != id);
                saveCategoriesToLocal();
                showCategories();
                showSuccess('تم حذف التصنيف بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف التصنيف: ' + error.message);
                showLoading(false);
            }
        }

        // ============================================
        // دوال إدارة العملاء (محلي)
        // ============================================

        function saveCustomer() {
            const id = document.getElementById('customerId').value;
            const isEdit = !!id;
            
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                city: document.getElementById('customerCity').value,
                birthdate: document.getElementById('customerBirthdate').value,
                notes: document.getElementById('customerNotes').value
            };
            
            if (!customerData.name || !customerData.email || !customerData.phone) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    const index = customersData.findIndex(c => c.id == id);
                    if (index !== -1) {
                        customerData.id = id;
                        customerData.totalOrders = customersData[index].totalOrders || 0;
                        customerData.totalSpent = customersData[index].totalSpent || 0;
                        customersData[index] = customerData;
                    }
                } else {
                    customerData.id = Date.now().toString();
                    customerData.totalOrders = 0;
                    customerData.totalSpent = 0;
                    customersData.push(customerData);
                }
                
                saveCustomersToLocal();
                closeCustomerForm();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث بيانات العميل بنجاح' : 'تم إضافة العميل الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ العميل: ' + error.message);
                showLoading(false);
            }
        }

        function deleteCustomer(id) {
            if (!confirm('هل أنت متأكد من حذف هذا العميل؟')) return;
            
            try {
                showLoading(true);
                customersData = customersData.filter(c => c.id != id);
                saveCustomersToLocal();
                showDashboard();
                showSuccess('تم حذف العميل بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف العميل: ' + error.message);
                showLoading(false);
            }
        }

        // ============================================
        // دوال إدارة الطلبات (محلي)
        // ============================================

        function saveOrder() {
            const id = document.getElementById('orderId').value;
            const isEdit = !!id;
            
            // جمع بيانات منتجات الطلب
            const orderItems = [];
            let subtotal = 0;
            
            document.querySelectorAll('.order-item').forEach(item => {
                const productSelect = item.querySelector('.order-product-select');
                const quantityInput = item.querySelector('.order-quantity');
                const priceInput = item.querySelector('.order-price');
                
                if (productSelect.value && quantityInput.value && priceInput.value) {
                    const productId = productSelect.value;
                    const quantity = parseInt(quantityInput.value);
                    const price = parseFloat(priceInput.value);
                    
                    orderItems.push({
                        productId: productId,
                        quantity: quantity,
                        price: price
                    });
                    
                    subtotal += quantity * price;
                }
            });
            
            if (orderItems.length === 0) {
                showError('يجب إضافة منتجات على الأقل إلى الطلب');
                return;
            }
            
            const orderData = {
                orderNumber: document.getElementById('orderNumber').value,
                customerId: document.getElementById('orderCustomerId').value,
                orderDate: document.getElementById('orderDate').value,
                status: document.getElementById('orderStatus').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                shippingMethod: document.getElementById('shippingMethod').value,
                shippingAddress: document.getElementById('shippingAddress').value,
                notes: document.getElementById('orderNotes').value,
                items: orderItems,
                subtotal: subtotal,
                shippingCost: 0,
                discount: 0,
                tax: subtotal * 0.15,
                total: subtotal + (subtotal * 0.15)
            };
            
            if (!orderData.orderNumber || !orderData.customerId || !orderData.orderDate) {
                showError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            try {
                showLoading(true);
                
                if (isEdit) {
                    const index = ordersData.findIndex(o => o.id == id);
                    if (index !== -1) {
                        orderData.id = id;
                        ordersData[index] = orderData;
                    }
                } else {
                    orderData.id = Date.now().toString();
                    ordersData.push(orderData);
                    
                    // تحديث مخزون المنتجات
                    orderData.items.forEach(item => {
                        const product = productsData.find(p => p.id == item.productId);
                        if (product) {
                            const newStockQuantity = product.stockQuantity - item.quantity;
                            product.stockQuantity = newStockQuantity;
                            product.status = calculateStockStatus(newStockQuantity, product.minStock);
                        }
                    });
                    saveProductsToLocal();
                }
                
                saveOrdersToLocal();
                closeOrderForm();
                showDashboard();
                showSuccess(isEdit ? 'تم تحديث الطلب بنجاح' : 'تم إضافة الطلب الجديد بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حفظ الطلب: ' + error.message);
                showLoading(false);
            }
        }

        function deleteOrder(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟')) return;
            
            try {
                showLoading(true);
                ordersData = ordersData.filter(o => o.id != id);
                saveOrdersToLocal();
                showDashboard();
                showSuccess('تم حذف الطلب بنجاح');
                showLoading(false);
            } catch (error) {
                showError('حدث خطأ أثناء حذف الطلب: ' + error.message);
                showLoading(false);
            }
        }

        // ============================================
        // دوال مساعدة
        // ============================================

        function calculateStockStatus(quantity, minStock) {
            if (quantity <= 0) return 'out-of-stock';
            if (quantity <= minStock) return 'low-stock';
            return 'in-stock';
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }

        function showExportLoading(message) {
            const loading = document.getElementById('exportLoading');
            const messageElement = document.getElementById('exportLoadingText');
            
            if (loading && messageElement) {
                messageElement.textContent = message;
                loading.classList.add('active');
            }
        }

        function hideExportLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        // ============================================
        // دوال العرض (باقي الدوال من النسخة الأصلية)
        // ============================================
        // Note: باقي الدوال مثل showDashboard, showProducts, etc. تبقى كما هي
        // ولكنها تستخدم الآن البيانات المحلية بدلاً من Firebase
        // ============================================
// دوال عرض الصفحات الرئيسية
// ============================================

function showDashboard() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(1)').classList.add('active');
    
    // تحديث الإحصائيات
    updateStats();
    updateRecentData();
    
    document.getElementById('contentArea').innerHTML = `
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon orders">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalOrders">0</h3>
                    <p>إجمالي الطلبات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon products">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalProducts">0</h3>
                    <p>المنتجات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon customers">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalCustomers">0</h3>
                    <p>العملاء</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon revenue">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">0 ر.س</h3>
                    <p>الإيرادات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="pendingOrders">0</h3>
                    <p>طلبات معلقة</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon categories">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalCategories">0</h3>
                    <p>التصنيفات</p>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-line"></i> <span>نظرة عامة على المتجر</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showProducts()">
                        <i class="fas fa-box"></i> <span>إدارة المنتجات</span>
                    </button>
                    <button class="btn btn-success" onclick="showOrders()">
                        <i class="fas fa-shopping-cart"></i> <span>إدارة الطلبات</span>
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div>
                    <h4 style="color: var(--header-bg); margin-bottom: 15px;">آخر الطلبات</h4>
                    <div id="recentOrdersTable">
                        <p>جاري تحميل الطلبات...</p>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--header-bg); margin-bottom: 15px;">المنتجات منخفضة المخزون</h4>
                    <div id="lowStockProducts">
                        <p>جاري تحميل المنتجات...</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="color: var(--header-bg); margin-bottom: 15px;">إحصائيات المبيعات</h4>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <canvas id="salesChart" height="100"></canvas>
                </div>
            </div>
        </div>
    `;
    
    // تحميل البيانات بعد العرض
    setTimeout(() => {
        loadDashboardCharts();
    }, 100);
}

function showProducts() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(2)').classList.add('active');
    
    const categoriesOptions = categoriesData.map(c => 
        `<option value="${c.id}">${c.name}</option>`
    ).join('');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-box"></i> <span>إدارة المنتجات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openProductForm()">
                        <i class="fas fa-plus"></i> <span>إضافة منتج جديد</span>
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel('products')">
                        <i class="fas fa-download"></i> <span>تصدير Excel</span>
                    </button>
                    <div class="export-options">
                        <button class="btn btn-info" onclick="toggleExportMenu()">
                            <i class="fas fa-ellipsis-h"></i> <span>خيارات إضافية</span>
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <a class="export-option" onclick="exportToPDF('products')">
                                <i class="fas fa-file-pdf"></i> <span>تصدير PDF</span>
                            </a>
                            <a class="export-option" onclick="printTable('products')">
                                <i class="fas fa-print"></i> <span>طباعة</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <input type="text" id="searchProducts" class="form-input" 
                       placeholder="ابحث عن منتج بالاسم أو الرمز..." 
                       style="width: 100%; padding: 10px;" 
                       onkeyup="filterProductsTable()">
            </div>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الصورة</th>
                            <th>اسم المنتج</th>
                            <th>الرمز</th>
                            <th>التصنيف</th>
                            <th>سعر البيع</th>
                            <th>المخزون</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        ${renderProductsTable()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي المنتجات: <strong>${productsData.length}</strong> منتج</p>
            </div>
        </div>
    `;
    
    // تحديث خانة التصنيف في نموذج المنتج
    updateCategorySelect();
}

function renderProductsTable() {
    if (productsData.length === 0) {
        return `<tr><td colspan="8" style="text-align: center; padding: 30px;">لا توجد منتجات. قم بإضافة منتجات جديدة.</td></tr>`;
    }
    
    return productsData.map(product => {
        const category = categoriesData.find(c => c.id === product.categoryId);
        const stockStatus = product.status || calculateStockStatus(product.stockQuantity, product.minStock);
        const imageUrl = product.images ? product.images.split(',')[0] : '';
        
        return `
            <tr>
                <td style="text-align: center;">
                    ${imageUrl ? `<img src="${imageUrl.trim()}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : '<i class="fas fa-image" style="color: #ccc;"></i>'}
                </td>
                <td>${product.name}</td>
                <td><span class="product-code">${product.code}</span></td>
                <td>${category ? category.name : 'غير مصنف'}</td>
                <td><span class="price-tag">${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س</span></td>
                <td>${product.stockQuantity}</td>
                <td>
                    <span class="stock-badge ${stockStatus}">
                        ${stockStatus === 'in-stock' ? 'متوفر' : stockStatus === 'low-stock' ? 'منخفض' : 'نفذ'}
                    </span>
                </td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit" onclick="editProduct('${product.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteProduct('${product.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn view" onclick="viewProductDetails('${product.id}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showCategories() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(3)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-tags"></i> <span>إدارة التصنيفات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveCategory()">
                        <i class="fas fa-plus"></i> <span>إضافة تصنيف جديد</span>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                ${categoriesData.length === 0 ? 
                    '<p style="text-align: center; padding: 30px; color: #666;">لا توجد تصنيفات. قم بإضافة تصنيفات جديدة.</p>' :
                    categoriesData.map(category => {
                        const productCount = productsData.filter(p => p.categoryId === category.id).length;
                        return `
                            <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: var(--header-bg);">${category.name}</h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${category.description || 'لا يوجد وصف'}</p>
                                    <span style="font-size: 12px; color: #4361ee;">${productCount} منتج</span>
                                </div>
                                <div>
                                    <button class="action-btn delete" onclick="deleteCategory('${category.id}')" style="margin-right: 5px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')
                }
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي التصنيفات: <strong>${categoriesData.length}</strong> تصنيف</p>
            </div>
        </div>
    `;
}

function showOrders() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(4)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-shopping-cart"></i> <span>إدارة الطلبات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openOrderForm()">
                        <i class="fas fa-plus"></i> <span>إضافة طلب جديد</span>
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel('orders')">
                        <i class="fas fa-download"></i> <span>تصدير Excel</span>
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>رقم الطلب</th>
                            <th>العميل</th>
                            <th>التاريخ</th>
                            <th>المجموع</th>
                            <th>الحالة</th>
                            <th>طريقة الدفع</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        ${renderOrdersTable()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي الطلبات: <strong>${ordersData.length}</strong> طلب</p>
            </div>
        </div>
    `;
}

function renderOrdersTable() {
    if (ordersData.length === 0) {
        return `<tr><td colspan="7" style="text-align: center; padding: 30px;">لا توجد طلبات. قم بإضافة طلبات جديدة.</td></tr>`;
    }
    
    return ordersData.map(order => {
        const customer = customersData.find(c => c.id === order.customerId);
        const statusText = {
            'pending': 'قيد الانتظار',
            'processing': 'قيد المعالجة',
            'shipped': 'تم الشحن',
            'completed': 'مكتمل',
            'cancelled': 'ملغي'
        };
        
        return `
            <tr>
                <td><strong>${order.orderNumber}</strong></td>
                <td>${customer ? customer.name : 'غير معروف'}</td>
                <td>${order.orderDate}</td>
                <td><span class="price-tag">${order.total ? order.total.toFixed(2) : '0.00'} ر.س</span></td>
                <td><span class="status-badge ${order.status}">${statusText[order.status] || order.status}</span></td>
                <td>${order.paymentMethod || 'غير محدد'}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn view" onclick="viewOrderDetails('${order.id}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit" onclick="editOrder('${order.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteOrder('${order.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showCustomers() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(5)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-users"></i> <span>إدارة العملاء</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openCustomerForm()">
                        <i class="fas fa-plus"></i> <span>إضافة عميل جديد</span>
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel('customers')">
                        <i class="fas fa-download"></i> <span>تصدير Excel</span>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <input type="text" id="searchCustomers" class="form-input" 
                       placeholder="ابحث عن عميل بالاسم أو البريد الإلكتروني..." 
                       style="width: 100%; padding: 10px;" 
                       onkeyup="filterCustomersTable()">
            </div>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>رقم الهاتف</th>
                            <th>المدينة</th>
                            <th>عدد الطلبات</th>
                            <th>إجمالي المشتريات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        ${renderCustomersTable()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666;">
                <p>إجمالي العملاء: <strong>${customersData.length}</strong> عميل</p>
            </div>
        </div>
    `;
}

function renderCustomersTable() {
    if (customersData.length === 0) {
        return `<tr><td colspan="7" style="text-align: center; padding: 30px;">لا توجد عملاء. قم بإضافة عملاء جدد.</td></tr>`;
    }
    
    return customersData.map(customer => {
        const orderCount = ordersData.filter(o => o.customerId === customer.id).length;
        const totalSpent = ordersData
            .filter(o => o.customerId === customer.id)
            .reduce((sum, order) => sum + (order.total || 0), 0);
        
        return `
            <tr>
                <td>${customer.name}</td>
                <td>${customer.email}</td>
                <td>${customer.phone}</td>
                <td>${customer.city || 'غير محدد'}</td>
                <td>${orderCount}</td>
                <td><span class="price-tag">${totalSpent.toFixed(2)} ر.س</span></td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit" onclick="editCustomer('${customer.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn view" onclick="viewCustomerDetails('${customer.id}')" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteCustomer('${customer.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function showInventory() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(6)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-warehouse"></i> <span>إدارة المخزون</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showProducts()">
                        <i class="fas fa-box"></i> <span>المنتجات</span>
                    </button>
                    <button class="btn btn-warning" onclick="showLowStockAlerts()">
                        <i class="fas fa-exclamation-triangle"></i> <span>عرض التنبيهات</span>
                    </button>
                </div>
            </div>
            
            <div class="stock-tracker">
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--product-color);">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stock-info">
                        <h4>المنتجات المتوفرة</h4>
                        <p>${productsData.filter(p => p.status === 'in-stock').length} منتج</p>
                        <div class="stock-progress">
                            <div class="progress-bar high" style="width: ${calculateStockPercentage('in-stock')}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--warning-color);">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div class="stock-info">
                        <h4>المنتجات منخفضة المخزون</h4>
                        <p>${productsData.filter(p => p.status === 'low-stock').length} منتج</p>
                        <div class="stock-progress">
                            <div class="progress-bar medium" style="width: ${calculateStockPercentage('low-stock')}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stock-item">
                    <div class="stock-icon" style="background: var(--danger-color);">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stock-info">
                        <h4>المنتجات غير المتوفرة</h4>
                        <p>${productsData.filter(p => p.status === 'out-of-stock').length} منتج</p>
                        <div class="stock-progress">
                            <div class="progress-bar low" style="width: ${calculateStockPercentage('out-of-stock')}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="color: var(--header-bg); margin-bottom: 15px;">منتجات منخفضة المخزون</h4>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم المنتج</th>
                                <th>الرمز</th>
                                <th>المخزون الحالي</th>
                                <th>الحد الأدنى</th>
                                <th>الفرق</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderLowStockProducts()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function calculateStockPercentage(status) {
    if (productsData.length === 0) return 0;
    const count = productsData.filter(p => p.status === status).length;
    return Math.round((count / productsData.length) * 100);
}

function renderLowStockProducts() {
    const lowStockProducts = productsData.filter(p => p.status === 'low-stock');
    
    if (lowStockProducts.length === 0) {
        return `<tr><td colspan="6" style="text-align: center; padding: 30px;">لا توجد منتجات منخفضة المخزون.</td></tr>`;
    }
    
    return lowStockProducts.map(product => {
        const difference = product.stockQuantity - product.minStock;
        return `
            <tr>
                <td>${product.name}</td>
                <td><span class="product-code">${product.code}</span></td>
                <td><span class="stock-badge low-stock">${product.stockQuantity}</span></td>
                <td>${product.minStock}</td>
                <td style="color: ${difference < 0 ? 'var(--danger-color)' : 'var(--warning-color)'};">
                    ${difference}
                </td>
                <td>
                    <button class="action-btn stock" onclick="updateProductStock('${product.id}')" title="تحديث المخزون">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateProductStock(productId) {
    const product = productsData.find(p => p.id === productId);
    if (!product) return;
    
    const newStock = prompt(`إضافة كميات للمنتج: ${product.name}\nالمخزون الحالي: ${product.stockQuantity}\nأدخل الكمية المراد إضافتها:`, "10");
    
    if (newStock && !isNaN(newStock) && parseInt(newStock) > 0) {
        product.stockQuantity += parseInt(newStock);
        product.status = calculateStockStatus(product.stockQuantity, product.minStock);
        saveProductsToLocal();
        showSuccess(`تم تحديث مخزون ${product.name} إلى ${product.stockQuantity}`);
        showInventory();
    }
}

function showAdvancedSearch() {
    document.getElementById('searchModal').classList.add('active');
}

function showLowStockAlerts() {
    document.getElementById('alertsModal').classList.add('active');
    loadLowStockAlerts();
}

function showReports() {
    document.getElementById('reportsModal').classList.add('active');
}

function showSalesAnalytics() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(10)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-line"></i> <span>تحليل المبيعات</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="exportToExcel('analytics')">
                        <i class="fas fa-download"></i> <span>تصدير التقرير</span>
                    </button>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3>مبيعات المنتجات حسب التصنيف</h3>
                    <select class="chart-select" onchange="updateSalesChart()" id="chartPeriod">
                        <option value="month">آخر شهر</option>
                        <option value="quarter">آخر ربع سنة</option>
                        <option value="year">آخر سنة</option>
                        <option value="all">كل الفترات</option>
                    </select>
                </div>
                <canvas id="categorySalesChart" height="100"></canvas>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="chart-container">
                    <h3>أفضل المنتجات مبيعاً</h3>
                    <div id="topProductsList" style="margin-top: 15px;">
                        ${renderTopProducts()}
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>المبيعات الشهرية</h3>
                    <canvas id="monthlySalesChart" height="200"></canvas>
                </div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        loadSalesAnalyticsCharts();
    }, 100);
}

function showCoupons() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(11)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-ticket-alt"></i> <span>إدارة الكوبونات والعروض</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addCoupon()">
                        <i class="fas fa-plus"></i> <span>إضافة كوبون جديد</span>
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <p style="text-align: center; color: #666; padding: 20px;">
                    هذه الصفحة قيد التطوير. ستتوفر قريباً.
                </p>
            </div>
        </div>
    `;
}

function showShipping() {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.sidebar-menu li:nth-child(12)').classList.add('active');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-shipping-fast"></i> <span>إدارة الشحن والتوصيل</span></h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addShippingMethod()">
                        <i class="fas fa-plus"></i> <span>إضافة طريقة شحن</span>
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <p style="text-align: center; color: #666; padding: 20px;">
                    هذه الصفحة قيد التطوير. ستتوفر قريباً.
                </p>
            </div>
        </div>
    `;
}

// ============================================
// دوال النماذج والفتح والإغلاق
// ============================================

function openProductForm(productId = null) {
    const modal = document.getElementById('productFormModal');
    const formTitle = document.getElementById('productFormTitle');
    const form = document.getElementById('productForm');
    
    form.reset();
    document.getElementById('productId').value = '';
    
    if (productId) {
        const product = productsData.find(p => p.id === productId);
        if (product) {
            formTitle.textContent = 'تعديل بيانات المنتج';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCode').value = product.code;
            document.getElementById('productCategory').value = product.categoryId;
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('purchasePrice').value = product.purchasePrice || '';
            document.getElementById('salePrice').value = product.salePrice || '';
            document.getElementById('stockQuantity').value = product.stockQuantity || 0;
            document.getElementById('minStock').value = product.minStock || 5;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productImages').value = product.images || '';
        }
    } else {
        formTitle.textContent = 'إضافة منتج جديد';
    }
    
    updateCategorySelect();
    modal.classList.add('active');
}

function closeProductForm() {
    document.getElementById('productFormModal').classList.remove('active');
    document.getElementById('productForm').reset();
}

function editProduct(id) {
    openProductForm(id);
}

function openOrderForm(orderId = null) {
    const modal = document.getElementById('orderFormModal');
    const formTitle = document.getElementById('orderFormTitle');
    const form = document.getElementById('orderForm');
    
    form.reset();
    document.getElementById('orderId').value = '';
    document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
    
    // توليد رقم طلب تلقائي
    document.getElementById('orderNumber').value = 'ORD-' + Date.now().toString().slice(-6);
    
    // تحديث قوائم العملاء والمنتجات
    updateCustomerSelect();
    updateOrderProductsSelect();
    
    if (orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (order) {
            formTitle.textContent = 'تعديل بيانات الطلب';
            document.getElementById('orderId').value = order.id;
            document.getElementById('orderNumber').value = order.orderNumber;
            document.getElementById('orderCustomerId').value = order.customerId;
            document.getElementById('orderDate').value = order.orderDate;
            document.getElementById('orderStatus').value = order.status;
            document.getElementById('paymentMethod').value = order.paymentMethod || 'cash';
            document.getElementById('shippingMethod').value = order.shippingMethod || 'standard';
            document.getElementById('shippingAddress').value = order.shippingAddress;
            document.getElementById('orderNotes').value = order.notes || '';
            
            // إضافة منتجات الطلب
            const container = document.getElementById('orderItemsContainer');
            container.innerHTML = '';
            
            order.items.forEach(item => {
                addOrderItem(item);
            });
        }
    } else {
        formTitle.textContent = 'إضافة طلب جديد';
        document.getElementById('orderItemsContainer').innerHTML = '';
        addOrderItem(); // إضافة منتج واحد افتراضي
    }
    
    modal.classList.add('active');
}

function addOrderItem(itemData = null) {
    const container = document.getElementById('orderItemsContainer');
    const itemId = 'item-' + Date.now();
    
    const itemHTML = `
        <div class="order-item" id="${itemId}" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
            <select class="order-product-select form-select" style="flex: 2;" onchange="updateOrderItemPrice(this)">
                <option value="">اختر المنتج</option>
                ${productsData.map(p => 
                    `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${p.salePrice} ر.س</option>`
                ).join('')}
            </select>
            <input type="number" class="order-quantity form-input" placeholder="الكمية" min="1" value="${itemData ? itemData.quantity : 1}" style="flex: 1;" onchange="calculateOrderTotal()">
            <input type="number" class="order-price form-input" placeholder="السعر" min="0" step="0.01" value="${itemData ? itemData.price : 0}" style="flex: 1;" onchange="calculateOrderTotal()">
            <button type="button" class="btn btn-danger" onclick="removeOrderItem('${itemId}')" style="width: 40px;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHTML);
    
    if (itemData) {
        const select = document.querySelector(`#${itemId} .order-product-select`);
        if (select) {
            select.value = itemData.productId;
            updateOrderItemPrice(select);
        }
    }
    
    calculateOrderTotal();
}

function removeOrderItem(itemId) {
    const item = document.getElementById(itemId);
    if (item) {
        item.remove();
        calculateOrderTotal();
    }
}

function updateOrderItemPrice(select) {
    const price = select.options[select.selectedIndex]?.dataset.price || 0;
    const quantityInput = select.closest('.order-item').querySelector('.order-quantity');
    const priceInput = select.closest('.order-item').querySelector('.order-price');
    
    if (priceInput) {
        priceInput.value = price;
        calculateOrderTotal();
    }
}

function calculateOrderTotal() {
    // يمكن تنفيذ حساب المجموع هنا إذا لزم الأمر
}

function closeOrderForm() {
    document.getElementById('orderFormModal').classList.remove('active');
    document.getElementById('orderForm').reset();
}

function editOrder(id) {
    openOrderForm(id);
}

function openCustomerForm(customerId = null) {
    const modal = document.getElementById('customerFormModal');
    const formTitle = document.getElementById('customerFormTitle');
    const form = document.getElementById('customerForm');
    
    form.reset();
    document.getElementById('customerId').value = '';
    
    if (customerId) {
        const customer = customersData.find(c => c.id === customerId);
        if (customer) {
            formTitle.textContent = 'تعديل بيانات العميل';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerCity').value = customer.city || '';
            document.getElementById('customerBirthdate').value = customer.birthdate || '';
            document.getElementById('customerNotes').value = customer.notes || '';
        }
    } else {
        formTitle.textContent = 'إضافة عميل جديد';
    }
    
    modal.classList.add('active');
}

function closeCustomerForm() {
    document.getElementById('customerFormModal').classList.remove('active');
    document.getElementById('customerForm').reset();
}

function editCustomer(id) {
    openCustomerForm(id);
}

function closeSearchModal() {
    document.getElementById('searchModal').classList.remove('active');
}

function closeAlertsModal() {
    document.getElementById('alertsModal').classList.remove('active');
}

function closeReportsModal() {
    document.getElementById('reportsModal').classList.remove('active');
}

// ============================================
// دوال تحديث الإحصائيات
// ============================================

function updateStats() {
    try {
        // حساب الإحصائيات
        const totalOrders = ordersData.length;
        const totalProducts = productsData.length;
        const totalCustomers = customersData.length;
        const totalCategories = categoriesData.length;
        
        const totalRevenue = ordersData.reduce((sum, order) => sum + (order.total || 0), 0);
        const pendingOrders = ordersData.filter(o => o.status === 'pending').length;
        
        // تحديث DOM إذا كان موجوداً
        if (document.getElementById('totalOrders')) {
            document.getElementById('totalOrders').textContent = totalOrders;
        }
        if (document.getElementById('totalProducts')) {
            document.getElementById('totalProducts').textContent = totalProducts;
        }
        if (document.getElementById('totalCustomers')) {
            document.getElementById('totalCustomers').textContent = totalCustomers;
        }
        if (document.getElementById('totalCategories')) {
            document.getElementById('totalCategories').textContent = totalCategories;
        }
        if (document.getElementById('totalRevenue')) {
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' ر.س';
        }
        if (document.getElementById('pendingOrders')) {
            document.getElementById('pendingOrders').textContent = pendingOrders;
        }
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

function updateRecentData() {
    try {
        // تحديث أحدث الطلبات
        const recentOrders = [...ordersData].sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)).slice(0, 5);
        
        if (document.getElementById('recentOrdersTable')) {
            if (recentOrders.length === 0) {
                document.getElementById('recentOrdersTable').innerHTML = '<p style="text-align: center; color: #666;">لا توجد طلبات حديثة</p>';
            } else {
                document.getElementById('recentOrdersTable').innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>المجموع</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentOrders.map(order => {
                                const customer = customersData.find(c => c.id === order.customerId);
                                const statusText = {
                                    'pending': 'قيد الانتظار',
                                    'processing': 'قيد المعالجة',
                                    'shipped': 'تم الشحن',
                                    'completed': 'مكتمل',
                                    'cancelled': 'ملغي'
                                };
                                
                                return `
                                    <tr>
                                        <td><strong>${order.orderNumber}</strong></td>
                                        <td>${customer ? customer.name : 'غير معروف'}</td>
                                        <td>${order.total ? order.total.toFixed(2) : '0.00'} ر.س</td>
                                        <td><span class="status-badge ${order.status}">${statusText[order.status] || order.status}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
        
        // تحديث المنتجات منخفضة المخزون
        const lowStockProducts = productsData.filter(p => p.status === 'low-stock').slice(0, 5);
        
        if (document.getElementById('lowStockProducts')) {
            if (lowStockProducts.length === 0) {
                document.getElementById('lowStockProducts').innerHTML = '<p style="text-align: center; color: #666;">لا توجد منتجات منخفضة المخزون</p>';
            } else {
                document.getElementById('lowStockProducts').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${lowStockProducts.map(product => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                <div>
                                    <strong>${product.name}</strong>
                                    <div style="font-size: 12px; color: #666;">المخزون: ${product.stockQuantity}</div>
                                </div>
                                <button class="action-btn stock" onclick="updateProductStock('${product.id}')" title="تحديث المخزون">
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error updating recent data:', error);
    }
}

// ============================================
// دوال تحديث القوائم المنسدلة
// ============================================

function updateCategorySelect() {
    const select = document.getElementById('productCategory');
    if (select) {
        select.innerHTML = '<option value="">اختر التصنيف</option>' + 
            categoriesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
}

function updateCustomerSelect() {
    const select = document.getElementById('orderCustomerId');
    if (select) {
        select.innerHTML = '<option value="">اختر العميل</option>' + 
            customersData.map(c => `<option value="${c.id}">${c.name} - ${c.email}</option>`).join('');
    }
}

function updateOrderProductsSelect() {
    const selects = document.querySelectorAll('.order-product-select');
    selects.forEach(select => {
        if (select && select.id !== 'orderCustomerId') {
            select.innerHTML = '<option value="">اختر المنتج</option>' + 
                productsData.map(p => `<option value="${p.id}" data-price="${p.salePrice}">${p.name} - ${p.salePrice} ر.س</option>`).join('');
        }
    });
}

// ============================================
// دوال الرسوم البيانية
// ============================================

function loadDashboardCharts() {
    try {
        // إنشاء مخطط المبيعات
        const salesCtx = document.getElementById('salesChart');
        if (salesCtx) {
            const monthlySales = calculateMonthlySales();
            
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: monthlySales.labels,
                    datasets: [{
                        label: 'المبيعات الشهرية',
                        data: monthlySales.values,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading charts:', error);
    }
}

function calculateMonthlySales() {
    const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                   'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    
    const sales = Array(12).fill(0);
    const currentYear = new Date().getFullYear();
    
    ordersData.forEach(order => {
        if (order.orderDate) {
            const date = new Date(order.orderDate);
            if (date.getFullYear() === currentYear) {
                const month = date.getMonth();
                sales[month] += order.total || 0;
            }
        }
    });
    
    return {
        labels: months,
        values: sales
    };
}

function loadSalesAnalyticsCharts() {
    try {
        // مخطط مبيعات التصنيفات
        const categoryCtx = document.getElementById('categorySalesChart');
        if (categoryCtx) {
            const categorySales = calculateCategorySales();
            
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categorySales.labels,
                    datasets: [{
                        data: categorySales.values,
                        backgroundColor: [
                            '#d131bc', '#631a5f', '#4cc9f0', '#87ad2f', '#f72585',
                            '#7209b7', '#38b000', '#ff9e00', '#560bad', '#0077b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        // مخطط المبيعات الشهرية
        const monthlyCtx = document.getElementById('monthlySalesChart');
        if (monthlyCtx) {
            const monthlySales = calculateMonthlySales();
            
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: monthlySales.labels,
                    datasets: [{
                        label: 'المبيعات',
                        data: monthlySales.values,
                        backgroundColor: 'rgba(67, 97, 238, 0.8)',
                        borderColor: '#4361ee',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading analytics charts:', error);
    }
}

function calculateCategorySales() {
    const categorySales = {};
    
    ordersData.forEach(order => {
        order.items?.forEach(item => {
            const product = productsData.find(p => p.id === item.productId);
            if (product) {
                const category = categoriesData.find(c => c.id === product.categoryId);
                const categoryName = category ? category.name : 'غير مصنف';
                
                if (!categorySales[categoryName]) {
                    categorySales[categoryName] = 0;
                }
                
                categorySales[categoryName] += item.quantity * item.price;
            }
        });
    });
    
    const labels = Object.keys(categorySales);
    const values = Object.values(categorySales);
    
    return { labels, values };
}

function renderTopProducts() {
    const productSales = {};
    
    ordersData.forEach(order => {
        order.items?.forEach(item => {
            const product = productsData.find(p => p.id === item.productId);
            if (product) {
                if (!productSales[product.id]) {
                    productSales[product.id] = {
                        name: product.name,
                        quantity: 0,
                        revenue: 0
                    };
                }
                
                productSales[product.id].quantity += item.quantity;
                productSales[product.id].revenue += item.quantity * item.price;
            }
        });
    });
    
    const sortedProducts = Object.values(productSales)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 5);
    
    if (sortedProducts.length === 0) {
        return '<p style="text-align: center; color: #666;">لا توجد بيانات مبيعات</p>';
    }
    
    return sortedProducts.map((product, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 8px; margin-bottom: 8px;">
            <div>
                <strong>${product.name}</strong>
                <div style="font-size: 12px; color: #666;">${product.quantity} وحدة</div>
            </div>
            <div>
                <span class="price-tag">${product.revenue.toFixed(2)} ر.س</span>
            </div>
        </div>
    `).join('');
}

// ============================================
// دوال البحث والتصدير
// ============================================

function filterProductsTable() {
    const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
    const tableBody = document.getElementById('productsTableBody');
    
    if (!tableBody) return;
    
    const filteredProducts = productsData.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.code.toLowerCase().includes(searchTerm)
    );
    
    tableBody.innerHTML = filteredProducts.length > 0 ? 
        filteredProducts.map(product => {
            const category = categoriesData.find(c => c.id === product.categoryId);
            const stockStatus = product.status || calculateStockStatus(product.stockQuantity, product.minStock);
            
            return `
                <tr>
                    <td><i class="fas fa-image" style="color: #ccc;"></i></td>
                    <td>${product.name}</td>
                    <td><span class="product-code">${product.code}</span></td>
                    <td>${category ? category.name : 'غير مصنف'}</td>
                    <td><span class="price-tag">${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س</span></td>
                    <td>${product.stockQuantity}</td>
                    <td>
                        <span class="stock-badge ${stockStatus}">
                            ${stockStatus === 'in-stock' ? 'متوفر' : stockStatus === 'low-stock' ? 'منخفض' : 'نفذ'}
                        </span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('') :
        '<tr><td colspan="8" style="text-align: center; padding: 30px;">لم يتم العثور على منتجات مطابقة</td></tr>';
}

function filterCustomersTable() {
    const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
    const tableBody = document.getElementById('customersTableBody');
    
    if (!tableBody) return;
    
    const filteredCustomers = customersData.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) || 
        customer.email.toLowerCase().includes(searchTerm)
    );
    
    tableBody.innerHTML = filteredCustomers.length > 0 ? 
        filteredCustomers.map(customer => {
            const orderCount = ordersData.filter(o => o.customerId === customer.id).length;
            const totalSpent = ordersData
                .filter(o => o.customerId === customer.id)
                .reduce((sum, order) => sum + (order.total || 0), 0);
            
            return `
                <tr>
                    <td>${customer.name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.city || 'غير محدد'}</td>
                    <td>${orderCount}</td>
                    <td><span class="price-tag">${totalSpent.toFixed(2)} ر.س</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="editCustomer('${customer.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteCustomer('${customer.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('') :
        '<tr><td colspan="7" style="text-align: center; padding: 30px;">لم يتم العثور على عملاء مطابقين</td></tr>';
}

function toggleExportMenu() {
    const menu = document.getElementById('exportMenu');
    if (menu) {
        menu.classList.toggle('show');
    }
}

function exportToExcel(type) {
    try {
        showExportLoading('جاري تحضير الملف...');
        
        let ws, fileName;
        
        switch(type) {
            case 'products':
                ws = XLSX.utils.json_to_sheet(productsData.map(p => ({
                    'اسم المنتج': p.name,
                    'الرمز': p.code,
                    'التصنيف': categoriesData.find(c => c.id === p.categoryId)?.name || '',
                    'سعر البيع': p.salePrice,
                    'المخزون': p.stockQuantity,
                    'الحالة': p.status === 'in-stock' ? 'متوفر' : p.status === 'low-stock' ? 'منخفض' : 'نفذ'
                })));
                fileName = 'المنتجات.xlsx';
                break;
                
            case 'customers':
                ws = XLSX.utils.json_to_sheet(customersData.map(c => ({
                    'الاسم': c.name,
                    'البريد الإلكتروني': c.email,
                    'الهاتف': c.phone,
                    'المدينة': c.city,
                    'عدد الطلبات': ordersData.filter(o => o.customerId === c.id).length
                })));
                fileName = 'العملاء.xlsx';
                break;
                
            case 'orders':
                ws = XLSX.utils.json_to_sheet(ordersData.map(o => {
                    const customer = customersData.find(c => c.id === o.customerId);
                    return {
                        'رقم الطلب': o.orderNumber,
                        'العميل': customer ? customer.name : '',
                        'التاريخ': o.orderDate,
                        'الحالة': o.status,
                        'المجموع': o.total
                    };
                }));
                fileName = 'الطلبات.xlsx';
                break;
                
            case 'analytics':
                const categorySales = calculateCategorySales();
                ws = XLSX.utils.json_to_sheet(
                    categorySales.labels.map((label, index) => ({
                        'التصنيف': label,
                        'المبيعات': categorySales.values[index]
                    }))
                );
                fileName = 'تحليل_المبيعات.xlsx';
                break;
        }
        
        if (ws) {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'البيانات');
            XLSX.writeFile(wb, fileName);
        }
        
        hideExportLoading();
        showSuccess('تم التصدير بنجاح');
    } catch (error) {
        hideExportLoading();
        showError('فشل التصدير: ' + error.message);
    }
}

// ============================================
// دوال إضافية
// ============================================

function loadLowStockAlerts() {
    const lowStockProducts = productsData.filter(p => p.status === 'low-stock');
    const alertsList = document.getElementById('alertsList');
    
    if (!alertsList) return;
    
    if (lowStockProducts.length === 0) {
        alertsList.innerHTML = '<p style="text-align: center; padding: 30px; color: #666;">لا توجد تنبيهات للمخزون المنخفض</p>';
        return;
    }
    
    alertsList.innerHTML = lowStockProducts.map(product => `
        <div class="alert-item">
            <div class="alert-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-content">
                <div class="alert-title">${product.name}</div>
                <div class="alert-message">
                    المخزون الحالي: ${product.stockQuantity} | الحد الأدنى: ${product.minStock}
                    <br>
                    الفرق: ${product.stockQuantity - product.minStock}
                </div>
            </div>
        </div>
    `).join('');
}

function viewProductDetails(id) {
    const product = productsData.find(p => p.id === id);
    if (!product) return;
    
    const category = categoriesData.find(c => c.id === product.categoryId);
    
    alert(`
تفاصيل المنتج:
──────────────
الاسم: ${product.name}
الرمز: ${product.code}
التصنيف: ${category ? category.name : 'غير مصنف'}
العلامة التجارية: ${product.brand || 'غير محدد'}
سعر الشراء: ${product.purchasePrice ? product.purchasePrice.toFixed(2) : '0.00'} ر.س
سعر البيع: ${product.salePrice ? product.salePrice.toFixed(2) : '0.00'} ر.س
المخزون: ${product.stockQuantity}
الحد الأدنى: ${product.minStock}
الحالة: ${product.status === 'in-stock' ? 'متوفر' : product.status === 'low-stock' ? 'منخفض' : 'نفذ'}
    `);
}

function viewCustomerDetails(id) {
    const customer = customersData.find(c => c.id === id);
    if (!customer) return;
    
    const customerOrders = ordersData.filter(o => o.customerId === id);
    
    alert(`
تفاصيل العميل:
─────────────
الاسم: ${customer.name}
البريد الإلكتروني: ${customer.email}
رقم الهاتف: ${customer.phone}
العنوان: ${customer.address || 'غير محدد'}
المدينة: ${customer.city || 'غير محدد'}
تاريخ الميلاد: ${customer.birthdate || 'غير محدد'}
عدد الطلبات: ${customerOrders.length}
إجمالي المشتريات: ${customerOrders.reduce((sum, order) => sum + (order.total || 0), 0).toFixed(2)} ر.س
الملاحظات: ${customer.notes || 'لا توجد ملاحظات'}
    `);
}

function viewOrderDetails(id) {
    const order = ordersData.find(o => o.id === id);
    if (!order) return;
    
    const customer = customersData.find(c => c.id === order.customerId);
    
    let itemsText = '';
    order.items?.forEach((item, index) => {
        const product = productsData.find(p => p.id === item.productId);
        itemsText += `${index + 1}. ${product ? product.name : 'منتج غير معروف'} (${item.quantity} × ${item.price} ر.س) = ${(item.quantity * item.price).toFixed(2)} ر.س\n`;
    });
    
    alert(`
تفاصيل الطلب:
────────────
رقم الطلب: ${order.orderNumber}
العميل: ${customer ? customer.name : 'غير معروف'}
تاريخ الطلب: ${order.orderDate}
حالة الطلب: ${order.status}
طريقة الدفع: ${order.paymentMethod}
طريقة الشحن: ${order.shippingMethod}
عنوان الشحن: ${order.shippingAddress}
الملاحظات: ${order.notes || 'لا توجد ملاحظات'}

منتجات الطلب:
────────────
${itemsText}

المجموع الفرعي: ${order.subtotal ? order.subtotal.toFixed(2) : '0.00'} ر.س
الضريبة: ${order.tax ? order.tax.toFixed(2) : '0.00'} ر.س
الشحن: ${order.shippingCost ? order.shippingCost.toFixed(2) : '0.00'} ر.س
الإجمالي: ${order.total ? order.total.toFixed(2) : '0.00'} ر.س
    `);
}

function addCoupon() {
    alert('هذه الميزة قيد التطوير. ستتوفر قريباً.');
}

function addShippingMethod() {
    alert('هذه الميزة قيد التطوير. ستتوفر قريباً.');
}

// ============================================
// إغلاق القائمة عند النقر خارجها
// ============================================

document.addEventListener('click', function(event) {
    // إغلاق قائمة التصدير عند النقر خارجها
    const exportMenu = document.getElementById('exportMenu');
    const exportBtn = document.querySelector('.export-options button');
    
    if (exportMenu && exportBtn && 
        !exportMenu.contains(event.target) && 
        !exportBtn.contains(event.target)) {
        exportMenu.classList.remove('show');
    }
    
    // إغلاق الشريط الجانبي على الجوال
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (sidebar && mobileToggle && 
        sidebar.classList.contains('active') &&
        !sidebar.contains(event.target) && 
        !mobileToggle.contains(event.target)) {
        sidebar.classList.remove('active');
    }
});
        
        // [هنا تبقى جميع دوال العرض الأخرى كما هي مع تعديل طفيف لاستخدام البيانات المحلية]

        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                document.addEventListener('click', function(event) {
                    if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target) && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            }
            
            // التحقق من حالة تسجيل الدخول
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('User is signed in:', user.email);
                } else {
                    currentUser = null;
                    console.log('User is signed out');
                }
            });
        });

    </script>
</body>
</html>
